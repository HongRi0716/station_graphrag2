# æ™ºèƒ½ä½“æ¨¡æ¿ç³»ç»Ÿä½¿ç”¨æŒ‡å—

> **ç›®çš„**: äº†è§£å¦‚ä½•ä¸ºæ™ºèƒ½ä½“é…ç½®å’Œä½¿ç”¨æ–‡ä»¶æ¨¡æ¿ï¼Œå®ç°æ ‡å‡†åŒ–çš„è¾“å‡ºæ ¼å¼

---

## ğŸ“š æ¨¡æ¿ç³»ç»Ÿæ¦‚è¿°

æ™ºèƒ½ä½“æ¨¡æ¿ç³»ç»Ÿå…è®¸æ‚¨ä¸ºæ¯ä¸ªæ™ºèƒ½ä½“é…ç½®ä¸“å±çš„æ–‡ä»¶æ¨¡æ¿ï¼Œç”¨äºç”Ÿæˆæ ‡å‡†åŒ–çš„è¾“å‡ºæ–‡æ¡£ï¼ˆå¦‚æŠ¥å‘Šã€æ–¹æ¡ˆã€ç¥¨æ®ç­‰ï¼‰ã€‚

### æ ¸å¿ƒç»„ä»¶

1. **AgentMetadata.file_templates** - æ™ºèƒ½ä½“å…ƒæ•°æ®ä¸­çš„æ¨¡æ¿é…ç½®
2. **BaseAgent.render_with_template()** - æ¨¡æ¿æ¸²æŸ“æ–¹æ³•
3. **template_service** - æ¨¡æ¿æœåŠ¡ï¼ˆJinja2å¼•æ“ï¼‰

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: äº‹æ•…é¢„æƒ³æŠ¥å‘Šæ¨¡æ¿

æ™ºèƒ½ä½“ç”Ÿæˆäº‹æ•…é¢„æƒ³æŠ¥å‘Šæ—¶ï¼Œä½¿ç”¨ç»Ÿä¸€çš„æ¨¡æ¿æ ¼å¼ï¼š

```markdown
## äº‹æ•…é¢„æƒ³æŠ¥å‘Š

**äº‹æ•…åœºæ™¯**: {{scenario}}
**è®¾å¤‡åç§°**: {{equipment}}
**ç¼–åˆ¶æ—¥æœŸ**: {{date}}

### ä¸€ã€å¯èƒ½åŸå› 
{% for cause in possible_causes %}
{{loop.index}}. {{cause.description}} (æ¦‚ç‡: {{cause.probability}})
{% endfor %}

### äºŒã€åº”æ€¥æªæ–½
{% for action in immediate_actions %}
{{loop.index}}. {{action.description}}
{% endfor %}
```

### åœºæ™¯2: æ“ä½œç¥¨æ¨¡æ¿

```markdown
## å€’é—¸æ“ä½œç¥¨

**ç¥¨å·**: {{ticket_no}}
**æ“ä½œä»»åŠ¡**: {{operation_task}}
**æ“ä½œæ—¶é—´**: {{operation_time}}

| åºå· | æ“ä½œé¡¹ç›® | æ‰§è¡Œäºº | ç›‘æŠ¤äºº |
|------|---------|--------|--------|
{% for step in operation_steps %}
| {{loop.index}} | {{step.operation}} | {{step.executor}} | {{step.supervisor}} |
{% endfor %}
```

---

## ğŸ”§ é…ç½®æ–¹æ³•

### æ­¥éª¤1: åˆ›å»ºæ¨¡æ¿æ–‡ä»¶

åœ¨é¡¹ç›®ä¸­åˆ›å»ºæ¨¡æ¿ç›®å½•å’Œæ–‡ä»¶ï¼š

```bash
mkdir -p aperag/templates/agents/accident_deduction
```

åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ `aperag/templates/agents/accident_deduction/report.md.j2`:

```jinja2
# {{title}}

**ç¼–åˆ¶å•ä½**: {{organization}}
**ç¼–åˆ¶æ—¥æœŸ**: {{date}}
**ç¼–åˆ¶äºº**: {{author}}

---

## ä¸€ã€äº‹æ•…åœºæ™¯

**è®¾å¤‡åç§°**: {{equipment}}
**äº‹æ•…ç±»å‹**: {{accident_type}}
**å‘ç”Ÿæ—¶é—´**: {{occurrence_time}}

## äºŒã€å¯èƒ½åŸå› åˆ†æ

{% for cause in possible_causes %}
### {{loop.index}}. {{cause.cause}}

- **å¯èƒ½æ€§**: {{cause.probability}}
- **åˆ†æ**: {{cause.description}}
{% if cause.evidence %}
- **ä¾æ®**: {{cause.evidence}}
{% endif %}

{% endfor %}

## ä¸‰ã€äº‹æ•…åæœ

{% for consequence in consequences %}
- **{{consequence.type}}**: {{consequence.description}} (ä¸¥é‡ç¨‹åº¦: {{consequence.severity}})
{% endfor %}

## å››ã€åº”æ€¥å¤„ç½®æªæ–½

{% for action in immediate_actions %}
### {{loop.index}}. {{action.action}}

- **ä¼˜å…ˆçº§**: {{action.priority}}
- **æ‰§è¡Œäºº**: {{action.responsible}}
- **é¢„è®¡æ—¶é—´**: {{action.estimated_time}}
{% endfor %}

## äº”ã€é¢„é˜²æªæ–½

{% for measure in preventive_measures %}
- {{measure}}
{% endfor %}

---

**å®¡æ ¸**: ________  **æ—¥æœŸ**: ________
**æ‰¹å‡†**: ________  **æ—¥æœŸ**: ________
```

### æ­¥éª¤2: åœ¨AgentMetadataä¸­é…ç½®æ¨¡æ¿

ç¼–è¾‘ `aperag/agent/agent_configs.py`:

```python
ACCIDENT_DEDUCTION_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.ACCIDENT_DEDUCTION,
    name="äº‹æ•…é¢„æƒ³ä¸“å®¶",
    description="ç”Ÿæˆäº‹æ•…é¢„æƒ³æŠ¥å‘Šã€åº”æ€¥é¢„æ¡ˆã€æ¼”ç»ƒæ–¹æ¡ˆ",
    
    # é…ç½®æ–‡ä»¶æ¨¡æ¿
    file_templates={
        "accident_report": "aperag/templates/agents/accident_deduction/report.md.j2",
        "emergency_plan": "aperag/templates/agents/accident_deduction/emergency_plan.md.j2",
        "drill_design": "aperag/templates/agents/accident_deduction/drill_design.md.j2",
    },
    
    # å…¶ä»–é…ç½®...
    default_collections=["accident_cases", "emergency_procedures"],
    system_prompt_template="ä½ æ˜¯äº‹æ•…é¢„æƒ³ä¸“å®¶...",
    capabilities={"rag", "simulation", "analysis"},
    priority=8,
)
```

### æ­¥éª¤3: åœ¨æ™ºèƒ½ä½“ä¸­ä½¿ç”¨æ¨¡æ¿

åœ¨æ™ºèƒ½ä½“çš„ `_execute` æ–¹æ³•ä¸­è°ƒç”¨æ¨¡æ¿æ¸²æŸ“ï¼š

```python
class AccidentDeductionAgent(BaseAgent):
    
    async def _execute(self, state: AgentState, input_data: Dict[str, Any]) -> Dict[str, Any]:
        query = input_data.get("task", "")
        
        # 1. åˆ†ææŸ¥è¯¢ï¼Œæå–ä¿¡æ¯
        equipment = self._extract_equipment(query)
        accident_type = self._extract_accident_type(query)
        
        # 2. æ£€ç´¢ç›¸å…³æ¡ˆä¾‹
        cases = await self._search_knowledge(state, query)
        
        # 3. LLMç”Ÿæˆæ¨æ¼”ç»“æœ
        deduction_result = await self._generate_deduction(state, query, cases)
        
        # 4. ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“æœ€ç»ˆæŠ¥å‘Š
        context = {
            "title": f"{equipment}{accident_type}äº‹æ•…é¢„æƒ³",
            "organization": "XXä¾›ç”µå…¬å¸",
            "date": datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥"),
            "author": "äº‹æ•…é¢„æƒ³ä¸“å®¶",
            "equipment": equipment,
            "accident_type": accident_type,
            "occurrence_time": "å‡å®šæ—¶é—´",
            "possible_causes": deduction_result.get("possible_causes", []),
            "consequences": deduction_result.get("consequences", []),
            "immediate_actions": deduction_result.get("immediate_actions", []),
            "preventive_measures": deduction_result.get("preventive_measures", []),
        }
        
        # ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“
        rendered_report = await self.render_with_template(
            state=state,
            template_name="accident_report",  # å¯¹åº”file_templatesä¸­çš„key
            context=context
        )
        
        return {
            "answer": rendered_report,
            "deduction": deduction_result
        }
```

---

## ğŸ¨ æ¨¡æ¿è¯­æ³•ï¼ˆJinja2ï¼‰

### å˜é‡è¾“å‡º

```jinja2
{{variable_name}}
```

### æ¡ä»¶åˆ¤æ–­

```jinja2
{% if condition %}
    å†…å®¹
{% elif another_condition %}
    å…¶ä»–å†…å®¹
{% else %}
    é»˜è®¤å†…å®¹
{% endif %}
```

### å¾ªç¯

```jinja2
{% for item in items %}
    {{loop.index}}. {{item.name}}
{% endfor %}
```

### è¿‡æ»¤å™¨

```jinja2
{{text|upper}}           # è½¬å¤§å†™
{{number|round(2)}}      # ä¿ç•™2ä½å°æ•°
{{date|date_format}}     # æ—¥æœŸæ ¼å¼åŒ–
```

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹ï¼šæ“ä½œç¥¨æ™ºèƒ½ä½“

### 1. åˆ›å»ºæ¨¡æ¿æ–‡ä»¶

`aperag/templates/agents/operation_ticket/ticket.md.j2`:

```jinja2
# å€’é—¸æ“ä½œç¥¨

**ç¥¨å·**: {{ticket_no}}
**æ“ä½œä»»åŠ¡**: {{operation_task}}
**æ“ä½œæ—¶é—´**: {{operation_time}}
**å¤©æ°”æƒ…å†µ**: {{weather}}

---

## æ“ä½œæ­¥éª¤

| åºå· | æ“ä½œé¡¹ç›® | æ‰§è¡Œäºº | ç›‘æŠ¤äºº | å¤‡æ³¨ |
|------|---------|--------|--------|------|
{% for step in operation_steps %}
| {{loop.index}} | {{step.operation}} | {{step.executor}} | {{step.supervisor}} | {{step.note|default('-')}} |
{% endfor %}

---

## å®‰å…¨æªæ–½

{% for measure in safety_measures %}
{{loop.index}}. {{measure.measure}} (è´£ä»»äºº: {{measure.responsible}})
{% endfor %}

---

## å®¡æ‰¹ç­¾å­—

| è§’è‰² | å§“å | ç­¾å­— | æ—¥æœŸ |
|------|------|------|------|
{% for approval in approvals %}
| {{approval.role}} | {{approval.name}} | ________ | ________ |
{% endfor %}

---

**æ³¨æ„äº‹é¡¹**:
{% for note in important_notes %}
- {{note}}
{% endfor %}
```

### 2. é…ç½®æ™ºèƒ½ä½“å…ƒæ•°æ®

```python
OPERATION_TICKET_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.OPERATION_TICKET,
    name="æ“ä½œç¥¨ä¸“å®¶",
    description="æ™ºèƒ½ç¼–åˆ¶å’Œå®¡æ ¸å€’é—¸æ“ä½œç¥¨",
    
    file_templates={
        "operation_ticket": "aperag/templates/agents/operation_ticket/ticket.md.j2",
        "review_report": "aperag/templates/agents/operation_ticket/review.md.j2",
    },
    
    default_collections=["operation_procedures", "safety_regulations"],
    system_prompt_template="ä½ æ˜¯æ“ä½œç¥¨ä¸“å®¶...",
    capabilities={"rag", "validation", "generation"},
    priority=9,
)
```

### 3. æ™ºèƒ½ä½“å®ç°

```python
class OperationTicketAgent(BaseAgent):
    
    async def _execute(self, state: AgentState, input_data: Dict[str, Any]) -> Dict[str, Any]:
        task = input_data.get("task", "")
        
        # 1. åˆ†ææ“ä½œä»»åŠ¡
        operation_info = await self._analyze_operation(state, task)
        
        # 2. ç”Ÿæˆæ“ä½œæ­¥éª¤
        steps = await self._generate_operation_steps(state, operation_info)
        
        # 3. ç”Ÿæˆå®‰å…¨æªæ–½
        safety_measures = await self._generate_safety_measures(state, operation_info)
        
        # 4. å‡†å¤‡æ¨¡æ¿ä¸Šä¸‹æ–‡
        context = {
            "ticket_no": f"CZ-{datetime.now().strftime('%Y%m%d')}-001",
            "operation_task": operation_info["task"],
            "operation_time": operation_info["time"],
            "weather": operation_info.get("weather", "æ™´"),
            "operation_steps": steps,
            "safety_measures": safety_measures,
            "approvals": [
                {"role": "æ“ä½œäºº", "name": ""},
                {"role": "ç›‘æŠ¤äºº", "name": ""},
                {"role": "å€¼ç­è´Ÿè´£äºº", "name": ""},
            ],
            "important_notes": [
                "æ“ä½œå‰å¿…é¡»æ ¸å¯¹è®¾å¤‡åç§°å’Œç¼–å·",
                "ä¸¥æ ¼æ‰§è¡Œå”±ç¥¨ã€å¤è¯µåˆ¶åº¦",
                "æ“ä½œè¿‡ç¨‹ä¸­ä¿æŒé€šè®¯ç•…é€š",
            ]
        }
        
        # 5. æ¸²æŸ“æ¨¡æ¿
        rendered_ticket = await self.render_with_template(
            state=state,
            template_name="operation_ticket",
            context=context
        )
        
        return {
            "answer": rendered_ticket,
            "ticket": {
                "ticket_no": context["ticket_no"],
                "operation_steps": steps,
                "safety_measures": safety_measures,
            }
        }
```

---

## ğŸ” BaseAgent.render_with_template() æ–¹æ³•

### æ–¹æ³•ç­¾å

```python
async def render_with_template(
    self,
    state: AgentState,
    template_name: Optional[str] = None,
    context: Optional[Dict[str, Any]] = None
) -> str:
    """
    ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“å†…å®¹
    
    Args:
        state: æ™ºèƒ½ä½“çŠ¶æ€
        template_name: æ¨¡æ¿åç§°ï¼ˆå¯¹åº”file_templatesä¸­çš„keyï¼‰
        context: æ¨¡æ¿ä¸Šä¸‹æ–‡æ•°æ®
        
    Returns:
        æ¸²æŸ“åçš„å†…å®¹
    """
```

### ä½¿ç”¨ç¤ºä¾‹

```python
# æ–¹å¼1: ä½¿ç”¨é…ç½®çš„æ¨¡æ¿
rendered = await self.render_with_template(
    state=state,
    template_name="accident_report",  # ä½¿ç”¨file_templatesä¸­é…ç½®çš„æ¨¡æ¿
    context={
        "title": "ä¸»å˜äº‹æ•…é¢„æƒ³",
        "equipment": "#1ä¸»å˜",
        # ... æ›´å¤šä¸Šä¸‹æ–‡æ•°æ®
    }
)

# æ–¹å¼2: ä½¿ç”¨æå–çš„æ¨¡æ¿ï¼ˆä»å‚è€ƒæ–‡æ¡£ä¸­æå–ï¼‰
# é¦–å…ˆå­¦ä¹ å‚è€ƒæ–‡æ¡£
await self.learn_from_reference(state, reference_doc_path)

# ç„¶åä½¿ç”¨æå–çš„æ¨¡æ¿
rendered = await self.render_with_template(
    state=state,
    template_name=None,  # ä½¿ç”¨æå–çš„æ¨¡æ¿
    context=context_data
)
```

---

## ğŸ“Š æ¨¡æ¿è¾“å‡ºç¤ºä¾‹

### è¾“å…¥ä¸Šä¸‹æ–‡

```python
context = {
    "title": "#1ä¸»å˜é‡ç“¦æ–¯ä¿æŠ¤åŠ¨ä½œäº‹æ•…é¢„æƒ³",
    "organization": "XXä¾›ç”µå…¬å¸",
    "date": "2025å¹´11æœˆ27æ—¥",
    "equipment": "#1ä¸»å˜å‹å™¨",
    "accident_type": "é‡ç“¦æ–¯ä¿æŠ¤åŠ¨ä½œ",
    "possible_causes": [
        {
            "cause": "å˜å‹å™¨å†…éƒ¨æ•…éšœ",
            "probability": "é«˜",
            "description": "ç»•ç»„çŸ­è·¯ã€é“èŠ¯æ•…éšœç­‰",
        },
        {
            "cause": "æ²¹ä½å¼‚å¸¸",
            "probability": "ä¸­",
            "description": "æ²¹ä½è¿‡ä½å¯¼è‡´è¯¯åŠ¨ä½œ",
        }
    ],
    "immediate_actions": [
        {
            "action": "ç«‹å³æ±‡æŠ¥å€¼ç­é•¿",
            "priority": "é«˜",
            "responsible": "å½“å€¼è¿ç»´äººå‘˜",
        }
    ]
}
```

### æ¸²æŸ“è¾“å‡º

```markdown
# #1ä¸»å˜é‡ç“¦æ–¯ä¿æŠ¤åŠ¨ä½œäº‹æ•…é¢„æƒ³

**ç¼–åˆ¶å•ä½**: XXä¾›ç”µå…¬å¸
**ç¼–åˆ¶æ—¥æœŸ**: 2025å¹´11æœˆ27æ—¥

---

## ä¸€ã€äº‹æ•…åœºæ™¯

**è®¾å¤‡åç§°**: #1ä¸»å˜å‹å™¨
**äº‹æ•…ç±»å‹**: é‡ç“¦æ–¯ä¿æŠ¤åŠ¨ä½œ

## äºŒã€å¯èƒ½åŸå› åˆ†æ

### 1. å˜å‹å™¨å†…éƒ¨æ•…éšœ

- **å¯èƒ½æ€§**: é«˜
- **åˆ†æ**: ç»•ç»„çŸ­è·¯ã€é“èŠ¯æ•…éšœç­‰

### 2. æ²¹ä½å¼‚å¸¸

- **å¯èƒ½æ€§**: ä¸­
- **åˆ†æ**: æ²¹ä½è¿‡ä½å¯¼è‡´è¯¯åŠ¨ä½œ

## å››ã€åº”æ€¥å¤„ç½®æªæ–½

### 1. ç«‹å³æ±‡æŠ¥å€¼ç­é•¿

- **ä¼˜å…ˆçº§**: é«˜
- **æ‰§è¡Œäºº**: å½“å€¼è¿ç»´äººå‘˜

---

**å®¡æ ¸**: ________  **æ—¥æœŸ**: ________
**æ‰¹å‡†**: ________  **æ—¥æœŸ**: ________
```

---

## âœ… æœ€ä½³å®è·µ

### 1. æ¨¡æ¿ç»„ç»‡

```
aperag/templates/
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ accident_deduction/
â”‚   â”‚   â”œâ”€â”€ report.md.j2
â”‚   â”‚   â”œâ”€â”€ emergency_plan.md.j2
â”‚   â”‚   â””â”€â”€ drill_design.md.j2
â”‚   â”œâ”€â”€ operation_ticket/
â”‚   â”‚   â”œâ”€â”€ ticket.md.j2
â”‚   â”‚   â””â”€â”€ review.md.j2
â”‚   â””â”€â”€ work_permit/
â”‚       â”œâ”€â”€ permit.md.j2
â”‚       â””â”€â”€ hazard_analysis.md.j2
â””â”€â”€ common/
    â”œâ”€â”€ header.md.j2
    â””â”€â”€ footer.md.j2
```

### 2. æ¨¡æ¿å¤ç”¨

ä½¿ç”¨Jinja2çš„includeåŠŸèƒ½ï¼š

```jinja2
{% include 'common/header.md.j2' %}

# ä¸»è¦å†…å®¹

{% include 'common/footer.md.j2' %}
```

### 3. é»˜è®¤å€¼å¤„ç†

```jinja2
{{variable|default('é»˜è®¤å€¼')}}
```

### 4. é”™è¯¯å¤„ç†

åœ¨æ™ºèƒ½ä½“ä¸­æ·»åŠ é”™è¯¯å¤„ç†ï¼š

```python
try:
    rendered = await self.render_with_template(state, template_name, context)
except Exception as e:
    logger.error(f"Template rendering failed: {e}")
    # å›é€€åˆ°ç®€å•æ ¼å¼
    rendered = self._format_simple_output(context)
```

---

## ğŸ¯ æ€»ç»“

### æ¨¡æ¿ç³»ç»Ÿçš„ä¼˜åŠ¿

1. **æ ‡å‡†åŒ–è¾“å‡º** - ç¡®ä¿æ‰€æœ‰æŠ¥å‘Šæ ¼å¼ä¸€è‡´
2. **æ˜“äºç»´æŠ¤** - ä¿®æ”¹æ¨¡æ¿å³å¯æ›´æ–°æ‰€æœ‰è¾“å‡º
3. **åˆ†ç¦»å…³æ³¨ç‚¹** - ä¸šåŠ¡é€»è¾‘ä¸å±•ç¤ºé€»è¾‘åˆ†ç¦»
4. **å¯å¤ç”¨** - æ¨¡æ¿å¯ä»¥åœ¨å¤šä¸ªæ™ºèƒ½ä½“é—´å…±äº«

### å¿«é€Ÿä¸Šæ‰‹æ­¥éª¤

1. åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ï¼ˆ.md.j2ï¼‰
2. åœ¨AgentMetadataä¸­é…ç½®file_templates
3. åœ¨æ™ºèƒ½ä½“ä¸­å‡†å¤‡contextæ•°æ®
4. è°ƒç”¨render_with_template()æ¸²æŸ“
5. è¿”å›æ¸²æŸ“ç»“æœ

**ç°åœ¨æ‚¨å¯ä»¥ä¸ºä»»ä½•æ™ºèƒ½ä½“é…ç½®å’Œä½¿ç”¨æ¨¡æ¿äº†ï¼** ğŸš€
