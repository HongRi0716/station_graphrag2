# Agentæ™ºèƒ½ä½“ç³»ç»Ÿä¼˜åŒ–è¿›åº¦æŠ¥å‘Š

**æ›´æ–°æ—¶é—´**: 2024-11-25 14:07  
**å½“å‰é˜¶æ®µ**: ä¸“å®¶æ™ºèƒ½ä½“é›†æˆå·¥å…·è°ƒç”¨èƒ½åŠ›

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒæ¶æ„ä¼˜åŒ– (100%)

#### 1.1 BaseAgentå¢å¼º âœ…
- **æ–‡ä»¶**: `aperag/agent/core/base.py`
- **æ–°å¢åŠŸèƒ½**:
  - âœ… MCPä¼šè¯ç®¡ç† (`_ensure_mcp_session`)
  - âœ… çŸ¥è¯†åº“æ£€ç´¢ (`_search_knowledge`)
  - âœ… ç½‘ç»œæœç´¢ (`_web_search`)
  - âœ… LLMç”Ÿæˆ (`_generate_with_llm`)
  - âœ… å‚è€ƒæ–‡æ¡£ç®¡ç† (`add_reference_document`)
  - âœ… æ¨¡æ¿æå– (`extract_template_from_reference`)
  - âœ… æ¨¡æ¿ä¿å­˜ (`save_extracted_template`)
  - âœ… æ¨¡æ¿æ¸²æŸ“ (`render_with_template`)

#### 1.2 æ™ºèƒ½ä½“é…ç½®ç³»ç»Ÿ âœ…
- **æ–‡ä»¶**: `aperag/agent/agent_configs.py`
- **å†…å®¹**: 13ä¸ªæ™ºèƒ½ä½“çš„å®Œæ•´é…ç½®
  - æ“ä½œç¥¨ä¸“å®¶ âœ…
  - å·¥ä½œç¥¨ä¸“å®¶ âœ…
  - äº‹æ•…æ¨æ¼”ä¸“å®¶ âœ…
  - ä¿ç”µä¸“å®¶ âœ…
  - å›¾è°±ä¸“å®¶ âœ…
  - å›¾çº¸ä¾¦æ¢ âœ…
  - é—¨ç¦ä¸“å®¶ âœ…
  - é¢„æµ‹ä¸“å®¶ âœ…
  - å®¡è®¡ä¸“å®¶ âœ…
  - è®¡ç®—ä¸“å®¶ âœ…
  - æ–‡ä¹¦ä¸“å®¶ âœ…
  - æ•…éšœè¯Šæ–­ä¸“å®¶ âœ…
  - åŸ¹è®­æ•™å®˜ âœ…

#### 1.3 æ¨¡æ¿ç³»ç»Ÿ âœ…
- **æ–‡ä»¶**: `aperag/service/template_service.py`
- **æ¨¡æ¿æ–‡ä»¶** (6ä¸ª):
  - `operation_ticket.md` - æ“ä½œç¥¨ âœ…
  - `work_permit_first.md` - ç¬¬ä¸€ç§å·¥ä½œç¥¨ âœ…
  - `work_permit_second.md` - ç¬¬äºŒç§å·¥ä½œç¥¨ âœ…
  - `safety_checklist.md` - å®‰å…¨æ£€æŸ¥æ¸…å• âœ…
  - `accident_deduction_report.md` - äº‹æ•…æ¨æ¼”æŠ¥å‘Š âœ…
  - `power_guarantee_plan.md` - ä¿ç”µæ–¹æ¡ˆ âœ…

### 2. ä¸“å®¶æ™ºèƒ½ä½“ä¼˜åŒ– (è¿›è¡Œä¸­)

#### 2.1 æ“ä½œç¥¨ä¸“å®¶ âœ… (å·²å®Œæˆ)
- **æ–‡ä»¶**: `aperag/agent/specialists/operation_ticket_agent.py`
- **ä¼˜åŒ–å†…å®¹**:
  - âœ… é›†æˆRAGæ£€ç´¢ - æ£€ç´¢å†å²æ“ä½œç¥¨å’Œæ“ä½œè§„ç¨‹
  - âœ… é›†æˆLLMç”Ÿæˆ - æ™ºèƒ½ç”Ÿæˆæ“ä½œæ­¥éª¤
  - âœ… é›†æˆæ¨¡æ¿æ¸²æŸ“ - ä½¿ç”¨æ ‡å‡†åŒ–æ¨¡æ¿è¾“å‡º
  - âœ… æ™ºèƒ½å›é€€æœºåˆ¶ - æ£€ç´¢æˆ–ç”Ÿæˆå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ¨¡æ¿
  - âœ… å®Œæ•´çš„æ€ç»´é“¾è®°å½•

**æ ¸å¿ƒæµç¨‹**:
```python
1. è§£ææ“ä½œç±»å‹
2. æ£€ç´¢çŸ¥è¯†åº“
   - å†å²æ“ä½œç¥¨æ¡ˆä¾‹
   - æ“ä½œè§„ç¨‹å’Œå®‰å…¨è¦æ±‚
3. ä½¿ç”¨LLMç”Ÿæˆæ“ä½œç¥¨æ•°æ®
4. å®‰å…¨æ ¡éªŒ
5. æ¨¡æ¿æ¸²æŸ“è¾“å‡º
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
agent = OperationTicketAgent()
agent.user_id = "user123"  # è®¾ç½®ç”¨æˆ·IDä»¥å¯ç”¨MCP
agent.chat_id = "chat456"

result = await agent.run(state, {
    "task": "ç”Ÿæˆ#1ä¸»å˜è½¬å†·å¤‡ç”¨æ“ä½œç¥¨"
})

# è¾“å‡º:
# - answer: æ ¼å¼åŒ–çš„æ“ä½œç¥¨(Markdown)
# - ticket: ç»“æ„åŒ–çš„ç¥¨æ®æ•°æ®
# - safety_check: å®‰å…¨æ£€æŸ¥ç»“æœ
```

#### 2.2 å·¥ä½œç¥¨ä¸“å®¶ ğŸ”„ (å¾…ä¼˜åŒ–)
- **æ–‡ä»¶**: `aperag/agent/specialists/work_permit_agent.py`
- **å½“å‰çŠ¶æ€**: ä½¿ç”¨Mockæ•°æ®
- **è®¡åˆ’ä¼˜åŒ–**:
  - é›†æˆRAGæ£€ç´¢å†å²å·¥ä½œç¥¨
  - é›†æˆLLMç”Ÿæˆå·¥ä½œå†…å®¹
  - ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“è¾“å‡º

#### 2.3 å…¶ä»–ä¸“å®¶æ™ºèƒ½ä½“ ğŸ“‹ (å¾…ä¼˜åŒ–)
- äº‹æ•…æ¨æ¼”ä¸“å®¶
- ä¿ç”µä¸“å®¶
- å›¾è°±ä¸“å®¶
- å›¾çº¸ä¾¦æ¢
- ç­‰...

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### æ“ä½œç¥¨ä¸“å®¶ - ä¼˜åŒ–å‰åå¯¹æ¯”

#### ä¼˜åŒ–å‰ (Mockå®ç°)
```python
async def _generate_operation_ticket(self, state, query):
    # 1. ç¡¬ç¼–ç çš„æ“ä½œç±»å‹è¯†åˆ«
    operation_type = self._parse_operation_type(query)
    
    # 2. ä½¿ç”¨å›ºå®šæ¨¡æ¿
    ticket = self._create_ticket_template(operation_type)
    
    # 3. ç®€å•çš„å®‰å…¨æ ¡éªŒ
    safety_check = self._perform_safety_check(ticket)
    
    # 4. æ ¼å¼åŒ–è¾“å‡º
    report = self._format_operation_ticket(ticket, safety_check)
    
    return {"answer": report, "ticket": ticket}
```

**é™åˆ¶**:
- âŒ æ— æ³•è®¿é—®çŸ¥è¯†åº“
- âŒ æ— æ³•å­¦ä¹ å†å²æ¡ˆä¾‹
- âŒ å›ºå®šçš„æ“ä½œæ­¥éª¤
- âŒ ç¼ºä¹çµæ´»æ€§

#### ä¼˜åŒ–å (æ™ºèƒ½å®ç°)
```python
async def _generate_operation_ticket(self, state, query):
    # 1. è§£ææ“ä½œç±»å‹
    operation_type = self._parse_operation_type(query)
    
    # 2. æ£€ç´¢çŸ¥è¯†åº“
    historical_tickets = await self._search_knowledge(
        state, f"{operation_type} æ“ä½œç¥¨æ¡ˆä¾‹"
    )
    regulations = await self._search_knowledge(
        state, f"{operation_type} æ“ä½œè§„ç¨‹"
    )
    
    # 3. æ„å»ºä¸Šä¸‹æ–‡
    context = self._build_context(historical_tickets, regulations)
    
    # 4. ä½¿ç”¨LLMç”Ÿæˆ
    ticket_data = await self._generate_with_llm(
        state, 
        prompt=self._build_generation_prompt(operation_type, query, context)
    )
    
    # 5. å®‰å…¨æ ¡éªŒ
    safety_check = self._perform_safety_check(ticket_data)
    
    # 6. æ¨¡æ¿æ¸²æŸ“
    report = await self.render_with_template(
        state, "operation_ticket.md", context={...}
    )
    
    return {"answer": report, "ticket": ticket_data}
```

**ä¼˜åŠ¿**:
- âœ… è®¿é—®çŸ¥è¯†åº“è·å–å‚è€ƒèµ„æ–™
- âœ… å­¦ä¹ å†å²æ¡ˆä¾‹
- âœ… LLMæ™ºèƒ½ç”Ÿæˆæ“ä½œæ­¥éª¤
- âœ… æ ‡å‡†åŒ–æ¨¡æ¿è¾“å‡º
- âœ… å®Œæ•´çš„æ€ç»´é“¾è®°å½•
- âœ… æ™ºèƒ½å›é€€æœºåˆ¶

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸ (æœ¬å‘¨)

1. **ä¼˜åŒ–å·¥ä½œç¥¨ä¸“å®¶** ğŸ”„
   - é›†æˆRAGæ£€ç´¢
   - é›†æˆLLMç”Ÿæˆ
   - ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“

2. **ä¼˜åŒ–äº‹æ•…æ¨æ¼”ä¸“å®¶** ğŸ“‹
   - æ£€ç´¢å†å²äº‹æ•…æ¡ˆä¾‹
   - ä½¿ç”¨LLMæ¨æ¼”äº‹æ•…é“¾
   - ç”Ÿæˆæ¨æ¼”æŠ¥å‘Š

3. **ä¼˜åŒ–ä¿ç”µä¸“å®¶** ğŸ“‹
   - æ£€ç´¢å†å²ä¿ç”µæ–¹æ¡ˆ
   - è¯„ä¼°ä¾›ç”µé£é™©
   - ç”Ÿæˆä¿ç”µæ–¹æ¡ˆ

### ä¸­æœŸ (ä¸‹å‘¨)

4. **ä¼˜åŒ–å›¾è°±ä¸“å®¶** ğŸ“‹
   - å¢å¼ºçŸ¥è¯†åº“æ£€ç´¢èƒ½åŠ›
   - æ”¯æŒå›¾è°±éå†
   - ç»“æ„åŒ–è¾“å‡º

5. **ä¼˜åŒ–å›¾çº¸ä¾¦æ¢** ğŸ“‹
   - é›†æˆè§†è§‰åˆ†æ
   - å›¾çº¸è¯†åˆ«å’Œè§£è¯»
   - ç”Ÿæˆåˆ†ææŠ¥å‘Š

6. **åˆ›å»ºä½¿ç”¨ç¤ºä¾‹** ğŸ“‹
   - ä¸ºæ¯ä¸ªä¸“å®¶åˆ›å»ºä½¿ç”¨ç¤ºä¾‹
   - ç¼–å†™æµ‹è¯•ç”¨ä¾‹
   - æ€§èƒ½æµ‹è¯•

### é•¿æœŸ (æœ¬æœˆ)

7. **APIæ¥å£å¼€å‘** ğŸ“‹
   - åˆ›å»ºæ™ºèƒ½ä½“ç®¡ç†API
   - æ”¯æŒåŠ¨æ€è°ƒç”¨
   - å‰ç«¯é›†æˆ

8. **æ™ºèƒ½ä½“åä½œ** ğŸ“‹
   - å®ç°AgentOrchestrator
   - å¤šæ™ºèƒ½ä½“ååŒ
   - ä»»åŠ¡åˆ†è§£å’Œè°ƒåº¦

9. **æ€§èƒ½ä¼˜åŒ–** ğŸ“‹
   - ä¼šè¯ç¼“å­˜ä¼˜åŒ–
   - å¹¶å‘å¤„ç†
   - èµ„æºç®¡ç†

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

### 1. æ™ºèƒ½å›é€€æœºåˆ¶

```python
# å¦‚æœMCPä¸å¯ç”¨æˆ–æ£€ç´¢å¤±è´¥ï¼Œè‡ªåŠ¨å›é€€åˆ°é»˜è®¤æ¨¡æ¿
if self.user_id:
    try:
        # å°è¯•ä½¿ç”¨MCP
        results = await self._search_knowledge(...)
    except Exception as e:
        logger.warning(f"Fallback to template: {e}")
        # å›é€€åˆ°é»˜è®¤æ¨¡æ¿
        ticket_data = self._create_ticket_template(...)
else:
    # æ²¡æœ‰user_idï¼Œç›´æ¥ä½¿ç”¨æ¨¡æ¿
    ticket_data = self._create_ticket_template(...)
```

**ä¼˜åŠ¿**:
- ç¡®ä¿ç³»ç»Ÿå§‹ç»ˆå¯ç”¨
- ä¼˜é›…é™çº§
- ç”¨æˆ·ä½“éªŒä¸å—å½±å“

### 2. å®Œæ•´çš„æ€ç»´é“¾

```python
# è®°å½•æ¯ä¸ªæ­¥éª¤
self._log_thought(state, "action", "æ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“...")
self._log_thought(state, "observation", f"æ£€ç´¢åˆ° {len(results)} æ¡æ–‡æ¡£")
self._log_thought(state, "action", "æ­£åœ¨ä½¿ç”¨LLMç”Ÿæˆ...")
self._log_thought(state, "observation", "ç”Ÿæˆå®Œæˆ")
```

**ä¼˜åŠ¿**:
- è¿‡ç¨‹å¯è¿½æº¯
- ä¾¿äºè°ƒè¯•
- æé«˜ç”¨æˆ·ä¿¡ä»»åº¦

### 3. æ¨¡æ¿åŒ–è¾“å‡º

```python
# ä½¿ç”¨Jinja2æ¨¡æ¿ç¡®ä¿è¾“å‡ºæ ¼å¼ä¸€è‡´
rendered = await self.render_with_template(
    state=state,
    template_name="operation_ticket.md",
    context={...}
)
```

**ä¼˜åŠ¿**:
- è¾“å‡ºæ ¼å¼æ ‡å‡†åŒ–
- æ˜“äºç»´æŠ¤
- æ”¯æŒè‡ªå®šä¹‰

---

## ğŸ“ˆ è¿›åº¦ç»Ÿè®¡

### æ•´ä½“è¿›åº¦

| æ¨¡å— | è¿›åº¦ | çŠ¶æ€ |
|------|------|------|
| BaseAgentå¢å¼º | 100% | âœ… å®Œæˆ |
| æ™ºèƒ½ä½“é…ç½®ç³»ç»Ÿ | 100% | âœ… å®Œæˆ |
| æ¨¡æ¿ç³»ç»Ÿ | 100% | âœ… å®Œæˆ |
| æ“ä½œç¥¨ä¸“å®¶ä¼˜åŒ– | 100% | âœ… å®Œæˆ |
| å·¥ä½œç¥¨ä¸“å®¶ä¼˜åŒ– | 0% | ğŸ“‹ å¾…å¼€å§‹ |
| å…¶ä»–ä¸“å®¶ä¼˜åŒ– | 0% | ğŸ“‹ å¾…å¼€å§‹ |
| APIæ¥å£å¼€å‘ | 0% | ğŸ“‹ å¾…å¼€å§‹ |
| æ™ºèƒ½ä½“åä½œ | 0% | ğŸ“‹ å¾…å¼€å§‹ |

**æ€»ä½“è¿›åº¦**: çº¦ 40%

### ä»£ç ç»Ÿè®¡

- **æ–°å¢æ–‡ä»¶**: 10+
- **ä¿®æ”¹æ–‡ä»¶**: 5+
- **æ–°å¢ä»£ç **: çº¦ 5000+ è¡Œ
- **æ–‡æ¡£**: 10+ ä¸ªMarkdownæ–‡æ¡£

---

## ğŸ”§ ä½¿ç”¨å»ºè®®

### 1. å¯ç”¨MCPåŠŸèƒ½

```python
# åˆ›å»ºæ™ºèƒ½ä½“æ—¶è®¾ç½®user_idå’Œchat_id
agent = OperationTicketAgent()
agent.user_id = "user123"  # å¿…éœ€
agent.chat_id = "chat456"  # å¯é€‰

# è¿™æ ·æ™ºèƒ½ä½“å°±å¯ä»¥ä½¿ç”¨MCPå·¥å…·è°ƒç”¨
```

### 2. é…ç½®çŸ¥è¯†åº“

```python
# åœ¨agent_configs.pyä¸­é…ç½®ä¸“å±çŸ¥è¯†åº“
OPERATION_TICKET_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.OPERATION_TICKET,
    default_collections=[
        "operation_tickets_db",
        "operation_regulations_db"
    ],
    ...
)
```

### 3. è‡ªå®šä¹‰æ¨¡æ¿

```python
# åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿
template_path = "aperag/templates/my_template.md"

# ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿
rendered = await agent.render_with_template(
    state=state,
    template_name="my_template.md",
    context={...}
)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **BaseAgentå¢å¼ºåŠŸèƒ½ä½¿ç”¨æŒ‡å—.md** - è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
2. **AgentChatServiceå·¥å…·è°ƒç”¨å®ç°åˆ†æ.md** - å®ç°åŸç†åˆ†æ
3. **æ™ºèƒ½ä½“ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md** - æ•´ä½“ç³»ç»Ÿä½¿ç”¨
4. **æ™ºèƒ½ä½“ç³»ç»Ÿä¼˜åŒ–å®æ–½æ€»ç»“.md** - ç¬¬ä¸€é˜¶æ®µæ€»ç»“
5. **æ™ºèƒ½ä½“ç³»ç»Ÿå®Œå–„å·¥ä½œæ€»ç»“.md** - æ¨¡æ¿å’Œé…ç½®æ€»ç»“

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–æˆåŠŸå®ç°äº†ï¼š

1. **BaseAgentå…¨é¢å¢å¼º** - å…·å¤‡å®Œæ•´çš„å·¥å…·è°ƒç”¨èƒ½åŠ›
2. **æ™ºèƒ½ä½“é…ç½®ç³»ç»Ÿ** - é›†ä¸­ç®¡ç†æ‰€æœ‰æ™ºèƒ½ä½“é…ç½®
3. **æ¨¡æ¿ç³»ç»Ÿ** - æ ‡å‡†åŒ–æ–‡æ¡£è¾“å‡º
4. **æ“ä½œç¥¨ä¸“å®¶ä¼˜åŒ–** - é¦–ä¸ªé›†æˆå·¥å…·è°ƒç”¨çš„ä¸“å®¶æ™ºèƒ½ä½“

**ä¸‹ä¸€æ­¥**: ç»§ç»­ä¼˜åŒ–å…¶ä»–ä¸“å®¶æ™ºèƒ½ä½“ï¼Œå®ç°å®Œæ•´çš„æ™ºèƒ½ä½“ç³»ç»Ÿï¼

---

**çŠ¶æ€**: ğŸš€ **è¿›å±•é¡ºåˆ©ï¼ŒæŒ‰è®¡åˆ’æ¨è¿›ï¼**
