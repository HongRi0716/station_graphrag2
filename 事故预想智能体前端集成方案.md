# äº‹æ•…é¢„æƒ³æ™ºèƒ½ä½“å‰ç«¯é›†æˆæ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†äº‹æ•…é¢„æƒ³æ™ºèƒ½ä½“é›†æˆåˆ°å‰ç«¯åº”ç”¨ä¸­ï¼ŒåŒ…æ‹¬APIè°ƒç”¨ã€WebSocketé€šä¿¡å’ŒUIç»„ä»¶è®¾è®¡ã€‚

---

## ğŸ”Œ APIé›†æˆ

### 1. REST APIè°ƒç”¨

#### 1.1 ç”Ÿæˆäº‹æ•…æ¨æ¼”æŠ¥å‘Š

```typescript
// api/accident-deduction.ts

export interface AccidentDeductionRequest {
  task: string;
  equipment?: string;
  scenario?: string;
  user_id: string;
  chat_id?: string;
  model_provider?: string;
  model_name?: string;
  enable_rag?: boolean;
  enable_llm?: boolean;
}

export interface AccidentDeductionResponse {
  success: boolean;
  message: string;
  data?: any;
  report?: string;
  thinking_stream?: ThinkingStep[];
}

export interface ThinkingStep {
  step_type: string;
  description: string;
  detail?: any;
  timestamp?: string;
}

// ç”Ÿæˆäº‹æ•…æ¨æ¼”
export async function generateAccidentDeduction(
  request: AccidentDeductionRequest
): Promise<AccidentDeductionResponse> {
  const response = await fetch('/api/v1/agents/accident-deduction/deduction', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(request),
  });
  
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  return await response.json();
}

// ç”Ÿæˆåº”æ€¥é¢„æ¡ˆ
export async function generateEmergencyPlan(
  task: string,
  userId: string
): Promise<AccidentDeductionResponse> {
  const response = await fetch('/api/v1/agents/accident-deduction/emergency-plan', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      task,
      user_id: userId,
    }),
  });
  
  return await response.json();
}

// è®¾è®¡åº”æ€¥æ¼”ç»ƒ
export async function designDrill(
  task: string,
  userId: string
): Promise<AccidentDeductionResponse> {
  const response = await fetch('/api/v1/agents/accident-deduction/drill-design', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      task,
      user_id: userId,
    }),
  });
  
  return await response.json();
}

// è·å–æ¨¡æ¿åˆ—è¡¨
export async function getTemplates(): Promise<any> {
  const response = await fetch('/api/v1/agents/accident-deduction/templates');
  return await response.json();
}
```

### 1.2 ä½¿ç”¨ç¤ºä¾‹

```typescript
// åœ¨Reactç»„ä»¶ä¸­ä½¿ç”¨
import { useState } from 'react';
import { generateAccidentDeduction } from '@/api/accident-deduction';

function AccidentDeductionPage() {
  const [task, setTask] = useState('');
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  
  const handleSubmit = async () => {
    setLoading(true);
    try {
      const response = await generateAccidentDeduction({
        task,
        user_id: 'current-user-id',
        enable_rag: true,
        enable_llm: true,
      });
      
      setResult(response);
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div>
      <input
        value={task}
        onChange={(e) => setTask(e.target.value)}
        placeholder="è¾“å…¥äº‹æ•…åœºæ™¯ï¼Œå¦‚ï¼š#1ä¸»å˜é‡ç“¦æ–¯ä¿æŠ¤åŠ¨ä½œ"
      />
      <button onClick={handleSubmit} disabled={loading}>
        {loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆäº‹æ•…æ¨æ¼”'}
      </button>
      
      {result && (
        <div>
          <h3>æ¨æ¼”æŠ¥å‘Š</h3>
          <div dangerouslySetInnerHTML={{ __html: result.report }} />
        </div>
      )}
    </div>
  );
}
```

---

## ğŸ”„ WebSocketé›†æˆ

### 2.1 WebSocketè¿æ¥

```typescript
// hooks/useAccidentDeductionWebSocket.ts

import { useEffect, useState, useCallback } from 'react';

export interface WebSocketMessage {
  type: 'start' | 'thinking' | 'result' | 'complete' | 'error';
  message?: string;
  step_type?: string;
  description?: string;
  detail?: any;
  data?: any;
  report?: string;
}

export function useAccidentDeductionWebSocket(userId: string) {
  const [ws, setWs] = useState<WebSocket | null>(null);
  const [messages, setMessages] = useState<WebSocketMessage[]>([]);
  const [isConnected, setIsConnected] = useState(false);
  
  useEffect(() => {
    const websocket = new WebSocket(
      `ws://localhost:8000/api/v1/agents/accident-deduction/ws/deduction`
    );
    
    websocket.onopen = () => {
      console.log('WebSocket connected');
      setIsConnected(true);
    };
    
    websocket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      setMessages((prev) => [...prev, message]);
    };
    
    websocket.onerror = (error) => {
      console.error('WebSocket error:', error);
    };
    
    websocket.onclose = () => {
      console.log('WebSocket disconnected');
      setIsConnected(false);
    };
    
    setWs(websocket);
    
    return () => {
      websocket.close();
    };
  }, []);
  
  const sendTask = useCallback((task: string) => {
    if (ws && isConnected) {
      ws.send(JSON.stringify({
        task,
        user_id: userId,
      }));
    }
  }, [ws, isConnected, userId]);
  
  return {
    sendTask,
    messages,
    isConnected,
  };
}
```

### 2.2 ä½¿ç”¨WebSocket

```typescript
// components/AccidentDeductionStream.tsx

import { useState } from 'react';
import { useAccidentDeductionWebSocket } from '@/hooks/useAccidentDeductionWebSocket';

export function AccidentDeductionStream({ userId }: { userId: string }) {
  const [task, setTask] = useState('');
  const { sendTask, messages, isConnected } = useAccidentDeductionWebSocket(userId);
  
  const handleSubmit = () => {
    if (task) {
      sendTask(task);
      setTask('');
    }
  };
  
  return (
    <div className="accident-deduction-stream">
      <div className="input-section">
        <input
          value={task}
          onChange={(e) => setTask(e.target.value)}
          placeholder="è¾“å…¥äº‹æ•…åœºæ™¯"
          disabled={!isConnected}
        />
        <button onClick={handleSubmit} disabled={!isConnected}>
          å¼€å§‹æ¨æ¼”
        </button>
        <span className={`status ${isConnected ? 'connected' : 'disconnected'}`}>
          {isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}
        </span>
      </div>
      
      <div className="messages-section">
        {messages.map((msg, index) => (
          <div key={index} className={`message message-${msg.type}`}>
            {msg.type === 'thinking' && (
              <div className="thinking-step">
                <span className="step-type">{msg.step_type}</span>
                <span className="description">{msg.description}</span>
              </div>
            )}
            {msg.type === 'result' && (
              <div className="result">
                <h3>æ¨æ¼”ç»“æœ</h3>
                <div dangerouslySetInnerHTML={{ __html: msg.report || '' }} />
              </div>
            )}
            {msg.type === 'error' && (
              <div className="error">é”™è¯¯: {msg.message}</div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## ğŸ¨ UIç»„ä»¶è®¾è®¡

### 3.1 äº‹æ•…æ¨æ¼”é¡µé¢

```typescript
// pages/AccidentDeductionPage.tsx

import { useState } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { generateAccidentDeduction, getTemplates } from '@/api/accident-deduction';

export function AccidentDeductionPage() {
  const [activeTab, setActiveTab] = useState('deduction');
  const [task, setTask] = useState('');
  const [selectedTemplate, setSelectedTemplate] = useState('');
  const [templates, setTemplates] = useState([]);
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  // åŠ è½½æ¨¡æ¿
  useEffect(() => {
    getTemplates().then(data => {
      if (data.success) {
        setTemplates(data.templates);
      }
    });
  }, []);
  
  // ä½¿ç”¨æ¨¡æ¿
  const handleUseTemplate = (templateId: string) => {
    const template = templates.find(t => t.id === templateId);
    if (template) {
      setTask(template.description);
    }
  };
  
  // ç”Ÿæˆæ¨æ¼”
  const handleGenerate = async () => {
    setLoading(true);
    try {
      const response = await generateAccidentDeduction({
        task,
        user_id: 'current-user-id',
        enable_rag: true,
        enable_llm: true,
      });
      setResult(response);
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">äº‹æ•…é¢„æƒ³æ™ºèƒ½ä½“</h1>
      
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="deduction">äº‹æ•…æ¨æ¼”</TabsTrigger>
          <TabsTrigger value="plan">åº”æ€¥é¢„æ¡ˆ</TabsTrigger>
          <TabsTrigger value="drill">æ¼”ç»ƒè®¾è®¡</TabsTrigger>
        </TabsList>
        
        <TabsContent value="deduction">
          <Card>
            <CardHeader>
              <CardTitle>äº‹æ•…æ¨æ¼”åˆ†æ</CardTitle>
              <CardDescription>
                åŸºäºå†å²æ¡ˆä¾‹å’Œä¸“ä¸šçŸ¥è¯†ï¼Œæ™ºèƒ½ç”Ÿæˆäº‹æ•…æ¨æ¼”æŠ¥å‘Š
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* æ¨¡æ¿é€‰æ‹© */}
              <div className="space-y-2">
                <label>é€‰æ‹©æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰</label>
                <Select value={selectedTemplate} onValueChange={handleUseTemplate}>
                  <SelectTrigger>
                    <SelectValue placeholder="é€‰æ‹©äº‹æ•…åœºæ™¯æ¨¡æ¿" />
                  </SelectTrigger>
                  <SelectContent>
                    {templates.map(template => (
                      <SelectItem key={template.id} value={template.id}>
                        {template.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              
              {/* ä»»åŠ¡è¾“å…¥ */}
              <div className="space-y-2">
                <label>äº‹æ•…åœºæ™¯æè¿°</label>
                <Input
                  value={task}
                  onChange={(e) => setTask(e.target.value)}
                  placeholder="ä¾‹å¦‚ï¼š#1ä¸»å˜é‡ç“¦æ–¯ä¿æŠ¤åŠ¨ä½œ"
                />
              </div>
              
              {/* ç”ŸæˆæŒ‰é’® */}
              <Button onClick={handleGenerate} disabled={loading || !task}>
                {loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆäº‹æ•…æ¨æ¼”'}
              </Button>
              
              {/* ç»“æœå±•ç¤º */}
              {result && (
                <div className="mt-6">
                  <h3 className="text-xl font-semibold mb-4">æ¨æ¼”æŠ¥å‘Š</h3>
                  
                  {/* æ€ç»´é“¾å±•ç¤º */}
                  {result.thinking_stream && (
                    <Card className="mb-4">
                      <CardHeader>
                        <CardTitle>æ¨ç†è¿‡ç¨‹</CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-2">
                          {result.thinking_stream.map((step, index) => (
                            <div key={index} className="flex items-start space-x-2">
                              <span className="badge">{step.step_type}</span>
                              <span>{step.description}</span>
                            </div>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                  
                  {/* æŠ¥å‘Šå†…å®¹ */}
                  <Card>
                    <CardContent className="prose max-w-none">
                      <div dangerouslySetInnerHTML={{ __html: result.report }} />
                    </CardContent>
                  </Card>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
        
        {/* å…¶ä»–Tabå†…å®¹ç±»ä¼¼ */}
      </Tabs>
    </div>
  );
}
```

### 3.2 æ ·å¼è®¾è®¡

```css
/* styles/accident-deduction.css */

.accident-deduction-stream {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.input-section {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  border-bottom: 1px solid #e5e7eb;
}

.input-section input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
}

.input-section button {
  padding: 0.5rem 1rem;
  background-color: #3b82f6;
  color: white;
  border-radius: 0.375rem;
  cursor: pointer;
}

.input-section button:disabled {
  background-color: #9ca3af;
  cursor: not-allowed;
}

.status {
  display: flex;
  align-items: center;
  padding: 0.5rem;
  border-radius: 0.375rem;
}

.status.connected {
  background-color: #d1fae5;
  color: #065f46;
}

.status.disconnected {
  background-color: #fee2e2;
  color: #991b1b;
}

.messages-section {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}

.message {
  margin-bottom: 1rem;
  padding: 1rem;
  border-radius: 0.5rem;
}

.message-thinking {
  background-color: #f3f4f6;
}

.message-result {
  background-color: #dbeafe;
}

.message-error {
  background-color: #fee2e2;
  color: #991b1b;
}

.thinking-step {
  display: flex;
  gap: 0.5rem;
}

.step-type {
  font-weight: 600;
  color: #3b82f6;
}

.result h3 {
  margin-bottom: 1rem;
  font-size: 1.25rem;
  font-weight: 600;
}
```

---

## ğŸ”— æ™ºèƒ½ä½“åä½œé›†æˆ

### 4.1 åä½œAPI

```typescript
// api/agent-collaboration.ts

export interface CollaborationRequest {
  task: string;
  task_type: 'accident_analysis' | 'emergency_response' | 'safety_check' | 'operation_planning';
  user_id: string;
  chat_id?: string;
  mode?: 'sequential' | 'parallel' | 'hierarchical';
}

export async function executeCollaboration(
  request: CollaborationRequest
): Promise<any> {
  const response = await fetch('/api/v1/agents/collaboration/execute', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(request),
  });
  
  return await response.json();
}
```

### 4.2 åä½œUIç»„ä»¶

```typescript
// components/AgentCollaboration.tsx

import { useState } from 'react';
import { executeCollaboration } from '@/api/agent-collaboration';

export function AgentCollaboration() {
  const [task, setTask] = useState('');
  const [taskType, setTaskType] = useState('accident_analysis');
  const [mode, setMode] = useState('sequential');
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const handleExecute = async () => {
    setLoading(true);
    try {
      const response = await executeCollaboration({
        task,
        task_type: taskType,
        user_id: 'current-user-id',
        mode,
      });
      setResult(response);
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="agent-collaboration">
      <h2>æ™ºèƒ½ä½“åä½œ</h2>
      
      <div className="form-group">
        <label>ä»»åŠ¡æè¿°</label>
        <input
          value={task}
          onChange={(e) => setTask(e.target.value)}
          placeholder="è¾“å…¥å¤æ‚ä»»åŠ¡"
        />
      </div>
      
      <div className="form-group">
        <label>ä»»åŠ¡ç±»å‹</label>
        <select value={taskType} onChange={(e) => setTaskType(e.target.value)}>
          <option value="accident_analysis">äº‹æ•…åˆ†æ</option>
          <option value="emergency_response">åº”æ€¥å“åº”</option>
          <option value="safety_check">å®‰å…¨æ£€æŸ¥</option>
          <option value="operation_planning">æ“ä½œè§„åˆ’</option>
        </select>
      </div>
      
      <div className="form-group">
        <label>åä½œæ¨¡å¼</label>
        <select value={mode} onChange={(e) => setMode(e.target.value)}>
          <option value="sequential">é¡ºåºæ‰§è¡Œ</option>
          <option value="parallel">å¹¶è¡Œæ‰§è¡Œ</option>
          <option value="hierarchical">å±‚æ¬¡æ‰§è¡Œ</option>
        </select>
      </div>
      
      <button onClick={handleExecute} disabled={loading}>
        {loading ? 'æ‰§è¡Œä¸­...' : 'å¼€å§‹åä½œ'}
      </button>
      
      {result && (
        <div className="result">
          <h3>åä½œç»“æœ</h3>
          <div className="summary">
            <p>æ€»ä»»åŠ¡æ•°: {result.summary.total_subtasks}</p>
            <p>æˆåŠŸ: {result.summary.successful}</p>
            <p>å¤±è´¥: {result.summary.failed}</p>
          </div>
          
          <div className="subtasks">
            {result.subtask_results.map((subtask, index) => (
              <div key={index} className="subtask">
                <h4>{subtask.subtask_name}</h4>
                <p>æ‰§è¡Œæ™ºèƒ½ä½“: {subtask.agent}</p>
                {subtask.error ? (
                  <p className="error">{subtask.error}</p>
                ) : (
                  <div dangerouslySetInnerHTML={{ __html: subtask.result.answer }} />
                )}
              </div>
            ))}
          </div>
          
          <div className="integrated-report">
            <h3>æ•´åˆæŠ¥å‘Š</h3>
            <div dangerouslySetInnerHTML={{ __html: result.integrated_report }} />
          </div>
        </div>
      )}
    </div>
  );
}
```

---

## ğŸ“± ç§»åŠ¨ç«¯é€‚é…

### 5.1 å“åº”å¼è®¾è®¡

```css
/* ç§»åŠ¨ç«¯æ ·å¼ */
@media (max-width: 768px) {
  .accident-deduction-stream {
    height: 100vh;
  }
  
  .input-section {
    flex-direction: column;
  }
  
  .input-section input,
  .input-section button {
    width: 100%;
  }
  
  .messages-section {
    font-size: 0.875rem;
  }
}
```

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### 6.1 ç¯å¢ƒå˜é‡

```env
# .env.local
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_WS_URL=ws://localhost:8000
```

### 6.2 APIä»£ç†é…ç½®

```javascript
// next.config.js
module.exports = {
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: 'http://localhost:8000/api/:path*',
      },
    ];
  },
};
```

---

## âœ¨ æ€»ç»“

æœ¬æ–¹æ¡ˆæä¾›äº†å®Œæ•´çš„å‰ç«¯é›†æˆæŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… REST APIè°ƒç”¨
2. âœ… WebSocketå®æ—¶é€šä¿¡
3. âœ… UIç»„ä»¶è®¾è®¡
4. âœ… æ™ºèƒ½ä½“åä½œç•Œé¢
5. âœ… ç§»åŠ¨ç«¯é€‚é…
6. âœ… éƒ¨ç½²é…ç½®

**ä¸‹ä¸€æ­¥**: æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´UIè®¾è®¡å’Œäº¤äº’æµç¨‹ï¼
