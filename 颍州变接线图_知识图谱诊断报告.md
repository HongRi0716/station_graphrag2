# 颍州变接线图.pdf 知识图谱未生成问题诊断报告

## 问题概述

文档"颍州变接线图.pdf"（文档 ID: `doc7cd4efa65cdfbaf7`）的 GRAPH 索引已创建，但知识图谱为空（0 个实体，0 个关系）。

## 诊断结果

### 1. 索引状态

从 Celery worker 日志可以看到：

```
'status': 'success',
'index_type': 'GRAPH',
'document_id': 'doc7cd4efa65cdfbaf7',
'data': {
    'status': 'success',
    'doc_id': 'doc7cd4efa65cdfbaf7',
    'chunks_created': 0,      # ⚠️ 0个文本块
    'entities_extracted': 0,   # ⚠️ 0个实体
    'relations_extracted': 0   # ⚠️ 0个关系
}
```

### 2. 根本原因

**问题 1：Vision 分析集成失败（已修复）**

日志显示：

```
WARNING: Failed to enrich content with vision analysis for document doc7cd4efa65cdfbaf7:
cannot import name 'get_sync_session' from 'aperag.db.ops'
```

**原因**：代码中错误地从`aperag.db.ops`导入`get_sync_session`，但该函数实际在`aperag.config`中。

**修复**：已修复`aperag/graph/lightrag_manager.py`第 285 行的导入错误：

```python
# 修复前
from aperag.db.ops import get_sync_session

# 修复后
from aperag.config import get_sync_session
```

**问题 2：文档内容可能为空（✅ 可以解决）**

根据类似文档（B5391S-T0102-土建总平面布置图.pdf）的分析，可能原因：

- PDF 是纯图片型（扫描版），没有文本层
- DocRay OCR 未执行或失败
- 文档解析后`content`字段为空

**✅ 这个问题可以解决！**

即使 PDF 没有文本层，系统仍然可以通过以下方式生成知识图谱：

1. **Vision 索引器会自动分析 PDF 页面**：

   - DocumentParser 会将 PDF 每页转换为 PNG 图片
   - Vision 索引器会调用 Vision LLM 分析这些图片
   - 针对变电站接线图，有专门的提示词来提取：
     - 电压等级和母线系统（如"500kV I 母"、"220kV IA 母"）
     - 主变压器（如"1 号主变"、"2 号主变"）
     - 输电线路和出线（如"汤州 5354 线"、"颍稻 4736 线"）
     - 电气设备（开关、刀闸、CT、低抗、站用变等）
     - 连接关系和拓扑结构
     - 设备编号和标识

2. **修复后的代码会正确合并 Vision 分析**：

   - 修复导入错误后，代码能正确获取 Vision 分析结果
   - Vision 分析文本会被合并到知识图谱构建的 content 中
   - LightRAG 会从合并后的 content 中提取实体和关系

3. **需要确认 Vision 索引状态**：
   - 检查 Vision 索引是否成功创建
   - 确认 Vision 分析是否有内容
   - 验证修复后的代码能否正确获取 Vision chunks

### 3. 影响

由于 Vision 分析集成失败，即使 Vision 索引成功创建了图片分析结果，也无法合并到知识图谱构建的内容中，导致：

- 无法从 Vision 分析文本中提取实体和关系
- 如果原始 PDF 没有文本内容，知识图谱将完全为空

## 解决方案

### 步骤 1：应用代码修复（已完成）

✅ 已修复导入错误，代码已更新。

### 步骤 2：重启 Celery Worker 以应用修复

```bash
# 重启celery worker容器
docker restart aperag-celeryworker
```

### 步骤 3：重建 GRAPH 索引

修复后需要重建索引才能生效。可以通过以下方式：

**方法 A：通过 Web 界面**

1. 进入文档详情页
2. 找到 GRAPH 索引
3. 点击"重建索引"

**方法 B：通过 API**

```bash
curl -X POST "http://localhost:8000/api/v1/collections/{collection_id}/documents/doc7cd4efa65cdfbaf7/rebuild-indexes" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "index_types": ["GRAPH"]
  }'
```

### 步骤 4：验证修复效果

重建索引后，检查日志应该看到：

```
INFO: Enriched content for document doc7cd4efa65cdfbaf7 with X vision analysis sections
```

并且 GRAPH 索引结果应该包含：

- `chunks_created > 0`
- `entities_extracted > 0`
- `relations_extracted > 0`

### 步骤 5：如果仍然为空，检查文档内容

如果重建后仍然没有实体和关系，可能是文档本身没有可提取的内容：

1. **检查文档解析结果**：

```bash
# 查看文档详情
curl -X GET "http://localhost:8000/api/v1/collections/{collection_id}/documents/doc7cd4efa65cdfbaf7" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

2. **检查 Vision 索引是否有内容**：

```bash
# 查看Vision索引状态
docker logs aperag-celeryworker --tail 500 | grep -i "vision\|doc7cd4efa65cdfbaf7"
```

3. **检查 DocRay OCR 日志**：

```bash
docker logs aperag-docray --tail 200 | grep -i "ocr\|text\|extract"
```

## 预期结果

修复并重建索引后，应该看到：

1. ✅ 不再有导入错误警告
2. ✅ Vision 分析文本成功合并到知识图谱构建内容中
   - 日志中应该看到：`Enriched content for document doc7cd4efa65cdfbaf7 with X vision analysis sections`
3. ✅ 从 Vision 分析中提取到实体和关系
   - 对于变电站接线图，应该提取到：
     - 电压等级实体（如"500kV"、"220kV"）
     - 母线实体（如"500kV I 母"、"220kV IA 母"）
     - 主变压器实体（如"1 号主变"、"2 号主变"）
     - 线路实体（如"汤州 5354 线"、"颍稻 4736 线"）
     - 设备实体（开关、刀闸等）
     - 连接关系（如"线路 A 连接到母线 B"）
4. ✅ GRAPH 索引数据包含：
   - `chunks_created > 0`
   - `entities_extracted > 0`（应该有很多实体，特别是设备编号、线路名称等）
   - `relations_extracted > 0`（应该有很多关系，特别是连接关系）

## 为什么这个问题可以解决？

**即使 PDF 是纯图片型（没有文本层），系统仍然可以生成知识图谱：**

1. **Vision LLM 分析**：

   - 系统会将 PDF 每页转换为 PNG 图片
   - Vision LLM 会分析这些图片，生成详细的文本描述
   - 针对变电站接线图，有专门的提示词来提取结构化信息（位置：`aperag/index/vision_index.py` 第 151-230 行）

2. **Vision 分析文本合并**：

   - 修复后的代码会正确获取 Vision 分析结果
   - Vision 分析文本会被合并到知识图谱构建的 content 中
   - LightRAG 会从合并后的 content 中提取实体和关系

3. **专门优化的提示词**：
   - Vision 索引器使用专门针对电气图纸优化的提示词
   - 能够识别和提取变电站接线图中的各种实体和关系
   - 包括电压等级、母线、主变压器、线路、设备、连接关系等

## 相关文件

- 修复文件：`aperag/graph/lightrag_manager.py` (第 285 行)
- 参考文档：`B5391S_GRAPH_ANALYSIS.md`
- 诊断指南：`KNOWLEDGE_GRAPH_DIAGNOSIS.md`

## 新发现的问题（已修复）

从最新日志分析，发现另一个关键问题：

**Vision 索引可能只使用了 multimodal_embedding，没有生成文本描述**

从日志可以看到：

- Vision 索引创建成功
- 但没有看到"vision-to-text vectors"的日志
- 没有看到 Vision LLM 调用的日志

**原因分析**：

Vision 索引器有两种工作模式：

1. **Path A: multimodal_embedding** - 直接对图片进行向量化（不生成文本）
2. **Path B: vision_to_text** - 使用 Vision LLM 分析图片生成文本描述（需要 Vision LLM 配置）

**根本原因**：

- Vision 索引器原本只使用 Collection 的 LLM 配置（`deepseek-ai/DeepSeek-V3`）
- 该模型可能不支持 vision（`is_vision_model()`返回 False）
- 因此只使用了 Path A（multimodal_embedding），没有使用 Path B（vision_to_text）
- 即使配置了 VISION_LLM 环境变量，也没有被使用

**修复**：已修改`aperag/index/vision_index.py`，让 Vision 索引器优先使用 VISION_LLM 环境变量：

1. 添加了`_get_vision_llm_completion_service()`函数，从环境变量获取 Vision LLM
2. 修改了`create_index`方法，优先使用 VISION_LLM，如果未配置则回退到 Collection LLM
3. 确保 VISION_LLM 的`vision=True`标志被正确设置

**解决方案**：

### 步骤 1：检查 Vision LLM 配置

检查环境变量是否配置了 Vision LLM：

```bash
# 检查环境变量
docker exec aperag-celeryworker env | Select-String -Pattern "VISION_LLM"
```

应该看到：

```
VISION_LLM_PROVIDER=siliconflow
VISION_LLM_MODEL=Pro/Qwen/Qwen2.5-VL-7B-Instruct
VISION_LLM_BASE_URL=https://api.siliconflow.cn/v1
VISION_LLM_API_KEY=your_api_key
```

### 步骤 2：配置 Vision LLM（如果未配置）

如果环境变量未配置，需要在`.env`文件中添加：

```bash
# Vision LLM配置（用于图片分析生成文本）
VISION_LLM_PROVIDER=siliconflow
VISION_LLM_MODEL=Pro/Qwen/Qwen2.5-VL-7B-Instruct
VISION_LLM_BASE_URL=https://api.siliconflow.cn/v1
VISION_LLM_API_KEY=your_siliconflow_api_key
```

### 步骤 3：重启服务并重建索引

```bash
# 重启celery worker以加载新配置
docker restart aperag-celeryworker

# 重建Vision和GRAPH索引
# 通过Web界面或API重建
```

### 步骤 4：验证 Vision LLM 是否工作

重建索引后，检查日志应该看到：

```
INFO: Created X vision-to-text vectors for document doc7cd4efa65cdfbaf7
```

而不是：

```
INFO: Created X direct vision vectors for document doc7cd4efa65cdfbaf7
```

## 修复总结

### 已完成的修复

1. ✅ **修复导入错误**（`aperag/graph/lightrag_manager.py`）

   - 修复了`get_sync_session`的导入路径
   - 从`aperag.db.ops`改为`aperag.config`

2. ✅ **修复 Vision LLM 使用问题**（`aperag/index/vision_index.py`）
   - 添加了`_get_vision_llm_completion_service()`函数
   - 修改 Vision 索引器优先使用 VISION_LLM 环境变量
   - 如果 VISION_LLM 未配置，回退到 Collection LLM

### 下一步操作

1. ✅ 代码修复已完成
2. ✅ Vision LLM 配置已检查（已配置）
3. ⏳ **重启 Celery Worker**（必须！）
   ```bash
   docker restart aperag-celeryworker
   ```
4. ⏳ **重建 Vision 和 GRAPH 索引**
   - 通过 Web 界面或 API 重建索引
   - 重建后应该看到日志：`Using VISION_LLM from environment variables: Pro/Qwen/Qwen2.5-VL-7B-Instruct`
   - 应该看到：`Created X vision-to-text vectors for document doc7cd4efa65cdfbaf7`
5. ⏳ **验证修复效果**
   - 检查日志中是否有 Vision LLM 调用
   - 检查是否有"vision-to-text vectors"的日志
   - 检查是否有"Enriched content"的日志
   - 验证知识图谱是否成功创建（entities_extracted > 0）
