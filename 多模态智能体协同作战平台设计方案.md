# **变电站智慧大脑：多模态智能体协同作战平台设计方案**

## **1.0 总体设计思想与架构**

### **1.1 直面挑战：“知识枷锁”**

本方案旨在解决当前变电站运维中的四大核心痛点：

- **找资料，大海捞针？** — 图纸、规程、报告、定值单散落各处，关键时刻找不到、找不全。
- **问问题，无人应答？** — 专家经验随人走，新人成长周期长，简单问题反复问。
- **用图纸，心惊胆战？** — 版本混乱，新旧不分，现场施工埋下巨大安全隐患。
- **有数据，却无洞察？** — 海量运维数据（SCADA、影像）沉睡，无法转化为预防性维护的决策依据。

我们的目标是构建一个能思考、会协同、能行动的“智慧大脑”，将“文档库”升级为“7x24 小时智能作战平台”。

### **1.2 核心架构：任务驱动的智能体编排 (Task-driven Agent Orchestration)**

我们的核心思想是\*\*“任务驱动的智能体编排”\*\*。此架构在您项目 aperag/agent/ 和 aperag/flow/runners/ 的基础上构建。当用户从前端（如 web/src/app/page.tsx 中定义的“智能体应用”）发起一个复杂任务（如“告警智能研判”）时，系统由一个“**总控智能体（Master Agent）**”来接收、理解并拆解任务，然后调度多个具备不同专业技能的“**专家智能体（Specialist Agents）**”协同完成。

- **总控智能体 (Master Agent / MCP):**
  - **技术映射:** aperag/agent/mcp_app_factory.py, aperag/agent/agent_session_manager.py。
  - **职责:** 负责任务理解、任务拆解、专家智能体调度、中间结果汇总、逻辑推理和最终报告生成。
- **专家智能体 (Specialist Agents / Tools):**
  - **技术映射:** aperag/flow/runners/ 目录下的各个执行器。
  - **职责:** 封装了特定的原子能力（如知识图谱查询、向量检索、视觉分析），等待总控智能体调用。

**技术亮点：我们如何做到与众不同？**

1. **看得懂图纸：** 独有的 CAD 图元级解析（需扩展），能直接回答“图上这个设备是什么型号？”。
2. **查得又准又全：** 混合检索（vector_search.py \+ graph_search.py \+ fulltext_search.py），既能理解口语化提问，又不放过任何一个精确的设备编号。
3. **答得有理有据：** 每一条答案都提供“证据链”溯源（通过 RAG 检索结果），一键直达原始图纸或规程的具体位置，确保权威可靠。

### **1.3 破局之道：“三步走”智慧引擎及其代码实现**

本方案的“三步走”战略，在您的代码库中均有明确的技术实现路径：

**第一步：唤醒知识 (Knowledge Awakening)**

- **目标：** 采用多模态 AI 解析技术，将分散、沉睡的资料（文档、CAD、影像）转化为互相关联、机器可理解的智慧知识元。
- **代码实现思路 (Knowledge Base Construction):**
  - **数据接入:** aperag/source/ 目录（如 s3.py, feishu.py, local.py）负责从不同数据源拉取原始文件。
  - **异步处理:** 文档的接入和解析是耗时操作，由 config/celery_tasks.py 触发异步任务。
  - **解析与分片:** aperag/tasks/document.py 调用 aperag/docparser/ (如 mineru_parser.py, docray_parser.py) 对文档进行解析和分片。
  - **多维索引:** aperag/index/manager.py 调度 vector_index.py, graph_index.py, vision_index.py 等，将解析后的知识分别存入 Qdrant, Neo4j, 和影像库中，完成知识库的构建。

**第二步：构建大脑 (Brain Construction)**

- **目标：** 基于先进的 Agent 架构，通过语义向量检索与大型语言模型（LLM）的黄金组合，让系统学会像专家一样思考和编排任务。
- **代码实现思路 (Master Agent):**
  - **核心:** aperag/agent/mcp_app_factory.py 和 aperag/agent/agent_event_processor.py 作为“总控大脑”。它们负责接收来自 API 层（aperag/views/agent.py）的任务请求。
  - **任务编排:** mcp_app_factory.py 利用大型语言模型（LLM）的 Tool-using 能力，将用户的复杂任务（如“告警研判”）分解为一系列工具调用（Tools）。
  - **会话管理:** aperag/agent/agent_session_manager.py 和 agent_history_manager.py 负责维护多轮对话和任务执行的上下文状态。

**第三步：赋能场景 (Scenario Empowerment)**

- **目标：** 将强大的技术能力，精准注入到智能问答、图纸风控、辅助决策三大高频工作场景中，让智慧“找得到人”，让价值“落得了地”。
- **代码实现思路 (Specialist Agents / Tools):**
  - **定义:** 专家智能体在代码中体现为“**Flow Runners**”，定义在 aperag/flow/runners/ 目录下。
  - **RAG 检索智能体:** aperag/flow/runners/vector_search.py（向量）和 aperag/flow/runners/fulltext_search.py（全文）。
  - **图谱检索智能体:** aperag/flow/runners/graph_search.py。
  - **VLM 巡检智能体 (天眼):** aperag/flow/runners/vision_search.py。
  - **报告/预案生成智能体:** aperag/flow/runners/llm.py，它被总控智能体在最后一步调用，用于汇总所有中间结果并生成结构化报告。
  - **结果合并:** aperag/flow/runners/merge.py 负责将多个检索智能体的结果（如图谱、向量）合并，再喂给生成智能体。

\<\!-- end list \--\>

graph TD  
 subgraph Frontend \[前端应用 (Web UI)\]  
 UI\[知识库/智能体应用\] \-- 1\. 触发任务(如:告警研判) \--\> API_GW\[API 网关 (aperag/views/agent.py)\]  
 end

    subgraph Backend \[后端: 智能体协同平台\]
        API\_GW \-- 2\. 任务请求 \--\> MA\[总控智能体 (Master Agent)\<br/\>\`mcp\_app\_factory.py\`\]

        MA \-- 3\. 任务拆解与调度 \--\> SA\_Graph\[图谱检索智能体\]
        MA \-- 3\. 任务拆解与调度 \--\> SA\_RAG\[RAG检索智能体\]
        MA \-- 3\. 任务拆解与调度 \--\> SA\_Vision\[VLM巡检智能体 (天眼)\]
        MA \-- 3\. 任务拆解与调度 \--\> SA\_Data\[实时数据智能体\]
        MA \-- 3\. 任务拆解与调度 \--\> SA\_Gen\[预案/报告生成智能体\]

        subgraph SpecialistAgents \[专家智能体池 (Specialist Agents Pool / flow/runners/)\]
            SA\_Graph(图谱检索\<br/\>\`graph\_search.py\`)
            SA\_RAG(RAG检索\<br/\>\`vector\_search.py\`)
            SA\_Vision(VLM巡检\<br/\>\`vision\_search.py\`)
            SA\_Data(实时数据\<br/\>\`\[外部API\]\`)
            SA\_Gen(预案/报告生成\<br/\>\`llm.py\`)
        end

        subgraph KnowledgeBase \[多维知识存储 (Knowledge Base / index/)\]
            KB\_Graph\[图数据库 (Neo4j)\<br/\>\`graph\_index.py\`\]
            KB\_Vector\[向量数据库 (Qdrant)\<br/\>\`vector\_index.py\`\]
            KB\_Vision\[影像数据库\<br/\>\`vision\_index.py\`\]
            KB\_Docs\[文档/台账 (PostgreSQL)\<br/\>\`db/models.py\`\]
            KB\_External\[实时数据库 (SCADA/DMS)\]
        end

        SA\_Graph \-- 4\. 查询 \--\> KB\_Graph
        SA\_RAG \-- 4\. 查询 \--\> KB\_Vector
        SA\_Vision \-- 4\. 分析 \--\> KB\_Vision
        SA\_Data \-- 4\. 查询 \--\> KB\_External

        SA\_Graph & SA\_RAG & SA\_Vision & SA\_Data \-- 5\. 返回中间结果 \--\> MA
        MA \-- 6\. 综合推理, 二次调度 \--\> SA\_Gen
        SA\_Gen \-- 7\. 生成最终报告 \--\> MA

        MA \-- 8\. 格式化结果 \--\> API\_GW
    end

    API\_GW \-- 9\. 推送结构化报告 \--\> ResultUI\[前端结果展示页\]

    style MA fill:\#bbf,stroke:\#333,stroke-width:2px
    style SpecialistAgents fill:\#def,stroke:\#333,stroke-width:1px
    style KnowledgeBase fill:\#ffc,stroke:\#333,stroke-width:1px

## **2.0 核心知识资产 (Knowledge Assets)**

智能体的“智慧”来源于对变电站全量知识资产的“唤醒”。我们需构建以下五大核心知识库，它们是专家智能体的能力来源：

1. **多维文档库 (Text & Doc KB):**
   - **内容:** 运行规程、操作手册、技术标准、检修报告、验收文档、保护定值表(PDF/Word 版)。
   - **技术:** aperag/docparser/ (如 mineru_parser.py) 进行解析分片，aperag/index/vector_index.py 存入 Qdrant。
2. **设备图谱 (Equipment Knowledge Graph):**
   - **内容:** 设备台账、电气拓扑关系（来自 CAD 解析）、间隔-设备-告警-工单的关联关系。
   - **技术:** aperag/graph/lightrag/ 提取实体关系，aperag/index/graph_index.py 存入 Neo4j/Nebula。
3. **多模态图像库 (Multi-modal Image KB):**
   - **内容:** 历史巡视影像（无人机、机器人、手持）、红外测温影像、监控视频切片。
   - **技术:** aperag/index/vision_index.py 负责影像的特征提取与索引。
4. **工程图纸库 (Engineering Drawing KB):**
   - **内容:** CAD 图纸（.dwg, .dxf）的图元级解析数据，包括设备符号、电气连接、文字标注。
   - **技术:** （需扩展）在 aperag/docparser/ 中补充 CAD 解析能力，解析结果存入 graph_index.py。
5. **故障案例库 (Historical Case KB):**
   - **内容:** 历史缺陷报告、故障简报、已关闭的告警和工单，以及对应的处置措施。
   - **技术:** aperag/index/vector_index.py (语义) 和 aperag/index/fulltext_index.py (关键词)。

## **3.0 智能体应用场景设计 (Agent Application Design)**

以下是针对您图片中六大应用场景的具体智能体协同方案：

### **3.1 告警智能研判 (Intelligent Alarm Analysis)**

- **核心任务:** 解决“有数据，却无洞察”的痛点。当 SCADA 产生告警（如“\#2 主变重瓦斯告警”）时，自动完成研判，生成辅助决策报告。
- **协同工作流:**
  1. **触发:** 用户在应用界面点击“启动研判”并输入告警信息：“\#2 主变重瓦斯告警”。
  2. **总控智能体 (Master Agent)** 接收任务。
     - **技术实现映射:** aperag/agent/mcp_app_factory.py 接收 API 请求，理解任务意图。
  3. **总控智能体** 拆解为 4 个并行子任务：
     - **\[调度 SA_Data\]** task_1: "立即查询\#2 主变在告警发生前后 1 小时的 SCADA 实时数据..."
       - **技术实现映射:** _（需扩展）_ 调用外部 API 接口（如 SCADA、EMS）的工具。
     - **\[调度 SA_RAG\]** task_2: "检索知识库中所有‘重瓦斯告警’相关的‘标准操作规程’、‘应急预案’和‘历史故障案例’。"
       - **技术实现映射:** aperag/flow/runners/vector_search.py 和 fulltext_search.py。
     - **\[调度 SA_Vision\]** task_3: "调取\#2 主变附近的摄像头，使用 vision_search 分析现场图像..."
       - **技术实现映射:** aperag/flow/runners/vision_search.py。
     - **\[调度 SA_Graph\]** task_4: "查询\#2 主变的设备图谱，获取其型号、投运日期、历史缺陷记录。"
       - **技术实现映射:** aperag/flow/runners/graph_search.py。
  4. **总控智能体** 汇总所有中间结果：
     - **技术实现映射:** aperag/flow/runners/merge.py 可能被用于合并多个检索源的结果。
  5. **总控智能体** 进行综合推理，并**二次调度** SA_Gen：
     - **\[调度 SA_Gen\]** task_5: "综合以下信息：\[...所有结果...\]，生成一份结构化研判报告..."
       - **技术实现映射:** aperag/flow/runners/llm.py 被调用，以所有汇总结果为上下文，生成最终答案。
  6. **交付:** 向前端推送包含“数据分析”、“视觉证据”、“历史案例”、“智能诊断结论”和“推荐处置步骤”的完整报告。
- **交付价值:** **效率革命 \+ 安全革命**。将数小时的人工排查压缩至分钟级，并能交叉验证多源信息，提供专家级的诊断支持。

### **3.2 历史缺陷归因 (Historical Defect Root Cause Analysis)**

- **核心任务:** 解决“隐性经验流失”问题。分析某一类缺陷（如“GIS-220kV 闸刀定位异常”）的根本原因。
- **协同工作流:**
  1. **触发:** 用户输入：“分析‘GIS-220kV 闸刀定位异常’的历史缺陷”。
  2. **总控智能体** 拆解任务：
     - **\[调度 SA_Graph\]** task_1: "查询设备图谱，找出所有发生过‘定位异常’的‘GIS-220kV 闸刀’设备。"
       - **技术实现映射:** aperag/flow/runners/graph_search.py。
     - **\[调度 SA_RAG\]** task_2: "检索 task_1 中所有设备的‘检修报告’和‘缺陷票’原文。"
       - **技术实现映射:** aperag/flow/runners/vector_search.py。
  3. **总控智能体** 汇总报告，并**二次调度** SA_Gen：
     - **\[调度 SA_Gen\]** task_3: "分析以下报告：\[...所有报告...\]，聚类总结导致‘GIS-220kV 闸刀定位异常’的根本原因..."
       - **技术实现映射:** aperag/flow/runners/llm.py。
  4. **交付:** 生成一份缺陷归因统计报告。
- **交付价值:** **知识革命**。将分散的缺陷数据转化为结构化的“组织记忆”，为预测性维护和设备选型提供依据。

### **3.3 智能图纸比对 (Intelligent Drawing Comparison)**

- **核心任务:** 解决“用图纸，心惊胆战”的痛点。
- **协同工作流:**
  1. **触发:** 用户上传 V1.dwg 和 V2.dwg，点击“智能比对”。
  2. **总控智能体** 拆解任务：
     - **\[调度 SA_CAD\]** task_1 & task_2: "对 V1.dwg 和 V2.dwg 进行 CAD 图元级解析..."
       - **技术实现映射:** _（需扩展）_ 此功能为未来规划。实现时，需在 aperag/docparser/ 中新增 cad_parser.py 并封装为 Runner。
  3. **总控智能体** 汇总结果，并**二次调度** SA_Gen：
     - **\[调度 SA_Gen\]** task_3: "对比 task_1 和 task_2 的结构化数据，生成变更报告..."
       - **技术实现映射:** aperag/flow/runners/llm.py（或一个专用的 diff 工具）。
  4. **交付:** 一份图纸差异报告。
- **交付价值:** **安全革命 \+ 效率革命**。从源头杜绝图纸版本风险，将“大家来找茬”式的审图工作变为自动化校验。

### **3.4 保护定值核查 (Protection Setting Verification)**

- **核心任务:** 自动化核查保护定值，防止误操作。
- **协同工作流:**
  1. **触发:** 用户上传一份定值单.xlsx，并指定设备“\#1 主变高后备保护”。
  2. **总控智能体** 拆解任务：
     - **\[调度 SA_Parser\]** task_1: "使用 MinerU 解析定值单.xlsx..."
       - **技术实现映射:** aperag/docparser/mineru_parser.py。
     - **\[调度 SA_RAG\]** task_2: "检索知识库中‘\#1 主变’对应的最新‘保护定值计算单’..."
       - **技术实现映射:** aperag/flow/runners/vector_search.py。
  3. **总控智能体** 汇总结果，并**二次调度** SA_Gen：
     - **\[调度 SA_Gen\]** task_3: "逐项对比 task_1（待核查）和 task_2（标准值），生成核查报告。"
       - **技术实现映射:** aperag/flow/runners/llm.py。
  4. **交付:** 核查报告。
- **交付价值:** **安全革命**。确保保护定值的准确性，是电网安全的第一道防线。

### **3.5 操作票智能生成 (Intelligent Operation Ticket Generation)**

- **核心任务:** 解决“找资料，大海捞针”和“新人不敢开票”的痛点。
- **协同工作流:**
  1. **触发:** 用户输入：“生成‘\#1 主变转冷备用’的操作票”。
  2. **总控智能体** 拆解任务：
     - **\[调度 SA_Graph\]** task_1: "查询设备图谱，获取‘\#1 主变’及其所有关联的开关、刀闸的设备编号和当前状态。"
       - **技术实现映射:** aperag/flow/runners/graph_search.py。
     - **\[调度 SA_RAG\]** task_2: "检索知识库中‘主变转冷备用’的‘标准操作规程’。"
       - **技术实现映射:** aperag/flow/runners/vector_search.py。
  3. **总控智能体** 汇总结果，并**二次调度** SA_Gen：
     - **\[调度 SA_Gen\]** task_3: "以 task_2（规程模板）为框架，用 task_1（具体设备列表）填充内容..."
       - **技术实现映射:** aperag/flow/runners/llm.py。
  4. **交付:** 一份待复核的操作票。
- **交付价值:** **效率革命 \+ 知识革命**。将专家开票的隐性逻辑（先查图谱再套规程）显性化，极大提升开票效率和准确性。

### **3.6 巡视影像智能分析 (Intelligent Inspection Image Analysis)**

- **核心任务:** 自动分析海量巡视影像，解决“有数据，却无洞察”的视觉问题。
- **协同工作流:**
  1. **触发:** 无人机/机器人自动上传当日巡视影像至数据源（如 S3）。
     - **技术实现映射:** aperag/source/s3.py 配合事件通知触发 config/celery_tasks.py 中的任务。
  2. **总控智能体**（由 Celery 任务触发）task_1: "处理所有新到影像。"
  3. **总控智能体** 调度 SA_Vision 对**每张**图片执行分析：
     - **\[调度 SA_Vision\]** task_2: "调用 vision_search，运行多模型管线..."
       - **技术实现映射:** aperag/flow/runners/vision_search.py。
  4. **总控智能体** 汇总所有影像的结构化 JSON 输出，并**二次调度** SA_Gen：
     - **\[调度 SA_Gen\]** task_3: "汇总所有发现的异常，生成‘每日智能巡视简报’。"
       - **技术实现映射:** aperag/flow/runners/llm.py。
  5. **交付:** 巡视简报。
- **交付价值:** **安全革命**。实现 7x24 小时不知疲倦的“天眼”监控，变“事后抢修”为“事前维护”。

## **4.0 核心价值：为您带来的三大革命性收益**

1. **效率革命：将“小时级”工作压缩至“秒级”**
   - **问题响应速度提升 95%以上：** 从数小时翻找资料，到 3 秒内获得精准答案；从数小时告警研判，到分钟级生成完整报告。
   - **新员工上手效率提升 50%：** “在线专家”随时指导，大幅缩短培训周期。
   - **智能审图效率提升 5-10 倍：** 自动比对图纸差异，让审图人员聚焦核心变更。
2. **安全革命：从“被动响应”到“主动预见”**
   - **杜绝图纸版本风险：** 确保全员使用唯一、正确的图纸版本，从源头消除施工隐患。
   - **实现预测性维护：** 智能体（SA_Vision \+ SA_RAG）深度分析历史数据和实时影像，提前预警潜在设备故障，变“事后抢修”为“事前维护”。
3. **知识革命：将“个人经验”转化为“组织资产”**
   - **构建永不离职的专家团队：** 将隐性知识（如故障诊断逻辑、开票经验）固化为可随时调用的“专家智能体”，形成企业级的核心智慧资产。
   - **驱动数据决策：** 为管理层提供直观的数据洞察，让每一次决策都有据可依。
