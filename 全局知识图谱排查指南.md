# 全局知识图谱层次显示问题排查指南

## 问题描述
全局知识图谱的层次显示（Collection → Document → Entity）没有正常显示内容。

## 功能说明
全局知识图谱应该显示：
- **Collection（知识库）** - 用方块 (□) 表示
- **Document（文档）** - 用三角形 (△) 表示  
- **Entity（实体）** - 用圆形 (●) 表示

点击 Collection 或 Document 节点可以进入相应的知识图谱详情页面。

## 排查步骤

### 1. 检查后端 API 是否正常运行

```bash
# 查看 API 容器日志
docker logs aperag-api

# 检查是否有错误信息，特别是：
# - ModuleNotFoundError
# - SyntaxError
# - ImportError
```

**预期结果**：API 应该成功启动，没有错误信息。

### 2. 检查 API 健康状态

```bash
# 测试 API 健康检查端点
curl http://localhost:8000/health

# 或者在浏览器中访问
# http://localhost:8000/docs
```

**预期结果**：返回 `{"status":"healthy"}` 或显示 Swagger API 文档页面。

### 3. 测试全局层次图谱 API

```bash
# 测试层次图谱 API（需要先登录获取 token）
curl -X POST http://localhost:8000/api/v1/graphs/hierarchy/global \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{"query": "", "top_k": 100}'
```

**预期结果**：返回包含 `nodes` 和 `edges` 的 JSON 数据。

### 4. 检查数据库中是否有数据

```bash
# 进入 PostgreSQL 容器
docker exec -it aperag-postgres psql -U postgres -d aperag

# 查询 Collection 数量
SELECT COUNT(*) FROM collections WHERE status = 'ACTIVE';

# 查询 Document 数量
SELECT COUNT(*) FROM documents;

# 退出
\q
```

**预期结果**：至少应该有一些 Collection 和 Document 数据。

### 5. 检查前端控制台

打开浏览器开发者工具（F12），查看：

1. **Console 标签页**：
   - 查找 JavaScript 错误
   - 查找 API 请求失败的错误信息
   - 应该能看到类似 "Auto-load graph data: {nodeCount: X, edgeCount: Y}" 的日志

2. **Network 标签页**：
   - 刷新页面
   - 查找对 `/api/v1/graphs/hierarchy/global` 的 POST 请求
   - 检查请求状态码（应该是 200）
   - 查看响应内容

### 6. 检查前端环境变量

确认前端的 API 端点配置正确：

```bash
# 查看前端环境变量
cat web/deploy/env.local.template

# 或者检查运行中的前端容器
docker exec aperag-frontend env | grep API
```

**预期配置**：
```
API_SERVER_ENDPOINT=http://api:8000
API_SERVER_BASE_PATH=/api/v1
```

## 常见问题和解决方案

### 问题 1：API 返回 401 Unauthorized
**原因**：用户未登录或 token 过期  
**解决**：确保已登录系统

### 问题 2：API 返回空数据 `{nodes: [], edges: []}`
**原因**：数据库中没有数据  
**解决**：
1. 创建至少一个 Collection
2. 上传一些文档到 Collection 中
3. 刷新全局知识图谱页面

### 问题 3：前端显示 "Failed to fetch" 错误
**原因**：前端无法连接到后端 API  
**解决**：
1. 检查 `docker-compose up` 是否所有容器都正常运行
2. 检查 `aperag-api` 容器是否健康
3. 检查前端的 API 端点配置

### 问题 4：图谱显示但节点无法点击
**原因**：节点的 metadata 中缺少 collection_id 或 document_id  
**解决**：这是后端数据问题，需要检查 `global_graph_service.py` 中的数据构建逻辑

## 代码位置参考

### 前端代码
- 主文件：`web/src/app/workspace/collections/all/graph/global-graph-explorer.tsx`
- API 调用：第 141 行，`fetch('/api/v1/graphs/hierarchy/global', ...)`
- 数据加载：`fetchHierarchyData` 函数（第 136-208 行）
- 节点点击处理：`handleNodeClick` 函数（第 250 行）
- 导航逻辑：`navigateToGraph` 函数（第 226-247 行）

### 后端代码
- API 路由：`aperag/views/graph.py` 第 188-207 行
- 服务实现：`aperag/service/global_graph_service.py`
  - `get_global_hierarchy` 方法（第 39-178 行）
- 数据模型：`aperag/schema/view_models.py`
  - `GraphData`, `GraphHierarchyNode`, `GraphHierarchyEdge`

## 下一步行动

1. **立即检查**：运行上述排查步骤 1-2，确认 API 是否正常
2. **验证数据**：运行步骤 4，确认数据库中有数据
3. **前端调试**：运行步骤 5，查看浏览器控制台的具体错误信息
4. **提供反馈**：将上述检查结果反馈，以便进一步诊断

## 预期的正常行为

当一切正常时，您应该看到：

1. 页面加载后自动发起 API 请求
2. 控制台显示：`Auto-load graph data: {nodeCount: X, edgeCount: Y, statistics: {...}}`
3. 图谱中显示不同颜色的节点：
   - 蓝色方块：Collection
   - 绿色三角形：Document
   - 橙色圆形：Entity
4. 单击节点可以展开/折叠
5. 双击 Collection 或 Document 节点可以跳转到详细图谱页面
