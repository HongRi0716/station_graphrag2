# å¦‚ä½•å¿«é€Ÿå®ç°æ–°æ™ºèƒ½ä½“ - æ— éœ€ä¿®æ”¹é€šç”¨ä»£ç 

> **æ ¸å¿ƒç†å¿µ**: é€šè¿‡é…ç½®é©±åŠ¨å’Œæç¤ºè¯é©±åŠ¨ï¼Œåœ¨ä¸ä¿®æ”¹BaseAgentç­‰é€šç”¨ä»£ç çš„æƒ…å†µä¸‹å¿«é€Ÿå®ç°æ–°çš„æ™ºèƒ½ä½“

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿç°çŠ¶åˆ†æ](#ç³»ç»Ÿç°çŠ¶åˆ†æ)
2. [ä¸‰ç§å®ç°æ–¹å¼](#ä¸‰ç§å®ç°æ–¹å¼)
3. [æ–¹å¼ä¸€ï¼šæç¤ºè¯é©±åŠ¨æ™ºèƒ½ä½“ï¼ˆæœ€å¿«ï¼‰](#æ–¹å¼ä¸€æç¤ºè¯é©±åŠ¨æ™ºèƒ½ä½“æœ€å¿«)
4. [æ–¹å¼äºŒï¼šé…ç½®é©±åŠ¨æ™ºèƒ½ä½“ï¼ˆæ¨èï¼‰](#æ–¹å¼äºŒé…ç½®é©±åŠ¨æ™ºèƒ½ä½“æ¨è)
5. [æ–¹å¼ä¸‰ï¼šè‡ªå®šä¹‰æ™ºèƒ½ä½“ï¼ˆå®Œå…¨æ§åˆ¶ï¼‰](#æ–¹å¼ä¸‰è‡ªå®šä¹‰æ™ºèƒ½ä½“å®Œå…¨æ§åˆ¶)
6. [å‰åç«¯ç»Ÿä¸€é›†æˆ](#å‰åç«¯ç»Ÿä¸€é›†æˆ)
7. [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)

---

## ç³»ç»Ÿç°çŠ¶åˆ†æ

### âœ… å·²å®ç°çš„æ™ºèƒ½ä½“

æ ¹æ®ä»£ç åˆ†æï¼Œç›®å‰**å·²å®Œå…¨å®ç°**çš„æ™ºèƒ½ä½“æœ‰ï¼š

1. **ArchivistAgent** (å›¾è°±ä¸“å®¶) âœ…
   - çŸ¥è¯†åº“æ£€ç´¢
   - å›¾è°±éå†
   - å†å²æ•°æ®æŸ¥è¯¢

2. **SupervisorAgent** (å€¼ç­é•¿) âœ…
   - ä»»åŠ¡åˆ†æå’Œè·¯ç”±
   - å¤šæ™ºèƒ½ä½“åä½œç¼–æ’

3. **AccidentDeductionAgent** (äº‹æ•…é¢„æƒ³ä¸“å®¶) âœ…
   - äº‹æ•…æ¨æ¼”
   - åº”æ€¥é¢„æ¡ˆç”Ÿæˆ

4. **OperationTicketAgent** (æ“ä½œç¥¨ä¸“å®¶) âœ…
5. **WorkPermitAgent** (å·¥ä½œç¥¨ä¸“å®¶) âœ…
6. **PowerGuaranteeAgent** (ä¿ç”µä¸“å®¶) âœ…

### ğŸ”§ å·²æ³¨å†Œä½†ä½¿ç”¨é€šç”¨å®ç°çš„æ™ºèƒ½ä½“

è¿™äº›æ™ºèƒ½ä½“å·²æ³¨å†Œï¼Œä½†ä½¿ç”¨ `PromptDrivenAgent` é€šç”¨å®ç°ï¼š

1. **DiagnosticianAgent** (æ•…éšœè¯Šæ–­ä¸“å®¶)
2. **InstructorAgent** (åŸ¹è®­å¯¼å¸ˆ)
3. **SentinelAgent** (å®‰ç›‘å«å£«)

### ğŸ“ å·²é…ç½®ä½†æœªæ³¨å†Œçš„æ™ºèƒ½ä½“

è¿™äº›æ™ºèƒ½ä½“åœ¨ `agent_configs.py` ä¸­æœ‰å®Œæ•´é…ç½®ï¼Œä½†æœªåœ¨ `registry.py` ä¸­æ³¨å†Œï¼š

1. **DetectiveAgent** (å›¾çº¸ä¾¦æ¢)
2. **GatekeeperAgent** (é—¨ç¦ä¸“å®¶)
3. **ProphetAgent** (é¢„æµ‹ä¸“å®¶)
4. **AuditorAgent** (å®¡è®¡ä¸“å®¶)
5. **CalculatorAgent** (è®¡ç®—ä¸“å®¶)
6. **ScribeAgent** (æ–‡ä¹¦ä¸“å®¶)

---

## ä¸‰ç§å®ç°æ–¹å¼

ç³»ç»Ÿæä¾›äº†ä¸‰ç§çµæ´»çš„æ™ºèƒ½ä½“å®ç°æ–¹å¼ï¼Œä»ç®€å•åˆ°å¤æ‚ï¼š

```
æ–¹å¼ä¸€: æç¤ºè¯é©±åŠ¨ (PromptDrivenAgent)
  â”œâ”€ ä¼˜ç‚¹: æœ€å¿«ï¼Œåªéœ€é…ç½®æç¤ºè¯
  â”œâ”€ ç¼ºç‚¹: åŠŸèƒ½æœ‰é™ï¼Œæ— æ³•è‡ªå®šä¹‰é€»è¾‘
  â””â”€ é€‚ç”¨: ç®€å•çš„å¯¹è¯å‹æ™ºèƒ½ä½“

æ–¹å¼äºŒ: é…ç½®é©±åŠ¨ (AgentMetadata)
  â”œâ”€ ä¼˜ç‚¹: åŠŸèƒ½ä¸°å¯Œï¼Œæ”¯æŒçŸ¥è¯†åº“ã€æ¨¡æ¿ç­‰
  â”œâ”€ ç¼ºç‚¹: éœ€è¦é…ç½®è¾ƒå¤šå‚æ•°
  â””â”€ é€‚ç”¨: å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯

æ–¹å¼ä¸‰: è‡ªå®šä¹‰æ™ºèƒ½ä½“ (ç»§æ‰¿BaseAgent)
  â”œâ”€ ä¼˜ç‚¹: å®Œå…¨æ§åˆ¶ï¼Œå¯å®ç°å¤æ‚é€»è¾‘
  â”œâ”€ ç¼ºç‚¹: éœ€è¦ç¼–å†™ä»£ç 
  â””â”€ é€‚ç”¨: å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚å›¾è°±ä¸“å®¶ï¼‰
```

---

## æ–¹å¼ä¸€ï¼šæç¤ºè¯é©±åŠ¨æ™ºèƒ½ä½“ï¼ˆæœ€å¿«ï¼‰

### é€‚ç”¨åœºæ™¯

- ç®€å•çš„å¯¹è¯å‹æ™ºèƒ½ä½“
- ä¸éœ€è¦ç‰¹æ®Šå·¥å…·è°ƒç”¨
- ä¸»è¦ä¾èµ–LLMèƒ½åŠ›

### å®ç°æ­¥éª¤

#### æ­¥éª¤1: åœ¨ `prompts.py` ä¸­æ·»åŠ æç¤ºè¯

```python
# aperag/agent/prompts.py

AGENT_SYSTEM_PROMPTS = {
    # ... ç°æœ‰æç¤ºè¯ ...
    
    # æ–°å¢ï¼šå·¡æ£€ä¸“å®¶
    AgentRole.PATROL: """
ä½ æ˜¯å˜ç”µç«™å·¡æ£€ä¸“å®¶ (Patrol Expert)ã€‚

## æ ¸å¿ƒèŒè´£
1. æŒ‡å¯¼è®¾å¤‡å·¡æ£€å·¥ä½œ
2. è¯†åˆ«è®¾å¤‡å¼‚å¸¸ç°è±¡
3. æä¾›å·¡æ£€å»ºè®®

## ä¸“ä¸šèƒ½åŠ›
- ç†Ÿæ‚‰è®¾å¤‡å·¡æ£€è§„èŒƒ
- æŒæ¡å¼‚å¸¸è¯†åˆ«æ–¹æ³•
- ç²¾é€šå·¡æ£€è®°å½•å¡«å†™

## å·¥ä½œæµç¨‹
1. æ¥æ”¶å·¡æ£€ä»»åŠ¡
2. æä¾›å·¡æ£€è¦ç‚¹
3. åˆ†æå¼‚å¸¸ç°è±¡
4. ç»™å‡ºå¤„ç½®å»ºè®®

## è¾“å‡ºè¦æ±‚
- å·¡æ£€è¦ç‚¹æ¸…æ™°
- å¼‚å¸¸è¯†åˆ«å‡†ç¡®
- å»ºè®®æªæ–½å¯è¡Œ
""",
}
```

#### æ­¥éª¤2: åœ¨ `models.py` ä¸­æ·»åŠ è§’è‰²æšä¸¾

```python
# aperag/agent/core/models.py

class AgentRole(str, Enum):
    # ... ç°æœ‰è§’è‰² ...
    PATROL = "patrol"  # å·¡æ£€ä¸“å®¶
```

#### æ­¥éª¤3: åœ¨ `registry.py` ä¸­æ³¨å†Œ

```python
# aperag/agent/registry.py

def initialize_default_agents(self, llm_service=None, ...):
    # ... ç°æœ‰ä»£ç  ...
    
    generic_roles = [
        # ... ç°æœ‰è§’è‰² ...
        (AgentRole.PATROL, "å·¡æ£€ä¸“å®¶", "è´Ÿè´£æŒ‡å¯¼è®¾å¤‡å·¡æ£€å’Œå¼‚å¸¸è¯†åˆ«"),
    ]
    
    for role, name, description in generic_roles:
        system_prompt = get_agent_prompt(role)
        agent = PromptDrivenAgent(
            role=role,
            name=name,
            description=description,
            llm_service=llm_service,
            system_prompt=system_prompt,
        )
        self.register(agent)
```

### âœ… å®Œæˆï¼

æ— éœ€ä»»ä½•å…¶ä»–ä»£ç ï¼Œæ™ºèƒ½ä½“å·²å¯ç”¨ã€‚

---

## æ–¹å¼äºŒï¼šé…ç½®é©±åŠ¨æ™ºèƒ½ä½“ï¼ˆæ¨èï¼‰

### é€‚ç”¨åœºæ™¯

- éœ€è¦ä¸“å±çŸ¥è¯†åº“
- éœ€è¦è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿
- éœ€è¦æ–‡ä»¶æ¨¡æ¿æ”¯æŒ
- éœ€è¦å·¥å…·è°ƒç”¨

### å®ç°æ­¥éª¤

#### æ­¥éª¤1: åœ¨ `agent_configs.py` ä¸­æ·»åŠ é…ç½®

```python
# aperag/agent/agent_configs.py

# ============================================================================
# å·¡æ£€ä¸“å®¶é…ç½®
# ============================================================================
PATROL_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.PATROL,
    name="å·¡æ£€ä¸“å®¶",
    description="è®¾å¤‡å·¡æ£€å’Œå¼‚å¸¸è¯†åˆ«ä¸“å®¶",
    
    # ä¸“å±çŸ¥è¯†åº“
    default_collections=[
        # "patrol_standards_db",  # å·¡æ£€è§„èŒƒåº“
        # "equipment_manuals_db",  # è®¾å¤‡æ‰‹å†Œåº“
        # "defect_cases_db"        # ç¼ºé™·æ¡ˆä¾‹åº“
    ],
    
    # ç³»ç»Ÿæç¤ºè¯
    system_prompt_template="""
ä½ æ˜¯å˜ç”µç«™å·¡æ£€ä¸“å®¶ã€‚

## æ ¸å¿ƒèŒè´£
1. æŒ‡å¯¼è®¾å¤‡å·¡æ£€å·¥ä½œ
2. è¯†åˆ«è®¾å¤‡å¼‚å¸¸ç°è±¡
3. æä¾›å·¡æ£€å»ºè®®

## ä¸“ä¸šèƒ½åŠ›
- ç†Ÿæ‚‰è®¾å¤‡å·¡æ£€è§„èŒƒ
- æŒæ¡å¼‚å¸¸è¯†åˆ«æ–¹æ³•
- ç²¾é€šå·¡æ£€è®°å½•å¡«å†™

## å·¡æ£€è¦ç‚¹
1. å¤–è§‚æ£€æŸ¥ï¼šè®¾å¤‡å¤–è§‚ã€æ²¹ä½ã€æ²¹è‰²
2. å£°éŸ³æ£€æŸ¥ï¼šè¿è¡Œå£°éŸ³æ˜¯å¦æ­£å¸¸
3. æ¸©åº¦æ£€æŸ¥ï¼šè®¾å¤‡æ¸©åº¦æ˜¯å¦å¼‚å¸¸
4. æ°”å‘³æ£€æŸ¥ï¼šæ˜¯å¦æœ‰å¼‚å‘³
5. ä»ªè¡¨æ£€æŸ¥ï¼šæŒ‡ç¤ºæ˜¯å¦æ­£å¸¸

## è¾“å‡ºè¦æ±‚
- å·¡æ£€è¦ç‚¹æ¸…æ™°
- å¼‚å¸¸è¯†åˆ«å‡†ç¡®
- å»ºè®®æªæ–½å¯è¡Œ
""",
    
    # æŸ¥è¯¢æç¤ºè¯æ¨¡æ¿
    query_prompt_template="""
**å·¡æ£€ä»»åŠ¡**: {{ query }}

**çŸ¥è¯†åº“ä¸Šä¸‹æ–‡**:
{% if collections %}
å¯ç”¨çŸ¥è¯†åº“:
{% for c in collections %}
- {{ c.title }}
{% endfor %}
{% endif %}

**æ‰§è¡ŒæŒ‡ä»¤**:
1. è¯†åˆ«å·¡æ£€å¯¹è±¡å’Œå·¡æ£€ç±»å‹
2. æŸ¥è¯¢è®¾å¤‡å·¡æ£€è§„èŒƒ
3. æ£€ç´¢ç±»ä¼¼å·¡æ£€æ¡ˆä¾‹
4. åˆ—å‡ºå·¡æ£€è¦ç‚¹
5. æä¾›å¼‚å¸¸è¯†åˆ«æ ‡å‡†
6. ç»™å‡ºå·¡æ£€å»ºè®®

è¯·åŸºäºçŸ¥è¯†åº“æä¾›ä¸“ä¸šçš„å·¡æ£€æŒ‡å¯¼ã€‚
""",
    
    # æ–‡ä»¶æ¨¡æ¿
    file_templates={
        "patrol_report": "templates/patrol_report.md",
        "defect_report": "templates/defect_report.md"
    },
    
    # å·¥å…·é…ç½®
    required_tools=["search_collection"],
    optional_tools=["web_search", "create_diagram"],
    
    # èƒ½åŠ›æ ‡ç­¾
    capabilities={"rag", "inspection", "analysis"},
    
    # ä¼˜å…ˆçº§
    priority=7
)
```

#### æ­¥éª¤2: åœ¨é…ç½®æ˜ å°„è¡¨ä¸­æ·»åŠ 

```python
# aperag/agent/agent_configs.py (æ–‡ä»¶æœ«å°¾)

# é…ç½®æ˜ å°„è¡¨
AGENT_CONFIGS = {
    AgentRole.OPERATION_TICKET: OPERATION_TICKET_AGENT_CONFIG,
    AgentRole.WORK_PERMIT: WORK_PERMIT_AGENT_CONFIG,
    AgentRole.ARCHIVIST: ARCHIVIST_AGENT_CONFIG,
    # ... å…¶ä»–é…ç½® ...
    
    # æ–°å¢
    AgentRole.PATROL: PATROL_AGENT_CONFIG,
}
```

#### æ­¥éª¤3: åˆ›å»ºæ™ºèƒ½ä½“ç±»ï¼ˆå¯é€‰ï¼Œä½¿ç”¨BaseAgentçš„é€šç”¨èƒ½åŠ›ï¼‰

å¦‚æœä¸éœ€è¦è‡ªå®šä¹‰é€»è¾‘ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `PromptDrivenAgent`ï¼š

```python
# aperag/agent/registry.py

def initialize_default_agents(self, llm_service=None, ...):
    # ... ç°æœ‰ä»£ç  ...
    
    # å·¡æ£€ä¸“å®¶ï¼ˆä½¿ç”¨PromptDrivenAgentï¼‰
    patrol_config = AGENT_CONFIGS.get(AgentRole.PATROL)
    if patrol_config:
        patrol_agent = PromptDrivenAgent(
            role=AgentRole.PATROL,
            name=patrol_config.name,
            description=patrol_config.description,
            llm_service=llm_service,
            system_prompt=patrol_config.system_prompt_template,
        )
        self.register(patrol_agent, patrol_config)
```

### âœ… å®Œæˆï¼

æ™ºèƒ½ä½“å·²å…·å¤‡ï¼š
- âœ… ä¸“å±çŸ¥è¯†åº“æ”¯æŒ
- âœ… è‡ªå®šä¹‰æç¤ºè¯
- âœ… æ–‡ä»¶æ¨¡æ¿æ”¯æŒ
- âœ… å·¥å…·è°ƒç”¨èƒ½åŠ›

---

## æ–¹å¼ä¸‰ï¼šè‡ªå®šä¹‰æ™ºèƒ½ä½“ï¼ˆå®Œå…¨æ§åˆ¶ï¼‰

### é€‚ç”¨åœºæ™¯

- éœ€è¦å¤æ‚çš„ä¸šåŠ¡é€»è¾‘
- éœ€è¦å¤šé˜¶æ®µå¤„ç†
- éœ€è¦ç‰¹æ®Šçš„å·¥å…·è°ƒç”¨
- éœ€è¦è‡ªå®šä¹‰æ•°æ®å¤„ç†

### å®ç°æ­¥éª¤

#### æ­¥éª¤1: åˆ›å»ºæ™ºèƒ½ä½“ç±»

```python
# aperag/agent/specialists/patrol_agent.py

import logging
from typing import Any, Dict, List, Optional

from aperag.agent.core.base import BaseAgent
from aperag.agent.core.models import AgentRole, AgentState

logger = logging.getLogger(__name__)


class PatrolAgent(BaseAgent):
    """
    å·¡æ£€ä¸“å®¶ (Patrol Expert)
    
    èŒè´£ï¼š
    - æŒ‡å¯¼è®¾å¤‡å·¡æ£€å·¥ä½œ
    - è¯†åˆ«è®¾å¤‡å¼‚å¸¸ç°è±¡
    - ç”Ÿæˆå·¡æ£€æŠ¥å‘Š
    """
    
    def __init__(self, llm_service: Any = None):
        super().__init__(
            role=AgentRole.PATROL,
            name="å·¡æ£€ä¸“å®¶ (Patrol Expert)",
            description="è®¾å¤‡å·¡æ£€å’Œå¼‚å¸¸è¯†åˆ«ä¸“å®¶",
            tools=["search_collection", "create_diagram"],
        )
        self.llm_service = llm_service
    
    async def _execute(self, state: AgentState, input_data: Dict[str, Any]) -> Dict[str, Any]:
        """æ‰§è¡Œå·¡æ£€ä»»åŠ¡"""
        query = input_data.get("task", "")
        
        self._log_thought(state, "thought", f"å·¡æ£€ä¸“å®¶æ¥æ”¶ä»»åŠ¡: {query}")
        
        # åˆ¤æ–­ä»»åŠ¡ç±»å‹
        if "å¼‚å¸¸" in query or "ç¼ºé™·" in query:
            return await self._analyze_defect(state, query)
        elif "æŠ¥å‘Š" in query:
            return await self._generate_report(state, query)
        else:
            return await self._provide_guidance(state, query)
    
    async def _analyze_defect(self, state: AgentState, query: str) -> Dict[str, Any]:
        """åˆ†æè®¾å¤‡å¼‚å¸¸"""
        self._log_thought(state, "action", "åˆ†æè®¾å¤‡å¼‚å¸¸ç°è±¡")
        
        # 1. ä»çŸ¥è¯†åº“æ£€ç´¢ç±»ä¼¼ç¼ºé™·æ¡ˆä¾‹
        if self.user_id:
            try:
                case_results = await self._search_knowledge(
                    state=state,
                    query=f"{query} ç¼ºé™·æ¡ˆä¾‹",
                    top_k=5
                )
                cases = self._extract_documents_from_tool_results(case_results)
                
                self._log_thought(
                    state,
                    "observation",
                    f"æ£€ç´¢åˆ° {len(cases)} ä¸ªç±»ä¼¼æ¡ˆä¾‹"
                )
            except Exception as e:
                logger.warning(f"Knowledge search failed: {e}")
                cases = []
        else:
            cases = []
        
        # 2. ä½¿ç”¨LLMåˆ†æå¼‚å¸¸
        if self.user_id and cases:
            context = self._build_context(cases)
            prompt = f"""
è¯·åˆ†æä»¥ä¸‹è®¾å¤‡å¼‚å¸¸ç°è±¡ï¼š

**å¼‚å¸¸æè¿°**: {query}

**å‚è€ƒæ¡ˆä¾‹**:
{context}

è¯·æä¾›ï¼š
1. å¯èƒ½çš„åŸå› åˆ†æ
2. ä¸¥é‡ç¨‹åº¦è¯„ä¼°
3. å¤„ç½®å»ºè®®
4. æ˜¯å¦éœ€è¦ç«‹å³åœè¿

ä»¥Markdownæ ¼å¼è¾“å‡ºã€‚
"""
            
            analysis = await self._generate_with_llm(
                state=state,
                prompt=prompt,
                temperature=0.4
            )
            
            return {
                "answer": analysis,
                "content": analysis,
                "cases": cases
            }
        else:
            # å›é€€åˆ°é€šç”¨åˆ†æ
            return self._fallback_defect_analysis(query)
    
    async def _provide_guidance(self, state: AgentState, query: str) -> Dict[str, Any]:
        """æä¾›å·¡æ£€æŒ‡å¯¼"""
        self._log_thought(state, "action", "æä¾›å·¡æ£€æŒ‡å¯¼")
        
        # è¯†åˆ«è®¾å¤‡ç±»å‹
        equipment = self._parse_equipment(query)
        
        # ä»çŸ¥è¯†åº“æ£€ç´¢å·¡æ£€è§„èŒƒ
        if self.user_id:
            try:
                standard_results = await self._search_knowledge(
                    state=state,
                    query=f"{equipment} å·¡æ£€è§„èŒƒ å·¡æ£€è¦ç‚¹",
                    top_k=3
                )
                standards = self._extract_documents_from_tool_results(standard_results)
            except Exception as e:
                logger.warning(f"Knowledge search failed: {e}")
                standards = []
        else:
            standards = []
        
        # ç”Ÿæˆå·¡æ£€æŒ‡å¯¼
        guidance = self._format_patrol_guidance(equipment, standards)
        
        return {
            "answer": guidance,
            "content": guidance,
            "equipment": equipment,
            "standards": standards
        }
    
    async def _generate_report(self, state: AgentState, query: str) -> Dict[str, Any]:
        """ç”Ÿæˆå·¡æ£€æŠ¥å‘Š"""
        self._log_thought(state, "action", "ç”Ÿæˆå·¡æ£€æŠ¥å‘Š")
        
        # ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“
        try:
            report = await self.render_with_template(
                state=state,
                template_name="patrol_report.md",
                context={
                    "patrol_date": "å¾…å¡«å†™",
                    "patrol_person": "å¾…å¡«å†™",
                    "equipment": "å¾…å¡«å†™",
                    "findings": [],
                    "conclusion": "å¾…å¡«å†™"
                }
            )
            
            if report:
                return {"answer": report, "content": report}
        except Exception as e:
            logger.warning(f"Template rendering failed: {e}")
        
        # å›é€€åˆ°æ ¼å¼åŒ–è¾“å‡º
        return self._fallback_report()
    
    def _parse_equipment(self, query: str) -> str:
        """è§£æè®¾å¤‡ç±»å‹"""
        if "ä¸»å˜" in query or "å˜å‹å™¨" in query:
            return "ä¸»å˜å‹å™¨"
        elif "æ¯çº¿" in query:
            return "æ¯çº¿"
        elif "å¼€å…³" in query or "æ–­è·¯å™¨" in query:
            return "æ–­è·¯å™¨"
        else:
            return "æœªçŸ¥è®¾å¤‡"
    
    def _build_context(self, cases: List[Dict]) -> str:
        """æ„å»ºä¸Šä¸‹æ–‡"""
        context = ""
        for i, case in enumerate(cases[:3]):
            context += f"{i+1}. {case.get('title', 'æœªçŸ¥')}\n"
            content = case.get('content', '')[:200]
            context += f"   {content}...\n\n"
        return context
    
    def _format_patrol_guidance(self, equipment: str, standards: List[Dict]) -> str:
        """æ ¼å¼åŒ–å·¡æ£€æŒ‡å¯¼"""
        guidance = f"## {equipment}å·¡æ£€æŒ‡å¯¼\n\n"
        
        if standards:
            guidance += "### å·¡æ£€è§„èŒƒ\n\n"
            for std in standards[:2]:
                guidance += f"- {std.get('title', 'æœªçŸ¥')}\n"
                content = std.get('content', '')[:300]
                guidance += f"  {content}...\n\n"
        
        guidance += "### å·¡æ£€è¦ç‚¹\n\n"
        guidance += "1. **å¤–è§‚æ£€æŸ¥**\n"
        guidance += "   - è®¾å¤‡å¤–è§‚æ˜¯å¦å®Œå¥½\n"
        guidance += "   - æ²¹ä½ã€æ²¹è‰²æ˜¯å¦æ­£å¸¸\n"
        guidance += "   - æœ‰æ— æ¸—æ¼æ²¹ç°è±¡\n\n"
        
        guidance += "2. **å£°éŸ³æ£€æŸ¥**\n"
        guidance += "   - è¿è¡Œå£°éŸ³æ˜¯å¦æ­£å¸¸\n"
        guidance += "   - æœ‰æ— å¼‚å¸¸å™ªéŸ³\n\n"
        
        guidance += "3. **æ¸©åº¦æ£€æŸ¥**\n"
        guidance += "   - è®¾å¤‡æ¸©åº¦æ˜¯å¦æ­£å¸¸\n"
        guidance += "   - æœ‰æ— å±€éƒ¨è¿‡çƒ­\n\n"
        
        guidance += "4. **æ°”å‘³æ£€æŸ¥**\n"
        guidance += "   - æœ‰æ— å¼‚å‘³\n"
        guidance += "   - æœ‰æ— ç„¦ç³Šå‘³\n\n"
        
        guidance += "5. **ä»ªè¡¨æ£€æŸ¥**\n"
        guidance += "   - ä»ªè¡¨æŒ‡ç¤ºæ˜¯å¦æ­£å¸¸\n"
        guidance += "   - æœ‰æ— å¼‚å¸¸å‘Šè­¦\n\n"
        
        return guidance
    
    def _fallback_defect_analysis(self, query: str) -> Dict[str, Any]:
        """å›é€€çš„ç¼ºé™·åˆ†æ"""
        analysis = f"""
## è®¾å¤‡å¼‚å¸¸åˆ†æ

**å¼‚å¸¸æè¿°**: {query}

### å¯èƒ½åŸå› 
1. è®¾å¤‡è€åŒ–
2. è¿è¡Œç¯å¢ƒå¼‚å¸¸
3. è´Ÿè½½è¿‡é‡
4. ç»´æŠ¤ä¸å½“

### å¤„ç½®å»ºè®®
1. ç«‹å³æ±‡æŠ¥å€¼ç­é•¿
2. åŠ å¼ºç›‘è§†
3. åšå¥½è®°å½•
4. å¿…è¦æ—¶ç”³è¯·åœè¿æ£€ä¿®

*æ³¨ï¼šä»¥ä¸Šä¸ºé€šç”¨åˆ†æï¼Œå®é™…åº”ç»“åˆç°åœºæƒ…å†µåˆ¤æ–­*
"""
        return {"answer": analysis, "content": analysis}
    
    def _fallback_report(self) -> Dict[str, Any]:
        """å›é€€çš„æŠ¥å‘Šç”Ÿæˆ"""
        report = """
## å·¡æ£€æŠ¥å‘Š

**å·¡æ£€æ—¥æœŸ**: å¾…å¡«å†™
**å·¡æ£€äººå‘˜**: å¾…å¡«å†™
**å·¡æ£€è®¾å¤‡**: å¾…å¡«å†™

### å·¡æ£€æƒ…å†µ
- å¾…å¡«å†™

### å‘ç°é—®é¢˜
- å¾…å¡«å†™

### å¤„ç½®æªæ–½
- å¾…å¡«å†™

### ç»“è®º
- å¾…å¡«å†™
"""
        return {"answer": report, "content": report}
    
    def _extract_documents_from_tool_results(self, tool_results: List[Dict]) -> List[Dict]:
        """ä»å·¥å…·è°ƒç”¨ç»“æœä¸­æå–æ–‡æ¡£"""
        documents = []
        for result in tool_results:
            if isinstance(result, dict) and "result" in result:
                result_data = result["result"]
                if isinstance(result_data, dict) and "documents" in result_data:
                    documents.extend(result_data["documents"])
        return documents
```

#### æ­¥éª¤2: åœ¨ `registry.py` ä¸­æ³¨å†Œ

```python
# aperag/agent/registry.py

from aperag.agent.specialists.patrol_agent import PatrolAgent

def initialize_default_agents(self, llm_service=None, ...):
    # ... ç°æœ‰ä»£ç  ...
    
    # å·¡æ£€ä¸“å®¶ï¼ˆè‡ªå®šä¹‰å®ç°ï¼‰
    self.register(PatrolAgent(llm_service=llm_service))
```

### âœ… å®Œæˆï¼

æ™ºèƒ½ä½“å·²å…·å¤‡ï¼š
- âœ… å®Œå…¨è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘
- âœ… å¤šé˜¶æ®µå¤„ç†æµç¨‹
- âœ… ç‰¹æ®Šçš„å·¥å…·è°ƒç”¨
- âœ… è‡ªå®šä¹‰æ•°æ®å¤„ç†

---

## å‰åç«¯ç»Ÿä¸€é›†æˆ

### å‰ç«¯é›†æˆ

æ™ºèƒ½ä½“æ³¨å†Œåï¼Œå‰ç«¯ä¼šè‡ªåŠ¨è¯†åˆ«ã€‚æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ã€‚

#### éªŒè¯æ–¹å¼

1. **æŸ¥çœ‹æ™ºèƒ½ä½“åˆ—è¡¨**
   ```bash
   # è®¿é—®API
   GET /api/agents
   ```

2. **å‰ç«¯è‡ªåŠ¨å±•ç¤º**
   - æ™ºèƒ½ä½“é€‰æ‹©å™¨ä¼šè‡ªåŠ¨æ˜¾ç¤ºæ–°æ™ºèƒ½ä½“
   - æ”¯æŒåˆ‡æ¢åˆ°æ–°æ™ºèƒ½ä½“è¿›è¡Œå¯¹è¯

### åç«¯é›†æˆ

#### 1. æ™ºèƒ½ä½“è‡ªåŠ¨æ³¨å†Œ

ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œ`AgentRegistry.initialize_default_agents()` ä¼šè‡ªåŠ¨æ³¨å†Œæ‰€æœ‰æ™ºèƒ½ä½“ã€‚

#### 2. APIè‡ªåŠ¨æ”¯æŒ

`AgentChatService` ä¼šè‡ªåŠ¨æ”¯æŒæ–°æ³¨å†Œçš„æ™ºèƒ½ä½“ï¼š

```python
# ç”¨æˆ·é€‰æ‹©æ™ºèƒ½ä½“åï¼Œç³»ç»Ÿè‡ªåŠ¨è·¯ç”±
agent = agent_registry.get_agent(selected_role)
result = await agent.run(state, input_data)
```

#### 3. å…ƒæ•°æ®è‡ªåŠ¨åŠ è½½

ç³»ç»Ÿä¼šè‡ªåŠ¨ä» `agent_configs.py` åŠ è½½å…ƒæ•°æ®ï¼š

```python
# è‡ªåŠ¨åŠ è½½çŸ¥è¯†åº“é…ç½®
collections = agent_registry.get_default_collections(role)

# è‡ªåŠ¨åŠ è½½æç¤ºè¯
system_prompt = agent_registry.get_system_prompt(role)
```

---

## å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: å¿«é€Ÿå®ç°"åŸ¹è®­å¯¼å¸ˆ"æ™ºèƒ½ä½“

**éœ€æ±‚**: å®ç°ä¸€ä¸ªåŸ¹è®­å¯¼å¸ˆæ™ºèƒ½ä½“ï¼Œç”¨äºåŸ¹è®­æ–°å‘˜å·¥

**æ–¹æ¡ˆ**: ä½¿ç”¨æ–¹å¼ä¸€ï¼ˆæç¤ºè¯é©±åŠ¨ï¼‰

```python
# 1. åœ¨ prompts.py ä¸­æ·»åŠ 
AgentRole.INSTRUCTOR: """
ä½ æ˜¯æŠ€èƒ½åŸ¹è®­å¯¼å¸ˆ (Instructor)ã€‚
è´Ÿè´£ä¸ºæ–°å‘˜å·¥è®²è§£è®¾å¤‡åŸç†ã€æ“ä½œæµç¨‹å’Œå®‰å…¨çŸ¥è¯†ã€‚
è¯·ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡ŠæŠ€æœ¯æ¦‚å¿µï¼Œå¹¶æä¾›ç±»æ¯”ã€‚
""",

# 2. åœ¨ registry.py ä¸­æ³¨å†Œ
(AgentRole.INSTRUCTOR, "åŸ¹è®­å¯¼å¸ˆ", "è´Ÿè´£è§£é‡ŠæŠ€æœ¯åŸç†å’ŒåŸ¹è®­"),

# âœ… å®Œæˆï¼5åˆ†é’Ÿæå®š
```

### æ¡ˆä¾‹2: å®ç°"è®¾å¤‡å¥åº·è¯„ä¼°"æ™ºèƒ½ä½“

**éœ€æ±‚**: å®ç°ä¸€ä¸ªè®¾å¤‡å¥åº·è¯„ä¼°æ™ºèƒ½ä½“ï¼Œéœ€è¦è®¿é—®è®¾å¤‡å¥åº·æ•°æ®åº“

**æ–¹æ¡ˆ**: ä½¿ç”¨æ–¹å¼äºŒï¼ˆé…ç½®é©±åŠ¨ï¼‰

```python
# 1. åœ¨ agent_configs.py ä¸­æ·»åŠ å®Œæ•´é…ç½®
HEALTH_ASSESSMENT_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.HEALTH_ASSESSOR,
    name="å¥åº·è¯„ä¼°ä¸“å®¶",
    description="è®¾å¤‡å¥åº·çŠ¶æ€è¯„ä¼°å’Œé¢„æµ‹",
    default_collections=["equipment_health_db", "maintenance_records_db"],
    system_prompt_template="""...""",
    capabilities={"rag", "analysis", "prediction"},
)

# 2. æ·»åŠ åˆ°é…ç½®æ˜ å°„
AGENT_CONFIGS = {
    # ...
    AgentRole.HEALTH_ASSESSOR: HEALTH_ASSESSMENT_AGENT_CONFIG,
}

# 3. åœ¨ registry.py ä¸­æ³¨å†Œ
config = AGENT_CONFIGS.get(AgentRole.HEALTH_ASSESSOR)
agent = PromptDrivenAgent(
    role=AgentRole.HEALTH_ASSESSOR,
    name=config.name,
    description=config.description,
    llm_service=llm_service,
    system_prompt=config.system_prompt_template,
)
self.register(agent, config)

# âœ… å®Œæˆï¼15åˆ†é’Ÿæå®š
```

### æ¡ˆä¾‹3: å®ç°"æ™ºèƒ½è¯Šæ–­"æ™ºèƒ½ä½“

**éœ€æ±‚**: å®ç°ä¸€ä¸ªæ™ºèƒ½è¯Šæ–­æ™ºèƒ½ä½“ï¼Œéœ€è¦å¤æ‚çš„å¤šé˜¶æ®µè¯Šæ–­é€»è¾‘

**æ–¹æ¡ˆ**: ä½¿ç”¨æ–¹å¼ä¸‰ï¼ˆè‡ªå®šä¹‰æ™ºèƒ½ä½“ï¼‰

```python
# 1. åˆ›å»º diagnostic_agent.py
class DiagnosticAgent(BaseAgent):
    async def _execute(self, state, input_data):
        # é˜¶æ®µ1: ç—‡çŠ¶åˆ†æ
        symptoms = await self._analyze_symptoms(state, query)
        
        # é˜¶æ®µ2: åŸå› æ¨æ–­
        causes = await self._infer_causes(state, symptoms)
        
        # é˜¶æ®µ3: æ–¹æ¡ˆç”Ÿæˆ
        solutions = await self._generate_solutions(state, causes)
        
        return self._format_diagnostic_report(symptoms, causes, solutions)

# 2. åœ¨ registry.py ä¸­æ³¨å†Œ
self.register(DiagnosticAgent(llm_service=llm_service))

# âœ… å®Œæˆï¼1å°æ—¶æå®š
```

---

## æ€»ç»“

### ğŸ¯ é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èæ–¹å¼ | å¼€å‘æ—¶é—´ | åŠŸèƒ½ä¸°å¯Œåº¦ |
|------|---------|---------|-----------|
| ç®€å•å¯¹è¯å‹æ™ºèƒ½ä½“ | æ–¹å¼ä¸€ | 5åˆ†é’Ÿ | â­â­ |
| éœ€è¦çŸ¥è¯†åº“æ”¯æŒ | æ–¹å¼äºŒ | 15åˆ†é’Ÿ | â­â­â­â­ |
| å¤æ‚ä¸šåŠ¡é€»è¾‘ | æ–¹å¼ä¸‰ | 1å°æ—¶ | â­â­â­â­â­ |

### âœ… æ ¸å¿ƒä¼˜åŠ¿

1. **é›¶ä¿®æ”¹é€šç”¨ä»£ç **: æ‰€æœ‰æ–°æ™ºèƒ½ä½“éƒ½ä¸éœ€è¦ä¿®æ”¹ `BaseAgent` ç­‰æ ¸å¿ƒä»£ç 
2. **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶å¿«é€Ÿå®šä¹‰æ™ºèƒ½ä½“
3. **æç¤ºè¯é©±åŠ¨**: é€šè¿‡æç¤ºè¯å¿«é€Ÿå®ç°ç®€å•æ™ºèƒ½ä½“
4. **çµæ´»æ‰©å±•**: æ”¯æŒä»ç®€å•åˆ°å¤æ‚çš„æ¸è¿›å¼æ‰©å±•
5. **å‰åç«¯è‡ªåŠ¨é›†æˆ**: æ³¨å†Œåè‡ªåŠ¨åœ¨å‰åç«¯ç”Ÿæ•ˆ

### ğŸš€ å¿«é€Ÿå¼€å§‹

**æœ€å¿«5åˆ†é’Ÿå®ç°ä¸€ä¸ªæ–°æ™ºèƒ½ä½“**:

1. åœ¨ `models.py` æ·»åŠ è§’è‰²æšä¸¾
2. åœ¨ `prompts.py` æ·»åŠ æç¤ºè¯
3. åœ¨ `registry.py` æ·»åŠ åˆ° `generic_roles` åˆ—è¡¨

**å®Œæˆï¼** ğŸ‰

---

## é™„å½•

### A. å®Œæ•´çš„æ™ºèƒ½ä½“è§’è‰²åˆ—è¡¨

```python
class AgentRole(str, Enum):
    # æ ¸å¿ƒè§’è‰²
    SUPERVISOR = "supervisor"          # å€¼ç­é•¿
    ARCHIVIST = "archivist"           # å›¾è°±ä¸“å®¶
    
    # ä¸“ä¸šè§’è‰²
    DETECTIVE = "detective"           # å›¾çº¸ä¾¦æ¢
    GATEKEEPER = "gatekeeper"         # é—¨ç¦ä¸“å®¶
    PROPHET = "prophet"               # é¢„æµ‹ä¸“å®¶
    AUDITOR = "auditor"               # å®¡è®¡ä¸“å®¶
    DIAGNOSTICIAN = "diagnostician"   # æ•…éšœè¯Šæ–­ä¸“å®¶
    INSTRUCTOR = "instructor"         # åŸ¹è®­å¯¼å¸ˆ
    CALCULATOR = "calculator"         # è®¡ç®—ä¸“å®¶
    SCRIBE = "scribe"                 # æ–‡ä¹¦ä¸“å®¶
    SENTINEL = "sentinel"             # å®‰ç›‘å«å£«
    
    # ä¸šåŠ¡è§’è‰²
    OPERATION_TICKET = "operation_ticket"      # æ“ä½œç¥¨ä¸“å®¶
    WORK_PERMIT = "work_permit"                # å·¥ä½œç¥¨ä¸“å®¶
    ACCIDENT_DEDUCTION = "accident_deduction"  # äº‹æ•…é¢„æƒ³ä¸“å®¶
    POWER_GUARANTEE = "power_guarantee"        # ä¿ç”µä¸“å®¶
```

### B. é…ç½®æ¨¡æ¿

```python
YOUR_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.YOUR_ROLE,
    name="æ‚¨çš„æ™ºèƒ½ä½“åç§°",
    description="ç®€çŸ­æè¿°",
    
    default_collections=[
        # "your_knowledge_base_id"
    ],
    
    system_prompt_template="""
æ‚¨çš„ç³»ç»Ÿæç¤ºè¯
""",
    
    query_prompt_template="""
æ‚¨çš„æŸ¥è¯¢æç¤ºè¯æ¨¡æ¿ï¼ˆJinja2æ ¼å¼ï¼‰
""",
    
    file_templates={
        "template_name": "templates/your_template.md"
    },
    
    required_tools=["search_collection"],
    optional_tools=["web_search"],
    
    capabilities={"rag", "your_capability"},
    
    priority=7
)
```

### C. å¸¸è§é—®é¢˜

**Q: æ–°æ™ºèƒ½ä½“å¦‚ä½•åœ¨å‰ç«¯æ˜¾ç¤ºï¼Ÿ**
A: æ³¨å†Œåè‡ªåŠ¨æ˜¾ç¤ºï¼Œæ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ã€‚

**Q: å¦‚ä½•ä¸ºæ™ºèƒ½ä½“é…ç½®ä¸“å±çŸ¥è¯†åº“ï¼Ÿ**
A: åœ¨ `AgentMetadata` çš„ `default_collections` ä¸­é…ç½®çŸ¥è¯†åº“IDã€‚

**Q: å¦‚ä½•è‡ªå®šä¹‰æ™ºèƒ½ä½“çš„è¾“å‡ºæ ¼å¼ï¼Ÿ**
A: ä½¿ç”¨æ–‡ä»¶æ¨¡æ¿ (`file_templates`) æˆ–åœ¨ `_execute` æ–¹æ³•ä¸­è‡ªå®šä¹‰æ ¼å¼åŒ–é€»è¾‘ã€‚

**Q: æ™ºèƒ½ä½“ä¹‹é—´å¦‚ä½•åä½œï¼Ÿ**
A: é€šè¿‡ `SupervisorAgent` è¿›è¡Œåä½œç¼–æ’ï¼Œæˆ–ä½¿ç”¨ `AgentOrchestrator`ã€‚

**Q: å¦‚ä½•è°ƒè¯•æ™ºèƒ½ä½“ï¼Ÿ**
A: æŸ¥çœ‹æ€ç»´é“¾ (`thinking_stream`) å’Œæ—¥å¿—è¾“å‡ºã€‚
