# ä¸“å®¶æ™ºèƒ½ä½“ä¼˜åŒ–å·¥ä½œæ€»ç»“

**ä¼˜åŒ–æ—¶é—´**: 2024-11-25  
**ä¼˜åŒ–èŒƒå›´**: æ“ä½œç¥¨ä¸“å®¶ã€äº‹æ•…é¢„æƒ³ä¸“å®¶ã€ä¿ç”µæ–¹æ¡ˆä¸“å®¶ã€å›¾è°±ä¸“å®¶

---

## âœ… å·²å®Œæˆä¼˜åŒ–

### 1. æ“ä½œç¥¨ä¸“å®¶ (OperationTicketAgent) âœ…

**æ–‡ä»¶**: `aperag/agent/specialists/operation_ticket_agent.py`

**ä¼˜åŒ–å†…å®¹**:
- âœ… é›†æˆRAGæ£€ç´¢ - æ£€ç´¢å†å²æ“ä½œç¥¨å’Œæ“ä½œè§„ç¨‹
- âœ… é›†æˆLLMç”Ÿæˆ - æ™ºèƒ½ç”Ÿæˆæ“ä½œæ­¥éª¤
- âœ… é›†æˆæ¨¡æ¿æ¸²æŸ“ - ä½¿ç”¨ `operation_ticket.md` æ¨¡æ¿
- âœ… æ™ºèƒ½å›é€€æœºåˆ¶ - æ£€ç´¢æˆ–ç”Ÿæˆå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ¨¡æ¿

**æ ¸å¿ƒæµç¨‹**:
```
1. è§£ææ“ä½œç±»å‹
2. æ£€ç´¢çŸ¥è¯†åº“
   - å†å²æ“ä½œç¥¨æ¡ˆä¾‹
   - æ“ä½œè§„ç¨‹å’Œå®‰å…¨è¦æ±‚
3. ä½¿ç”¨LLMç”Ÿæˆæ“ä½œç¥¨æ•°æ®
4. å®‰å…¨æ ¡éªŒ
5. æ¨¡æ¿æ¸²æŸ“è¾“å‡º
```

### 2. äº‹æ•…é¢„æƒ³ä¸“å®¶ (AccidentDeductionAgent) âœ…

**æ–‡ä»¶**: `aperag/agent/specialists/accident_deduction_agent.py`

**ä¼˜åŒ–å†…å®¹**:
- âœ… é›†æˆRAGæ£€ç´¢ - æ£€ç´¢å†å²äº‹æ•…æ¡ˆä¾‹å’Œå¤„ç½®ç»éªŒ
- âœ… é›†æˆLLMç”Ÿæˆ - æ™ºèƒ½ç”Ÿæˆäº‹æ•…æ¨æ¼”æŠ¥å‘Š
- âœ… é›†æˆæ¨¡æ¿æ¸²æŸ“ - ä½¿ç”¨ `accident_deduction_report.md` æ¨¡æ¿
- âœ… æ™ºèƒ½å›é€€æœºåˆ¶ - æ£€ç´¢æˆ–ç”Ÿæˆå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ¨¡æ¿

**æ ¸å¿ƒæµç¨‹**:
```
1. è¯†åˆ«è®¾å¤‡å’Œäº‹æ•…åœºæ™¯
2. æ£€ç´¢çŸ¥è¯†åº“
   - å†å²äº‹æ•…æ¡ˆä¾‹ï¼ˆtop_k=5ï¼‰
   - äº‹æ•…å¤„ç½®ç»éªŒï¼ˆtop_k=3ï¼‰
3. ä½¿ç”¨LLMç”Ÿæˆäº‹æ•…æ¨æ¼”æ•°æ®
   - æ¨æ¼”æ­¥éª¤
   - åœç”µèŒƒå›´
   - åº”æ€¥æªæ–½
   - æ¢å¤è®¡åˆ’
4. æ¨¡æ¿æ¸²æŸ“è¾“å‡º
```

**ç”Ÿæˆçš„æ•°æ®ç»“æ„**:
```json
{
    "report_no": "AD-YYYY-MMDD-NNN",
    "deduction_date": "æ¨æ¼”æ—¥æœŸ",
    "fault_time": "å‡è®¾æ•…éšœæ—¶é—´",
    "initial_phenomenon": "åˆå§‹ç°è±¡",
    "deduction_steps": [...],
    "outage_scope": [...],
    "immediate_actions": [...],
    "isolation_steps": [...],
    "recovery_plan": [...],
    "insights": [...],
    "conclusion": "æ¨æ¼”ç»“è®º"
}
```

### 3. ä¿ç”µæ–¹æ¡ˆä¸“å®¶ (PowerGuaranteeAgent) ğŸ“‹

**æ–‡ä»¶**: `aperag/agent/specialists/power_guarantee_agent.py`

**è®¡åˆ’ä¼˜åŒ–**:
- ğŸ“‹ é›†æˆRAGæ£€ç´¢ - æ£€ç´¢å†å²ä¿ç”µæ–¹æ¡ˆ
- ğŸ“‹ é›†æˆLLMç”Ÿæˆ - æ™ºèƒ½ç”Ÿæˆä¿ç”µæ–¹æ¡ˆ
- ğŸ“‹ é›†æˆæ¨¡æ¿æ¸²æŸ“ - ä½¿ç”¨ `power_guarantee_plan.md` æ¨¡æ¿

**è®¡åˆ’æµç¨‹**:
```
1. è¯†åˆ«æ´»åŠ¨ç±»å‹å’Œé‡è¦ç­‰çº§
2. æ£€ç´¢çŸ¥è¯†åº“
   - å†å²ä¿ç”µæ–¹æ¡ˆ
   - ä¾›ç”µå¯é æ€§è¦æ±‚
3. ä½¿ç”¨LLMç”Ÿæˆä¿ç”µæ–¹æ¡ˆ
   - ä¾›ç”µåˆ†æ
   - é£é™©è¯„ä¼°
   - ä¿ç”µæªæ–½
   - åº”æ€¥é¢„æ¡ˆ
4. æ¨¡æ¿æ¸²æŸ“è¾“å‡º
```

### 4. å›¾è°±ä¸“å®¶ (ArchivistAgent) ğŸ“‹

**æ–‡ä»¶**: `aperag/agent/specialists/archivist.py`

**è®¡åˆ’ä¼˜åŒ–**:
- ğŸ“‹ å¢å¼ºçŸ¥è¯†åº“æ£€ç´¢èƒ½åŠ›
- ğŸ“‹ æ”¯æŒå›¾è°±éå†
- ğŸ“‹ ç»“æ„åŒ–è¾“å‡º

---

## ğŸ”§ ä¼˜åŒ–æ¨¡å¼

æ‰€æœ‰ä¸“å®¶æ™ºèƒ½ä½“éµå¾ªç»Ÿä¸€çš„ä¼˜åŒ–æ¨¡å¼ï¼š

### æ ‡å‡†ä¼˜åŒ–æµç¨‹

```python
async def _execute_task(self, state, query):
    """æ ‡å‡†æ‰§è¡Œæµç¨‹"""
    
    # 1. è§£æä»»åŠ¡å‚æ•°
    params = self._parse_task(query)
    
    # 2. æ£€ç´¢çŸ¥è¯†åº“ï¼ˆå¦‚æœæœ‰MCPä¼šè¯ï¼‰
    knowledge = []
    if self.user_id:
        try:
            results = await self._search_knowledge(
                state=state,
                query=f"{params} ç›¸å…³å†…å®¹",
                top_k=5
            )
            knowledge = self._extract_documents_from_tool_results(results)
        except Exception as e:
            logger.warning(f"Knowledge search failed: {e}")
    
    # 3. æ„å»ºä¸Šä¸‹æ–‡
    context = self._build_context(knowledge)
    
    # 4. ä½¿ç”¨LLMç”Ÿæˆï¼ˆå¦‚æœæœ‰MCPä¼šè¯å’Œä¸Šä¸‹æ–‡ï¼‰
    data = None
    if self.user_id and context:
        try:
            prompt = self._build_prompt(params, context)
            generated_json = await self._generate_with_llm(
                state=state,
                prompt=prompt,
                temperature=0.5
            )
            data = json.loads(generated_json)
        except Exception as e:
            logger.warning(f"LLM generation failed: {e}")
    
    # 5. å›é€€åˆ°é»˜è®¤æ¨¡æ¿
    if not data:
        data = self._create_default_template(params)
    
    # 6. æ¨¡æ¿æ¸²æŸ“
    try:
        rendered = await self.render_with_template(
            state=state,
            template_name="template.md",
            context=data
        )
        if rendered:
            return {"answer": rendered, "data": data}
    except Exception as e:
        logger.warning(f"Template rendering failed: {e}")
    
    # 7. å›é€€åˆ°æ ¼å¼åŒ–è¾“å‡º
    return {
        "answer": self._format_output(data),
        "data": data
    }
```

### å…³é”®è¾…åŠ©æ–¹æ³•

```python
def _extract_documents_from_tool_results(self, tool_results):
    """ä»å·¥å…·è°ƒç”¨ç»“æœä¸­æå–æ–‡æ¡£"""
    documents = []
    for result in tool_results:
        if isinstance(result, dict) and "result" in result:
            result_data = result["result"]
            if isinstance(result_data, dict) and "documents" in result_data:
                documents.extend(result_data["documents"])
    return documents

def _build_context(self, documents):
    """æ„å»ºä¸Šä¸‹æ–‡"""
    if not documents:
        return ""
    
    context = "## å‚è€ƒèµ„æ–™\n\n"
    for i, doc in enumerate(documents):
        title = doc.get('title', 'æœªçŸ¥')
        content = doc.get('content', '')[:300]
        context += f"{i+1}. **{title}**\n"
        context += f"   {content}...\n\n"
    
    return context

def _build_prompt(self, params, context):
    """æ„å»ºLLMæç¤ºè¯"""
    return f"""
è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰ï¼š

**å‚æ•°**: {params}

{context}

è¯·ç”ŸæˆåŒ…å«ä»¥ä¸‹å­—æ®µçš„JSONå¯¹è±¡ï¼š
{{
    "field1": "value1",
    "field2": "value2"
}}

è¦æ±‚ï¼š
1. æ•°æ®å®Œæ•´å‡†ç¡®
2. å‚è€ƒå†å²æ¡ˆä¾‹
3. åªè¾“å‡ºJSON

JSONè¾“å‡ºï¼š
"""
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| çŸ¥è¯†åº“æ£€ç´¢ | âŒ æ—  | âœ… æ”¯æŒ |
| LLMç”Ÿæˆ | âŒ æ—  | âœ… æ”¯æŒ |
| æ¨¡æ¿æ¸²æŸ“ | âŒ æ—  | âœ… æ”¯æŒ |
| å†å²æ¡ˆä¾‹å­¦ä¹  | âŒ æ—  | âœ… æ”¯æŒ |
| æ™ºèƒ½å›é€€ | âŒ æ—  | âœ… æ”¯æŒ |
| æ€ç»´é“¾è®°å½• | âš ï¸ éƒ¨åˆ† | âœ… å®Œæ•´ |

### è¾“å‡ºè´¨é‡

**ä¼˜åŒ–å‰**:
- ä½¿ç”¨ç¡¬ç¼–ç çš„æ¨¡æ¿
- å›ºå®šçš„å†…å®¹
- æ— æ³•å­¦ä¹ å†å²ç»éªŒ

**ä¼˜åŒ–å**:
- åŸºäºå†å²æ¡ˆä¾‹ç”Ÿæˆ
- LLMæ™ºèƒ½ç”Ÿæˆå†…å®¹
- æ ‡å‡†åŒ–æ¨¡æ¿è¾“å‡º
- å®Œæ•´çš„æ¨ç†è¿‡ç¨‹

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸ (æœ¬å‘¨)

1. **å®Œæˆä¿ç”µæ–¹æ¡ˆä¸“å®¶ä¼˜åŒ–** ğŸ“‹
   - é›†æˆRAGæ£€ç´¢
   - é›†æˆLLMç”Ÿæˆ
   - ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“

2. **å®Œæˆå›¾è°±ä¸“å®¶ä¼˜åŒ–** ğŸ“‹
   - å¢å¼ºæ£€ç´¢èƒ½åŠ›
   - æ”¯æŒå›¾è°±éå†
   - ç»“æ„åŒ–è¾“å‡º

3. **ä¼˜åŒ–å·¥ä½œç¥¨ä¸“å®¶** ğŸ“‹
   - å‚è€ƒæ“ä½œç¥¨ä¸“å®¶çš„ä¼˜åŒ–æ–¹å¼
   - é›†æˆå·¥å…·è°ƒç”¨èƒ½åŠ›

### ä¸­æœŸ (ä¸‹å‘¨)

4. **ä¼˜åŒ–å…¶ä»–ä¸“å®¶æ™ºèƒ½ä½“**
   - å›¾çº¸ä¾¦æ¢
   - é—¨ç¦ä¸“å®¶
   - é¢„æµ‹ä¸“å®¶
   - ç­‰...

5. **åˆ›å»ºæµ‹è¯•ç”¨ä¾‹**
   - ä¸ºæ¯ä¸ªä¸“å®¶åˆ›å»ºæµ‹è¯•
   - éªŒè¯å·¥å…·è°ƒç”¨
   - æ€§èƒ½æµ‹è¯•

### é•¿æœŸ (æœ¬æœˆ)

6. **APIæ¥å£å¼€å‘**
   - åˆ›å»ºç»Ÿä¸€çš„è°ƒç”¨æ¥å£
   - æ”¯æŒå‚æ•°é…ç½®
   - å‰ç«¯é›†æˆ

7. **æ™ºèƒ½ä½“åä½œ**
   - å®ç°å¤šæ™ºèƒ½ä½“ååŒ
   - ä»»åŠ¡åˆ†è§£å’Œè°ƒåº¦
   - ç»“æœæ•´åˆ

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€çš„ä»£ç ç»“æ„

æ‰€æœ‰ä¸“å®¶æ™ºèƒ½ä½“åº”éµå¾ªç›¸åŒçš„ä»£ç ç»“æ„ï¼š
- `_execute()` - ä»»åŠ¡åˆ†å‘
- `_generate_xxx()` - ä¸»è¦ç”Ÿæˆæ–¹æ³•
- `_parse_xxx()` - å‚æ•°è§£æ
- `_extract_documents_from_tool_results()` - æ–‡æ¡£æå–
- `_build_context()` - ä¸Šä¸‹æ–‡æ„å»º
- `_build_prompt()` - æç¤ºè¯æ„å»º
- `_create_default_template()` - é»˜è®¤æ¨¡æ¿
- `_format_output()` - æ ¼å¼åŒ–è¾“å‡º

### 2. é”™è¯¯å¤„ç†

```python
# å¤šå±‚é”™è¯¯å¤„ç†
try:
    # å°è¯•ä½¿ç”¨MCP
    results = await self._search_knowledge(...)
except Exception as e:
    logger.warning(f"Fallback: {e}")
    # å›é€€åˆ°é»˜è®¤
    results = []

# æ•°æ®éªŒè¯
if not data:
    data = self._create_default_template()

# æ¨¡æ¿æ¸²æŸ“å¤±è´¥å›é€€
try:
    rendered = await self.render_with_template(...)
except Exception as e:
    rendered = self._format_output(data)
```

### 3. æ€ç»´é“¾è®°å½•

```python
# è®°å½•æ¯ä¸ªå…³é”®æ­¥éª¤
self._log_thought(state, "action", "æ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“...")
self._log_thought(state, "observation", f"æ£€ç´¢åˆ° {len(results)} æ¡æ–‡æ¡£")
self._log_thought(state, "action", "æ­£åœ¨ä½¿ç”¨LLMç”Ÿæˆ...")
self._log_thought(state, "observation", "ç”Ÿæˆå®Œæˆ")
```

### 4. å‚æ•°é…ç½®

```python
# å¯é…ç½®çš„å‚æ•°
if self.user_id:  # åªæœ‰è®¾ç½®äº†user_idæ‰ä½¿ç”¨MCP
    results = await self._search_knowledge(
        state=state,
        query=query,
        top_k=5,  # å¯é…ç½®
        model_provider="siliconflow",  # å¯é…ç½®
        temperature=0.5  # å¯é…ç½®
    )
```

---

## ğŸ“ˆ è¿›åº¦ç»Ÿè®¡

| æ™ºèƒ½ä½“ | ä¼˜åŒ–çŠ¶æ€ | å®Œæˆåº¦ |
|--------|----------|--------|
| æ“ä½œç¥¨ä¸“å®¶ | âœ… å®Œæˆ | 100% |
| äº‹æ•…é¢„æƒ³ä¸“å®¶ | âœ… å®Œæˆ | 100% |
| ä¿ç”µæ–¹æ¡ˆä¸“å®¶ | ğŸ“‹ è®¡åˆ’ä¸­ | 0% |
| å›¾è°±ä¸“å®¶ | ğŸ“‹ è®¡åˆ’ä¸­ | 0% |
| å·¥ä½œç¥¨ä¸“å®¶ | ğŸ“‹ å¾…å¼€å§‹ | 0% |
| å…¶ä»–ä¸“å®¶ | ğŸ“‹ å¾…å¼€å§‹ | 0% |

**æ€»ä½“è¿›åº¦**: çº¦ 15% (2/13)

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–æˆåŠŸå®ç°äº†ï¼š

1. **æ“ä½œç¥¨ä¸“å®¶** - é¦–ä¸ªå®Œæ•´é›†æˆçš„ä¸“å®¶æ™ºèƒ½ä½“
2. **äº‹æ•…é¢„æƒ³ä¸“å®¶** - ç¬¬äºŒä¸ªå®Œæ•´é›†æˆçš„ä¸“å®¶æ™ºèƒ½ä½“
3. **ç»Ÿä¸€çš„ä¼˜åŒ–æ¨¡å¼** - å¯å¤ç”¨çš„ä¼˜åŒ–æµç¨‹
4. **å®Œæ•´çš„å·¥å…·è°ƒç”¨** - RAGæ£€ç´¢ã€LLMç”Ÿæˆã€æ¨¡æ¿æ¸²æŸ“

**ä¸‹ä¸€æ­¥**: ç»§ç»­ä¼˜åŒ–ä¿ç”µæ–¹æ¡ˆä¸“å®¶å’Œå›¾è°±ä¸“å®¶ï¼

---

**çŠ¶æ€**: ğŸš€ **è¿›å±•é¡ºåˆ©ï¼ŒæŒ‰è®¡åˆ’æ¨è¿›ï¼**
