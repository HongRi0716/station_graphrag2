# æ™ºèƒ½ä½“æ¶æ„åˆ†æä¸ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•
1. [ç°æœ‰æ¶æ„åˆ†æ](#ç°æœ‰æ¶æ„åˆ†æ)
2. [æ ¸å¿ƒé—®é¢˜è¯†åˆ«](#æ ¸å¿ƒé—®é¢˜è¯†åˆ«)
3. [ç»Ÿä¸€æ¶æ„è®¾è®¡æ–¹æ¡ˆ](#ç»Ÿä¸€æ¶æ„è®¾è®¡æ–¹æ¡ˆ)
4. [æ™ºèƒ½ä½“æ³¨å†Œä¼˜åŒ–](#æ™ºèƒ½ä½“æ³¨å†Œä¼˜åŒ–)
5. [æ™ºèƒ½ä½“è°ƒç”¨ä¼˜åŒ–](#æ™ºèƒ½ä½“è°ƒç”¨ä¼˜åŒ–)
6. [å®æ–½è·¯çº¿å›¾](#å®æ–½è·¯çº¿å›¾)

---

## ç°æœ‰æ¶æ„åˆ†æ

### 1. å½“å‰æ™ºèƒ½ä½“ç³»ç»Ÿç»„æˆ

#### 1.1 æ ¸å¿ƒæœåŠ¡å±‚
- **AgentChatService** (`aperag/service/agent_chat_service.py`)
  - è´Ÿè´£WebSocketé€šä¿¡å’Œæ¶ˆæ¯å¤„ç†
  - é›†æˆRAGæ£€ç´¢ã€ç½‘ç»œæœç´¢ã€æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
  - ä½¿ç”¨MCP (Model Context Protocol) è¿›è¡Œå·¥å…·è°ƒç”¨
  - æ”¯æŒè‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯å’ŒæŸ¥è¯¢æç¤ºè¯æ¨¡æ¿

#### 1.2 æ™ºèƒ½ä½“æ³¨å†Œä¸ç®¡ç†
- **AgentRegistry** (`aperag/agent/registry.py`)
  - å•ä¾‹æ¨¡å¼çš„IoCå®¹å™¨
  - ç®¡ç†æ‰€æœ‰ä¸“å®¶æ™ºèƒ½ä½“å®ä¾‹
  - æ”¯æŒåŠ¨æ€æ³¨å†Œå’ŒæŸ¥è¯¢

#### 1.3 æ™ºèƒ½ä½“åŸºç±»æ¶æ„
```
BaseAgent (æŠ½è±¡åŸºç±»)
â”œâ”€â”€ ArchivistAgent (å›¾è°±ä¸“å®¶ - æ£€ç´¢)
â”œâ”€â”€ CalculatorAgent (è®¡ç®—ä¸“å®¶)
â”œâ”€â”€ ScribeAgent (æ–‡ä¹¦ä¸“å®¶)
â”œâ”€â”€ DetectiveAgent (å›¾çº¸ä¾¦æ¢ - è§†è§‰)
â”œâ”€â”€ GatekeeperAgent (é—¨ç¦ä¸“å®¶)
â”œâ”€â”€ ProphetAgent (é¢„æµ‹ä¸“å®¶)
â”œâ”€â”€ AuditorAgent (å®¡è®¡ä¸“å®¶)
â”œâ”€â”€ OperationTicketAgent (æ“ä½œç¥¨ä¸“å®¶)
â”œâ”€â”€ WorkPermitAgent (å·¥ä½œç¥¨ä¸“å®¶)
â”œâ”€â”€ AccidentDeductionAgent (äº‹æ•…æ¨æ¼”ä¸“å®¶)
â”œâ”€â”€ PowerGuaranteeAgent (ä¿ç”µä¸“å®¶)
â””â”€â”€ PromptDrivenAgent (é€šç”¨æç¤ºè¯é©±åŠ¨æ™ºèƒ½ä½“)
    â”œâ”€â”€ Diagnostician (æ•…éšœè¯Šæ–­ä¸“å®¶)
    â”œâ”€â”€ Instructor (åŸ¹è®­å¯¼å¸ˆ)
    â””â”€â”€ Sentinel (å®‰ç›‘å«å£«)
```

#### 1.4 é…ç½®ä¸æç¤ºè¯ç®¡ç†
- **AgentConfig** - ä¼šè¯é…ç½®ç®¡ç†
- **PromptTemplateService** - æç¤ºè¯æ¨¡æ¿æœåŠ¡
  - ç³»ç»Ÿæç¤ºè¯ (System Prompt)
  - æŸ¥è¯¢æç¤ºè¯ (Query Prompt)
  - æ”¯æŒä¸­è‹±æ–‡åŒè¯­
  - æ”¯æŒJinja2æ¨¡æ¿æ¸²æŸ“

### 2. ç°æœ‰åŠŸèƒ½ç‰¹æ€§

#### 2.1 AgentChatService æ ¸å¿ƒåŠŸèƒ½
```python
# 1. RAGæ£€ç´¢
- æ”¯æŒå¤šçŸ¥è¯†åº“æ£€ç´¢ (collections)
- å‘é‡æœç´¢ + å›¾è°±æœç´¢æ··åˆæ¨¡å¼
- æ–‡ä»¶ä¸Šä¼ ä¸å…³è”

# 2. ç½‘ç»œæœç´¢
- å¯é€‰å¯ç”¨/ç¦ç”¨
- å¤šå¼•æ“æœç´¢æ”¯æŒ
- ç½‘é¡µå†…å®¹æå–

# 3. è‡ªå®šä¹‰æç¤ºè¯
- ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿ (system_prompt_template)
- æŸ¥è¯¢æç¤ºè¯æ¨¡æ¿ (query_prompt_template)
- æ”¯æŒJinja2åŠ¨æ€æ¸²æŸ“

# 4. æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„
- ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
- æµå¼å“åº”æ”¯æŒ
- å·¥å…·è°ƒç”¨è¿½è¸ª
```

#### 2.2 æ™ºèƒ½ä½“ä¸“å®¶ç‰¹æ€§
```python
# æ¯ä¸ªä¸“å®¶éƒ½æœ‰:
- role: AgentRole (è§’è‰²æšä¸¾)
- name: ä¸­æ–‡åç§°
- description: èŒè´£æè¿°
- tools: å¯ç”¨å·¥å…·åˆ—è¡¨
- _execute(): æ ¸å¿ƒæ‰§è¡Œé€»è¾‘
- _log_thought(): æ€ç»´é“¾è®°å½•
```

---

## æ ¸å¿ƒé—®é¢˜è¯†åˆ«

### é—®é¢˜1: æ¶æ„ä¸ç»Ÿä¸€
**ç°çŠ¶:**
- `AgentChatService` ä½¿ç”¨MCPå·¥å…·è°ƒç”¨æ¶æ„
- `AgentRegistry` ä¸­çš„ä¸“å®¶ä½¿ç”¨ç‹¬ç«‹çš„æ‰§è¡Œæ¶æ„
- ä¸¤å¥—ç³»ç»Ÿæ²¡æœ‰æ‰“é€š

**å½±å“:**
- æ— æ³•åœ¨AgentChatServiceä¸­è°ƒç”¨Registryä¸­çš„ä¸“å®¶
- ä¸“å®¶èƒ½åŠ›æ— æ³•è¢«MCPå·¥å…·ç³»ç»Ÿåˆ©ç”¨
- ä»£ç é‡å¤ï¼Œç»´æŠ¤å›°éš¾

### é—®é¢˜2: æç¤ºè¯ç®¡ç†åˆ†æ•£
**ç°çŠ¶:**
- `aperag/agent/prompts.py` - ä¸“å®¶è§’è‰²æç¤ºè¯
- `aperag/service/prompt_template_service.py` - AgentæœåŠ¡æç¤ºè¯
- ä¸¤å¥—æç¤ºè¯ç³»ç»Ÿç‹¬ç«‹å­˜åœ¨

**å½±å“:**
- æç¤ºè¯é‡å¤å®šä¹‰
- éš¾ä»¥ç»Ÿä¸€ç®¡ç†å’Œä¼˜åŒ–
- ç¼ºä¹ç‰ˆæœ¬æ§åˆ¶

### é—®é¢˜3: çŸ¥è¯†åº“ç»‘å®šä¸çµæ´»
**ç°çŠ¶:**
- çŸ¥è¯†åº“é…ç½®åœ¨Bot Configä¸­
- æ¯ä¸ªæ™ºèƒ½ä½“æ— æ³•ç»‘å®šä¸“å±çŸ¥è¯†åº“
- æ— æ³•å®ç°"æ“ä½œç¥¨ä¸“å®¶åªæŸ¥æ“ä½œç¥¨çŸ¥è¯†åº“"çš„åœºæ™¯

**å½±å“:**
- æ£€ç´¢ç²¾åº¦ä¸‹é™
- æ— æ³•å®ç°é¢†åŸŸä¸“å®¶åŒ–
- èµ„æºæµªè´¹

### é—®é¢˜4: æ–‡ä»¶æ¨¡æ¿ç¼ºå¤±
**ç°çŠ¶:**
- æ“ä½œç¥¨ã€å·¥ä½œç¥¨ç­‰ä¸“å®¶æœ‰ç”Ÿæˆèƒ½åŠ›
- ä½†æ²¡æœ‰æ ‡å‡†åŒ–çš„æ–‡ä»¶æ¨¡æ¿ç³»ç»Ÿ
- è¾“å‡ºæ ¼å¼ä¸ç»Ÿä¸€

**å½±å“:**
- ç”Ÿæˆç»“æœä¸è§„èŒƒ
- éš¾ä»¥é›†æˆåˆ°ä¸šåŠ¡ç³»ç»Ÿ
- ç”¨æˆ·ä½“éªŒå·®

---

## ç»Ÿä¸€æ¶æ„è®¾è®¡æ–¹æ¡ˆ

### 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ WebSocket å±‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AgentChatService (ç»Ÿä¸€å…¥å£)                      â”‚
â”‚  - WebSocket æ¶ˆæ¯å¤„ç†                                         â”‚
â”‚  - æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†                                               â”‚
â”‚  - ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AgentOrchestrator (æ™ºèƒ½ä½“ç¼–æ’å™¨)                    â”‚
â”‚  - æ™ºèƒ½ä½“è·¯ç”±ä¸è°ƒåº¦                                           â”‚
â”‚  - å¤šæ™ºèƒ½ä½“åä½œ                                               â”‚
â”‚  - ä¸Šä¸‹æ–‡ç®¡ç†                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AgentRegistry   â”‚                  â”‚  MCP Tool System â”‚
â”‚  (ä¸“å®¶æ³¨å†Œä¸­å¿ƒ)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  (å·¥å…·è°ƒç”¨ç³»ç»Ÿ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸“å®¶æ™ºèƒ½ä½“å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ“ä½œç¥¨ä¸“å®¶    â”‚  â”‚ å·¥ä½œç¥¨ä¸“å®¶    â”‚  â”‚ å›¾è°±ä¸“å®¶      â”‚  â”‚
â”‚  â”‚ + ä¸“å±çŸ¥è¯†åº“  â”‚  â”‚ + ä¸“å±çŸ¥è¯†åº“  â”‚  â”‚ + ä¸“å±çŸ¥è¯†åº“  â”‚  â”‚
â”‚  â”‚ + æ–‡ä»¶æ¨¡æ¿    â”‚  â”‚ + æ–‡ä»¶æ¨¡æ¿    â”‚  â”‚              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                   â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¡€æœåŠ¡å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ RAGæ£€ç´¢æœåŠ¡   â”‚  â”‚ ç½‘ç»œæœç´¢æœåŠ¡  â”‚  â”‚ æ¨¡æ¿æ¸²æŸ“æœåŠ¡  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒè®¾è®¡åŸåˆ™

#### 2.1 å•ä¸€èŒè´£åŸåˆ™
- **AgentChatService**: åªè´Ÿè´£é€šä¿¡å’Œæ¶ˆæ¯æµ
- **AgentOrchestrator**: åªè´Ÿè´£æ™ºèƒ½ä½“ç¼–æ’
- **AgentRegistry**: åªè´Ÿè´£æ™ºèƒ½ä½“æ³¨å†Œå’ŒæŸ¥è¯¢
- **BaseAgent**: åªè´Ÿè´£æ‰§è¡Œé€»è¾‘

#### 2.2 ä¾èµ–æ³¨å…¥åŸåˆ™
- æ‰€æœ‰æœåŠ¡é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥
- é…ç½®é€šè¿‡AgentConfigä¼ é€’
- é¿å…ç¡¬ç¼–ç ä¾èµ–

#### 2.3 å¼€é—­åŸåˆ™
- æ–°å¢æ™ºèƒ½ä½“æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- é€šè¿‡é…ç½®å’Œæ³¨å†Œæœºåˆ¶æ‰©å±•
- æç¤ºè¯å’Œæ¨¡æ¿å¤–éƒ¨åŒ–

---

## æ™ºèƒ½ä½“æ³¨å†Œä¼˜åŒ–

### 1. å¢å¼ºçš„AgentRegistryè®¾è®¡

```python
# aperag/agent/registry_v2.py

from typing import Dict, List, Optional, Set
from dataclasses import dataclass
from aperag.agent.core.base import BaseAgent
from aperag.agent.core.models import AgentRole

@dataclass
class AgentMetadata:
    """æ™ºèƒ½ä½“å…ƒæ•°æ®"""
    role: AgentRole
    name: str
    description: str
    
    # æ–°å¢: ä¸“å±çŸ¥è¯†åº“é…ç½®
    default_collections: List[str] = None  # çŸ¥è¯†åº“IDåˆ—è¡¨
    
    # æ–°å¢: æç¤ºè¯é…ç½®
    system_prompt_template: str = None
    query_prompt_template: str = None
    
    # æ–°å¢: æ–‡ä»¶æ¨¡æ¿é…ç½®
    file_templates: Dict[str, str] = None  # {æ¨¡æ¿å: æ¨¡æ¿è·¯å¾„}
    
    # æ–°å¢: å·¥å…·é…ç½®
    required_tools: List[str] = None  # å¿…éœ€å·¥å…·åˆ—è¡¨
    optional_tools: List[str] = None  # å¯é€‰å·¥å…·åˆ—è¡¨
    
    # æ–°å¢: èƒ½åŠ›æ ‡ç­¾
    capabilities: Set[str] = None  # {"rag", "vision", "calculation", "generation"}
    
    # æ–°å¢: ä¼˜å…ˆçº§
    priority: int = 0  # ç”¨äºå¤šæ™ºèƒ½ä½“åä½œæ—¶çš„è°ƒåº¦


class EnhancedAgentRegistry:
    """å¢å¼ºçš„æ™ºèƒ½ä½“æ³¨å†Œä¸­å¿ƒ"""
    
    def __init__(self):
        self._agents: Dict[AgentRole, BaseAgent] = {}
        self._metadata: Dict[AgentRole, AgentMetadata] = {}
        self._capability_index: Dict[str, List[AgentRole]] = {}
        
    def register(
        self, 
        agent: BaseAgent,
        metadata: AgentMetadata = None
    ):
        """
        æ³¨å†Œæ™ºèƒ½ä½“åŠå…¶å…ƒæ•°æ®
        
        Args:
            agent: æ™ºèƒ½ä½“å®ä¾‹
            metadata: æ™ºèƒ½ä½“å…ƒæ•°æ®(å¯é€‰,ä¼šè‡ªåŠ¨ä»agentæå–åŸºç¡€ä¿¡æ¯)
        """
        if metadata is None:
            metadata = AgentMetadata(
                role=agent.role,
                name=agent.name,
                description=agent.description
            )
        
        self._agents[agent.role] = agent
        self._metadata[agent.role] = metadata
        
        # å»ºç«‹èƒ½åŠ›ç´¢å¼•
        if metadata.capabilities:
            for capability in metadata.capabilities:
                if capability not in self._capability_index:
                    self._capability_index[capability] = []
                self._capability_index[capability].append(agent.role)
        
        logger.info(f"Registered agent: {agent.name} with metadata")
    
    def get_agent(self, role: AgentRole) -> Optional[BaseAgent]:
        """è·å–æ™ºèƒ½ä½“å®ä¾‹"""
        return self._agents.get(role)
    
    def get_metadata(self, role: AgentRole) -> Optional[AgentMetadata]:
        """è·å–æ™ºèƒ½ä½“å…ƒæ•°æ®"""
        return self._metadata.get(role)
    
    def find_by_capability(self, capability: str) -> List[BaseAgent]:
        """æ ¹æ®èƒ½åŠ›æŸ¥æ‰¾æ™ºèƒ½ä½“"""
        roles = self._capability_index.get(capability, [])
        return [self._agents[role] for role in roles]
    
    def get_default_collections(self, role: AgentRole) -> List[str]:
        """è·å–æ™ºèƒ½ä½“çš„é»˜è®¤çŸ¥è¯†åº“"""
        metadata = self._metadata.get(role)
        return metadata.default_collections if metadata else []
    
    def get_system_prompt(self, role: AgentRole, language: str = "zh-CN") -> str:
        """è·å–æ™ºèƒ½ä½“çš„ç³»ç»Ÿæç¤ºè¯"""
        metadata = self._metadata.get(role)
        if metadata and metadata.system_prompt_template:
            return metadata.system_prompt_template
        # å›é€€åˆ°é»˜è®¤æç¤ºè¯
        from aperag.service.prompt_template_service import get_agent_system_prompt
        return get_agent_system_prompt(language)
    
    def get_query_prompt_template(self, role: AgentRole, language: str = "zh-CN") -> str:
        """è·å–æ™ºèƒ½ä½“çš„æŸ¥è¯¢æç¤ºè¯æ¨¡æ¿"""
        metadata = self._metadata.get(role)
        if metadata and metadata.query_prompt_template:
            return metadata.query_prompt_template
        # å›é€€åˆ°é»˜è®¤æ¨¡æ¿
        from aperag.service.prompt_template_service import get_default_agent_query_prompt_template
        return get_default_agent_query_prompt_template(language)
    
    def get_file_template(self, role: AgentRole, template_name: str) -> Optional[str]:
        """è·å–æ™ºèƒ½ä½“çš„æ–‡ä»¶æ¨¡æ¿"""
        metadata = self._metadata.get(role)
        if metadata and metadata.file_templates:
            return metadata.file_templates.get(template_name)
        return None


# å…¨å±€å•ä¾‹
enhanced_agent_registry = EnhancedAgentRegistry()
```

### 2. æ™ºèƒ½ä½“æ³¨å†Œé…ç½®åŒ–

```python
# aperag/agent/agent_configs.py

"""æ™ºèƒ½ä½“é…ç½®å®šä¹‰"""

from aperag.agent.core.models import AgentRole
from aperag.agent.registry_v2 import AgentMetadata

# æ“ä½œç¥¨ä¸“å®¶é…ç½®
OPERATION_TICKET_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.OPERATION_TICKET,
    name="æ“ä½œç¥¨ä¸“å®¶",
    description="æ™ºèƒ½ç”Ÿæˆå’Œå®¡æ ¸æ“ä½œç¥¨ï¼Œç¡®ä¿å€’é—¸æ“ä½œçš„å®‰å…¨æ€§å’Œè§„èŒƒæ€§",
    
    # ä¸“å±çŸ¥è¯†åº“
    default_collections=[
        "operation_tickets_db",      # æ“ä½œç¥¨å†å²åº“
        "operation_regulations_db",  # æ“ä½œè§„ç¨‹åº“
        "equipment_topology_db"      # è®¾å¤‡æ‹“æ‰‘åº“
    ],
    
    # ç³»ç»Ÿæç¤ºè¯
    system_prompt_template="""
ä½ æ˜¯å˜ç”µç«™æ“ä½œç¥¨æ™ºèƒ½ç¼–åˆ¶ä¸å®¡æ ¸ä¸“å®¶ã€‚

## æ ¸å¿ƒèŒè´£
1. æ ¹æ®æ“ä½œä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆè§„èŒƒçš„æ“ä½œç¥¨
2. å®¡æ ¸æ“ä½œç¥¨çš„åˆè§„æ€§å’Œå®‰å…¨æ€§
3. ä¼˜åŒ–æ“ä½œæ­¥éª¤é¡ºåºï¼Œæé«˜æ•ˆç‡

## ä¸“ä¸šèƒ½åŠ›
- ç²¾é€šã€Šç”µåŠ›å®‰å…¨å·¥ä½œè§„ç¨‹ã€‹å’Œå€’é—¸æ“ä½œæµç¨‹
- ç†Ÿæ‚‰å„ç±»ç”µæ°”è®¾å¤‡çš„æ“ä½œé¡ºåºå’Œå®‰å…¨è¦æ±‚
- æŒæ¡äº”é˜²ç³»ç»Ÿçš„é€»è¾‘å…³ç³»

## å·¥ä½œæµç¨‹
1. è§£ææ“ä½œä»»åŠ¡,è¯†åˆ«æ“ä½œç±»å‹
2. æŸ¥è¯¢è®¾å¤‡æ‹“æ‰‘å’Œå½“å‰è¿è¡ŒçŠ¶æ€
3. ç”Ÿæˆæ“ä½œæ­¥éª¤åºåˆ—
4. æ‰§è¡Œå®‰å…¨æ€§æ£€æŸ¥(äº”é˜²æ ¡éªŒã€é¡ºåºæ ¡éªŒ)
5. æ ¼å¼åŒ–è¾“å‡ºæ ‡å‡†æ“ä½œç¥¨

## è¾“å‡ºè¦æ±‚
- æ­¥éª¤å®Œæ•´ã€é¡ºåºæ­£ç¡®
- å®‰å…¨æªæ–½æ˜ç¡®
- æ ¼å¼è§„èŒƒã€æ˜“äºæ‰§è¡Œ
""",
    
    # æŸ¥è¯¢æç¤ºè¯æ¨¡æ¿
    query_prompt_template="""
**æ“ä½œä»»åŠ¡**: {{ query }}

**çŸ¥è¯†åº“ä¸Šä¸‹æ–‡**:
{% if collections %}
ä¼˜å…ˆæœç´¢ä»¥ä¸‹çŸ¥è¯†åº“:
{% for c in collections %}
- {{ c.title }} (ID: {{ c.id }})
{% endfor %}
{% endif %}

**æ‰§è¡ŒæŒ‡ä»¤**:
1. é¦–å…ˆè¯†åˆ«æ“ä½œç±»å‹(è½¬å†·å¤‡ç”¨/è½¬çƒ­å¤‡ç”¨/æŠ•è¿/å€’é—¸ç­‰)
2. æŸ¥è¯¢ç›¸å…³è®¾å¤‡çš„æ‹“æ‰‘å…³ç³»å’Œå½“å‰çŠ¶æ€
3. æ£€ç´¢ç±»ä¼¼æ“ä½œçš„å†å²ç¥¨æ®ä½œä¸ºå‚è€ƒ
4. æŸ¥è¯¢ç›¸å…³çš„æ“ä½œè§„ç¨‹å’Œå®‰å…¨è¦æ±‚
5. ç”Ÿæˆå®Œæ•´çš„æ“ä½œç¥¨,åŒ…æ‹¬:
   - æ“ä½œå‰ææ¡ä»¶
   - è¯¦ç»†æ“ä½œæ­¥éª¤(å«å®‰å…¨æ³¨æ„äº‹é¡¹)
   - å®‰å…¨æ€§æ£€æŸ¥ç»“æœ
6. ä½¿ç”¨Markdownæ ¼å¼è¾“å‡º,ç»“æ„æ¸…æ™°

è¯·åŸºäºçŸ¥è¯†åº“å†…å®¹ç”Ÿæˆä¸“ä¸šçš„æ“ä½œç¥¨ã€‚
""",
    
    # æ–‡ä»¶æ¨¡æ¿
    file_templates={
        "operation_ticket": "templates/operation_ticket.md",
        "safety_checklist": "templates/safety_checklist.md"
    },
    
    # å·¥å…·é…ç½®
    required_tools=["search_collection", "create_diagram"],
    optional_tools=["web_search"],
    
    # èƒ½åŠ›æ ‡ç­¾
    capabilities={"rag", "generation", "validation"},
    
    # ä¼˜å…ˆçº§
    priority=10
)

# å·¥ä½œç¥¨ä¸“å®¶é…ç½®
WORK_PERMIT_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.WORK_PERMIT,
    name="å·¥ä½œç¥¨ä¸“å®¶",
    description="æ™ºèƒ½ç”Ÿæˆå’Œå®¡æ ¸å·¥ä½œç¥¨ï¼Œç¡®ä¿æ£€ä¿®ä½œä¸šçš„å®‰å…¨æ€§",
    
    default_collections=[
        "work_permits_db",
        "safety_regulations_db",
        "equipment_specs_db"
    ],
    
    system_prompt_template="""
ä½ æ˜¯å˜ç”µç«™å·¥ä½œç¥¨æ™ºèƒ½ç¼–åˆ¶ä¸å®¡æ ¸ä¸“å®¶ã€‚

## æ ¸å¿ƒèŒè´£
1. æ ¹æ®æ£€ä¿®ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆå·¥ä½œç¥¨
2. å®¡æ ¸å·¥ä½œç¥¨çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§
3. è¯†åˆ«ä½œä¸šé£é™©å¹¶æå‡ºå®‰å…¨æªæ–½

## ä¸“ä¸šèƒ½åŠ›
- ç²¾é€šã€Šç”µåŠ›å®‰å…¨å·¥ä½œè§„ç¨‹ã€‹ä¸­çš„å·¥ä½œç¥¨åˆ¶åº¦
- ç†Ÿæ‚‰å„ç±»æ£€ä¿®ä½œä¸šçš„å®‰å…¨è¦æ±‚å’Œé£é™©ç‚¹
- æŒæ¡å®‰å…¨æªæ–½çš„é…ç½®åŸåˆ™

## å·¥ä½œæµç¨‹
1. è§£ææ£€ä¿®ä»»åŠ¡,è¯†åˆ«ä½œä¸šç±»å‹
2. æŸ¥è¯¢è®¾å¤‡ä¿¡æ¯å’Œå†å²æ£€ä¿®è®°å½•
3. è¯†åˆ«ä½œä¸šé£é™©ç‚¹
4. é…ç½®å®‰å…¨æªæ–½(åœç”µèŒƒå›´ã€æ¥åœ°çº¿ã€å›´æ ç­‰)
5. ç”Ÿæˆæ ‡å‡†å·¥ä½œç¥¨

## è¾“å‡ºè¦æ±‚
- å·¥ä½œèŒƒå›´æ˜ç¡®
- å®‰å…¨æªæ–½å®Œå¤‡
- é£é™©è¯†åˆ«å‡†ç¡®
""",
    
    query_prompt_template="""
**æ£€ä¿®ä»»åŠ¡**: {{ query }}

**çŸ¥è¯†åº“ä¸Šä¸‹æ–‡**:
{% if collections %}
ä¼˜å…ˆæœç´¢ä»¥ä¸‹çŸ¥è¯†åº“:
{% for c in collections %}
- {{ c.title }}
{% endfor %}
{% endif %}

**æ‰§è¡ŒæŒ‡ä»¤**:
1. è¯†åˆ«æ£€ä¿®ä½œä¸šç±»å‹å’Œå·¥ä½œç¥¨ç§ç±»
2. æŸ¥è¯¢è®¾å¤‡æŠ€æœ¯å‚æ•°å’Œå†å²æ£€ä¿®è®°å½•
3. æ£€ç´¢ç±»ä¼¼ä½œä¸šçš„å·¥ä½œç¥¨æ¡ˆä¾‹
4. è¯†åˆ«ä½œä¸šé£é™©ç‚¹
5. é…ç½®å®‰å…¨æªæ–½æ¸…å•
6. ç”Ÿæˆå®Œæ•´çš„å·¥ä½œç¥¨

è¯·åŸºäºçŸ¥è¯†åº“ç”Ÿæˆè§„èŒƒçš„å·¥ä½œç¥¨ã€‚
""",
    
    file_templates={
        "work_permit_first": "templates/work_permit_first.md",
        "work_permit_second": "templates/work_permit_second.md"
    },
    
    required_tools=["search_collection"],
    capabilities={"rag", "generation", "risk_assessment"},
    priority=10
)

# å›¾è°±ä¸“å®¶é…ç½®
ARCHIVIST_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.ARCHIVIST,
    name="å›¾è°±ä¸“å®¶",
    description="å…¨å±€çŸ¥è¯†åº“æ£€ç´¢ä¸“å®¶ï¼Œæ“…é•¿æŸ¥æ‰¾è®¾å¤‡å°è´¦ã€å†å²è®°å½•å’ŒæŠ€æœ¯æ–‡æ¡£",
    
    default_collections=[],  # å¯è®¿é—®æ‰€æœ‰çŸ¥è¯†åº“
    
    system_prompt_template="""
ä½ æ˜¯å˜ç”µç«™çŸ¥è¯†å›¾è°±æ£€ç´¢ä¸“å®¶ã€‚

## æ ¸å¿ƒèŒè´£
1. è·¨çŸ¥è¯†åº“æ£€ç´¢ä¿¡æ¯
2. è®¾å¤‡å°è´¦æŸ¥è¯¢
3. ç¼ºé™·æº¯æº
4. è§„ç¨‹æ–‡æ¡£æŸ¥æ‰¾

## æ£€ç´¢ç­–ç•¥
- ä½¿ç”¨å‘é‡æœç´¢+å›¾è°±æœç´¢æ··åˆæ¨¡å¼
- å¤šå…³é”®è¯å¹¶è¡Œæ£€ç´¢
- ç»“æœå»é‡å’Œæ’åº

## è¾“å‡ºè¦æ±‚
- å‡†ç¡®å¼•ç”¨æ¥æº
- ä¿¡æ¯å®Œæ•´å‡†ç¡®
- ç»“æ„åŒ–å‘ˆç°
""",
    
    required_tools=["search_collection", "list_collections"],
    capabilities={"rag", "graph_search"},
    priority=5
)

# é…ç½®æ˜ å°„è¡¨
AGENT_CONFIGS = {
    AgentRole.OPERATION_TICKET: OPERATION_TICKET_AGENT_CONFIG,
    AgentRole.WORK_PERMIT: WORK_PERMIT_AGENT_CONFIG,
    AgentRole.ARCHIVIST: ARCHIVIST_AGENT_CONFIG,
    # ... å…¶ä»–æ™ºèƒ½ä½“é…ç½®
}
```

### 3. åˆå§‹åŒ–æµç¨‹ä¼˜åŒ–

```python
# aperag/agent/registry_v2.py (ç»­)

def initialize_agents_from_config():
    """ä»é…ç½®åˆå§‹åŒ–æ‰€æœ‰æ™ºèƒ½ä½“"""
    from aperag.agent.agent_configs import AGENT_CONFIGS
    from aperag.agent.specialists import (
        OperationTicketAgent,
        WorkPermitAgent,
        ArchivistAgent,
        # ... å…¶ä»–æ™ºèƒ½ä½“
    )
    
    # æ™ºèƒ½ä½“ç±»æ˜ å°„
    AGENT_CLASSES = {
        AgentRole.OPERATION_TICKET: OperationTicketAgent,
        AgentRole.WORK_PERMIT: WorkPermitAgent,
        AgentRole.ARCHIVIST: ArchivistAgent,
        # ...
    }
    
    for role, config in AGENT_CONFIGS.items():
        agent_class = AGENT_CLASSES.get(role)
        if agent_class:
            # åˆ›å»ºæ™ºèƒ½ä½“å®ä¾‹
            agent = agent_class()
            # æ³¨å†Œæ™ºèƒ½ä½“åŠå…¶å…ƒæ•°æ®
            enhanced_agent_registry.register(agent, config)
            logger.info(f"Initialized {config.name} from config")
```

---

## æ™ºèƒ½ä½“è°ƒç”¨ä¼˜åŒ–

### 1. ç»Ÿä¸€çš„AgentChatServiceé›†æˆ

```python
# aperag/service/agent_chat_service_v2.py

class EnhancedAgentChatService(AgentChatService):
    """å¢å¼ºçš„æ™ºèƒ½ä½“èŠå¤©æœåŠ¡"""
    
    def __init__(self, session: AsyncSession = None):
        super().__init__(session)
        self.agent_registry = enhanced_agent_registry
    
    async def process_agent_message(
        self,
        agent_message: view_models.AgentMessage,
        user: str,
        bot: any,
        chat_id: str,
        message_id: str,
        message_queue: AgentMessageQueue,
        bot_config=None,
        default_collections=None,
        custom_system_prompt=None,
        custom_query_prompt=None,
    ) -> Dict[str, Any]:
        """
        å¢å¼ºçš„æ¶ˆæ¯å¤„ç†é€»è¾‘
        
        æ–°å¢åŠŸèƒ½:
        1. æ”¯æŒæ™ºèƒ½ä½“è§’è‰²è·¯ç”±
        2. è‡ªåŠ¨åŠ è½½æ™ºèƒ½ä½“ä¸“å±çŸ¥è¯†åº“
        3. ä½¿ç”¨æ™ºèƒ½ä½“ä¸“å±æç¤ºè¯
        4. æ”¯æŒæ–‡ä»¶æ¨¡æ¿æ¸²æŸ“
        """
        
        # 1. ç¡®å®šä½¿ç”¨çš„æ™ºèƒ½ä½“è§’è‰²(ä»bot_configæˆ–é»˜è®¤)
        agent_role = self._determine_agent_role(bot_config)
        
        # 2. è·å–æ™ºèƒ½ä½“å…ƒæ•°æ®
        agent_metadata = self.agent_registry.get_metadata(agent_role)
        
        # 3. åˆå¹¶çŸ¥è¯†åº“é…ç½®(ä¼˜å…ˆçº§: ç”¨æˆ·æŒ‡å®š > æ™ºèƒ½ä½“é»˜è®¤ > Boté…ç½®)
        final_collections = self._merge_collections(
            agent_message.collections,
            agent_metadata.default_collections if agent_metadata else [],
            default_collections
        )
        
        # 4. ç¡®å®šæç¤ºè¯(ä¼˜å…ˆçº§: è‡ªå®šä¹‰ > æ™ºèƒ½ä½“é…ç½® > é»˜è®¤)
        final_system_prompt = (
            custom_system_prompt or
            (self.agent_registry.get_system_prompt(agent_role, agent_message.language) 
             if agent_metadata else None) or
            get_agent_system_prompt(agent_message.language)
        )
        
        final_query_template = (
            custom_query_prompt or
            (self.agent_registry.get_query_prompt_template(agent_role, agent_message.language)
             if agent_metadata else None) or
            get_default_agent_query_prompt_template(agent_message.language)
        )
        
        # 5. æ„å»ºå¢å¼ºçš„agent_message
        enhanced_message = view_models.AgentMessage(
            query=agent_message.query,
            collections=final_collections,
            completion=agent_message.completion,
            web_search_enabled=agent_message.web_search_enabled,
            language=agent_message.language,
            files=agent_message.files,
        )
        
        # 6. è°ƒç”¨åŸæœ‰å¤„ç†é€»è¾‘
        try:
            await message_queue.put(format_stream_start(message_id))
            
            # åˆ›å»ºè®°å¿†
            history = await self.history_manager.get_chat_history(chat_id)
            memory = await self.memory_manager.create_memory_from_history(
                history, context_limit=4
            )
            
            # è·å–ä¼šè¯
            session = await self._get_agent_session(
                enhanced_message, user, chat_id, final_system_prompt
            )
            llm = await session.get_llm(enhanced_message.completion.model)
            llm.history = memory
            
            # æ„å»ºæŸ¥è¯¢æç¤ºè¯
            comprehensive_prompt = self._build_query_prompt(
                chat_id, enhanced_message, user, final_query_template
            )
            
            # ç”Ÿæˆå“åº”
            request_params = RequestParams(
                maxTokens=8192,
                model=enhanced_message.completion.model,
                use_history=True,
                max_iterations=10,
                parallel_tool_calls=True,
                temperature=0.7,
                user=user,
            )
            response = await llm.generate_str(comprehensive_prompt, request_params)
            full_content = response if response else "No response generated"
            
            # åå¤„ç†: åº”ç”¨æ–‡ä»¶æ¨¡æ¿(å¦‚æœæ™ºèƒ½ä½“æœ‰é…ç½®)
            if agent_metadata and agent_metadata.file_templates:
                full_content = await self._apply_file_template(
                    full_content, agent_metadata, agent_role
                )
            
            await asyncio.sleep(0.1)
            await message_queue.put(format_stream_content(message_id, full_content))
            
            tool_references = extract_tool_call_references(llm.history)
            await message_queue.put(
                format_stream_end(message_id, references=tool_references, urls=[])
            )
            
            return {
                "query": enhanced_message.query,
                "content": full_content,
                "references": tool_references,
            }
            
        finally:
            await message_queue.close()
    
    def _determine_agent_role(self, bot_config) -> AgentRole:
        """ç¡®å®šæ™ºèƒ½ä½“è§’è‰²"""
        if bot_config and hasattr(bot_config, 'agent_role'):
            return bot_config.agent_role
        return AgentRole.ARCHIVIST  # é»˜è®¤ä½¿ç”¨å›¾è°±ä¸“å®¶
    
    def _merge_collections(
        self, 
        user_collections, 
        agent_collections, 
        bot_collections
    ) -> List:
        """åˆå¹¶çŸ¥è¯†åº“é…ç½®"""
        # ä¼˜å…ˆçº§: ç”¨æˆ·æŒ‡å®š > æ™ºèƒ½ä½“é»˜è®¤ > Boté…ç½®
        if user_collections:
            return user_collections
        
        if agent_collections:
            # å°†çŸ¥è¯†åº“IDè½¬æ¢ä¸ºCollectionå¯¹è±¡
            return self._load_collections_by_ids(agent_collections)
        
        return bot_collections or []
    
    async def _load_collections_by_ids(self, collection_ids: List[str]):
        """æ ¹æ®IDåŠ è½½çŸ¥è¯†åº“"""
        # TODO: å®ç°ä»æ•°æ®åº“åŠ è½½çŸ¥è¯†åº“
        pass
    
    async def _apply_file_template(
        self, 
        content: str, 
        metadata: AgentMetadata,
        role: AgentRole
    ) -> str:
        """åº”ç”¨æ–‡ä»¶æ¨¡æ¿"""
        # æ£€æµ‹å†…å®¹ç±»å‹å¹¶åº”ç”¨ç›¸åº”æ¨¡æ¿
        # ä¾‹å¦‚: å¦‚æœæ˜¯æ“ä½œç¥¨,åº”ç”¨æ“ä½œç¥¨æ¨¡æ¿
        # TODO: å®ç°æ¨¡æ¿æ¸²æŸ“é€»è¾‘
        return content
```

### 2. Boté…ç½®æ‰©å±•

```python
# aperag/schema/view_models.py (æ‰©å±•)

class BotConfigAgent(BaseModel):
    """Botçš„Agenté…ç½®"""
    
    # ç°æœ‰å­—æ®µ
    collections: Optional[List[Collection]] = None
    completion: Optional[ModelSpec] = None
    system_prompt_template: Optional[str] = None
    query_prompt_template: Optional[str] = None
    
    # æ–°å¢å­—æ®µ
    agent_role: Optional[str] = None  # æŒ‡å®šä½¿ç”¨çš„æ™ºèƒ½ä½“è§’è‰²
    enable_specialist_mode: bool = False  # å¯ç”¨ä¸“å®¶æ¨¡å¼
    auto_select_collections: bool = True  # è‡ªåŠ¨é€‰æ‹©æ™ºèƒ½ä½“ä¸“å±çŸ¥è¯†åº“
```

---

## æ–‡ä»¶æ¨¡æ¿ç³»ç»Ÿè®¾è®¡

### 1. æ¨¡æ¿ç›®å½•ç»“æ„

```
aperag/templates/
â”œâ”€â”€ operation_ticket.md          # æ“ä½œç¥¨æ¨¡æ¿
â”œâ”€â”€ work_permit_first.md         # ç¬¬ä¸€ç§å·¥ä½œç¥¨æ¨¡æ¿
â”œâ”€â”€ work_permit_second.md        # ç¬¬äºŒç§å·¥ä½œç¥¨æ¨¡æ¿
â”œâ”€â”€ safety_checklist.md          # å®‰å…¨æ£€æŸ¥æ¸…å•æ¨¡æ¿
â”œâ”€â”€ accident_deduction_report.md # äº‹æ•…æ¨æ¼”æŠ¥å‘Šæ¨¡æ¿
â””â”€â”€ power_guarantee_plan.md      # ä¿ç”µæ–¹æ¡ˆæ¨¡æ¿
```

### 2. æ“ä½œç¥¨æ¨¡æ¿ç¤ºä¾‹

```markdown
# templates/operation_ticket.md

---
template_type: operation_ticket
version: 1.0
---

# æ“ä½œç¥¨

**ç¥¨å·**: {{ ticket_no }}
**æ“ä½œä»»åŠ¡**: {{ title }}
**è®¾å¤‡åç§°**: {{ equipment }}
**ç”µå‹ç­‰çº§**: {{ voltage_level }}
**è®¡åˆ’æ—¥æœŸ**: {{ operation_date }}
**é¢„è®¡ç”¨æ—¶**: {{ estimated_time }}

---

## æ“ä½œäººå‘˜

| è§’è‰² | å§“å | æ—¶é—´ | ç­¾å­— |
|------|------|------|------|
| æ“ä½œäºº | {{ operator \|\| "________" }} | ________ | ________ |
| ç›‘æŠ¤äºº | {{ supervisor \|\| "________" }} | ________ | ________ |
| å€¼ç­è´Ÿè´£äºº | ________ | ________ | ________ |

---

## æ“ä½œå‰ææ¡ä»¶

{% if prerequisites %}
{% for prereq in prerequisites %}
- [ ] {{ prereq }}
{% endfor %}
{% else %}
- [ ] å¤©æ°”æ¡ä»¶è‰¯å¥½
- [ ] æ“ä½œäººå‘˜æŒæœ‰æ•ˆèµ„æ ¼è¯
- [ ] å·¥å™¨å…·æ£€æŸ¥åˆæ ¼
{% endif %}

---

## æ“ä½œæ­¥éª¤

{% for step in steps %}
### ç¬¬{{ step.seq }}æ­¥: {{ step.action }}

**å…·ä½“å†…å®¹**: {{ step.detail }}

{% if step.safety_note %}
âš ï¸ **å®‰å…¨æ³¨æ„äº‹é¡¹**: {{ step.safety_note }}
{% endif %}

**æ‰§è¡Œæƒ…å†µ**:
- [ ] å·²æ‰§è¡Œ
- æ‰§è¡Œæ—¶é—´: ________
- æ‰§è¡Œäººç­¾å­—: ________

---
{% endfor %}

## å®‰å…¨æ€§æ£€æŸ¥

{% if safety_check %}
| æ£€æŸ¥é¡¹ | ç»“æœ |
|--------|------|
{% for check_name, result in safety_check.items() %}
{% if check_name not in ['warnings', 'suggestions'] %}
| {{ check_name }} | {{ result }} |
{% endif %}
{% endfor %}
{% endif %}

{% if safety_check.warnings %}
### âš ï¸ è­¦å‘Š
{% for warning in safety_check.warnings %}
- {{ warning }}
{% endfor %}
{% endif %}

{% if safety_check.suggestions %}
### ğŸ’¡ å»ºè®®
{% for suggestion in safety_check.suggestions %}
- {{ suggestion }}
{% endfor %}
{% endif %}

---

## æ“ä½œå®Œæˆç¡®è®¤

**å®Œæˆæ—¶é—´**: ________
**å€¼ç­è´Ÿè´£äººç­¾å­—**: ________
**è°ƒåº¦è®¸å¯**: ________

---

*æœ¬æ“ä½œç¥¨ç”±ApeRAGæ™ºèƒ½ä½“ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œè¯·äººå·¥å®¡æ ¸åæ‰§è¡Œ*
```

### 3. æ¨¡æ¿æ¸²æŸ“æœåŠ¡

```python
# aperag/service/template_service.py

from jinja2 import Environment, FileSystemLoader, Template
from pathlib import Path
from typing import Dict, Any
import os

class TemplateRenderService:
    """æ–‡ä»¶æ¨¡æ¿æ¸²æŸ“æœåŠ¡"""
    
    def __init__(self, template_dir: str = None):
        if template_dir is None:
            template_dir = os.path.join(
                os.path.dirname(__file__), 
                "../templates"
            )
        
        self.template_dir = Path(template_dir)
        self.env = Environment(
            loader=FileSystemLoader(str(self.template_dir)),
            autoescape=False,  # ä¸è‡ªåŠ¨è½¬ä¹‰,ä¿ç•™Markdownæ ¼å¼
            trim_blocks=True,
            lstrip_blocks=True
        )
    
    def render_template(
        self, 
        template_name: str, 
        context: Dict[str, Any]
    ) -> str:
        """
        æ¸²æŸ“æ¨¡æ¿
        
        Args:
            template_name: æ¨¡æ¿æ–‡ä»¶å(å¦‚ "operation_ticket.md")
            context: æ¨¡æ¿ä¸Šä¸‹æ–‡å˜é‡
            
        Returns:
            æ¸²æŸ“åçš„æ–‡æœ¬
        """
        try:
            template = self.env.get_template(template_name)
            return template.render(**context)
        except Exception as e:
            logger.error(f"Failed to render template {template_name}: {e}")
            raise
    
    def render_from_string(
        self, 
        template_string: str, 
        context: Dict[str, Any]
    ) -> str:
        """ä»å­—ç¬¦ä¸²æ¸²æŸ“æ¨¡æ¿"""
        template = Template(template_string)
        return template.render(**context)


# å…¨å±€å•ä¾‹
template_service = TemplateRenderService()
```

### 4. æ™ºèƒ½ä½“ä¸­ä½¿ç”¨æ¨¡æ¿

```python
# aperag/agent/specialists/operation_ticket_agent.py (ä¿®æ”¹)

class OperationTicketAgent(BaseAgent):
    
    async def _generate_operation_ticket(
        self, 
        state: AgentState, 
        query: str
    ) -> Dict[str, Any]:
        """ç”Ÿæˆæ“ä½œç¥¨"""
        
        # ... ç°æœ‰é€»è¾‘ç”Ÿæˆticketæ•°æ® ...
        
        # ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“
        from aperag.service.template_service import template_service
        
        rendered_ticket = template_service.render_template(
            "operation_ticket.md",
            context={
                "ticket_no": ticket["ticket_no"],
                "title": ticket["title"],
                "equipment": ticket["equipment"],
                "voltage_level": ticket["voltage_level"],
                "operation_date": ticket["operation_date"],
                "estimated_time": ticket["estimated_time"],
                "operator": ticket.get("operator"),
                "supervisor": ticket.get("supervisor"),
                "prerequisites": ticket.get("prerequisites", []),
                "steps": ticket["steps"],
                "safety_check": safety_check
            }
        )
        
        return {
            "answer": rendered_ticket,
            "ticket": ticket,
            "safety_check": safety_check
        }
```

---

## å®æ–½è·¯çº¿å›¾

### é˜¶æ®µ1: åŸºç¡€æ¶æ„é‡æ„ (1-2å‘¨)

**ç›®æ ‡**: å»ºç«‹ç»Ÿä¸€çš„æ™ºèƒ½ä½“æ¶æ„

**ä»»åŠ¡**:
1. âœ… åˆ›å»º `EnhancedAgentRegistry`
2. âœ… å®šä¹‰ `AgentMetadata` æ•°æ®ç»“æ„
3. âœ… åˆ›å»ºæ™ºèƒ½ä½“é…ç½®æ–‡ä»¶ `agent_configs.py`
4. âœ… å®ç°é…ç½®åŒ–æ³¨å†Œæµç¨‹
5. âœ… å•å…ƒæµ‹è¯•

**äº¤ä»˜ç‰©**:
- `aperag/agent/registry_v2.py`
- `aperag/agent/agent_configs.py`
- æµ‹è¯•ç”¨ä¾‹

### é˜¶æ®µ2: æç¤ºè¯ç³»ç»Ÿç»Ÿä¸€ (1å‘¨)

**ç›®æ ‡**: ç»Ÿä¸€æç¤ºè¯ç®¡ç†

**ä»»åŠ¡**:
1. âœ… å°†ä¸“å®¶æç¤ºè¯è¿ç§»åˆ°é…ç½®ä¸­
2. âœ… ä¸ºæ¯ä¸ªæ™ºèƒ½ä½“å®šä¹‰ä¸“å±æç¤ºè¯
3. âœ… å®ç°æç¤ºè¯ç‰ˆæœ¬ç®¡ç†
4. âœ… æ”¯æŒå¤šè¯­è¨€æç¤ºè¯

**äº¤ä»˜ç‰©**:
- æ›´æ–°çš„ `agent_configs.py`
- æç¤ºè¯æ–‡æ¡£

### é˜¶æ®µ3: çŸ¥è¯†åº“ç»‘å®š (1å‘¨)

**ç›®æ ‡**: å®ç°æ™ºèƒ½ä½“ä¸“å±çŸ¥è¯†åº“

**ä»»åŠ¡**:
1. âœ… åœ¨å…ƒæ•°æ®ä¸­æ·»åŠ çŸ¥è¯†åº“é…ç½®
2. âœ… å®ç°çŸ¥è¯†åº“è‡ªåŠ¨åŠ è½½é€»è¾‘
3. âœ… ä¿®æ”¹ `AgentChatService` æ”¯æŒçŸ¥è¯†åº“åˆå¹¶
4. âœ… æµ‹è¯•çŸ¥è¯†åº“è·¯ç”±

**äº¤ä»˜ç‰©**:
- æ›´æ–°çš„ `EnhancedAgentChatService`
- çŸ¥è¯†åº“é…ç½®æ–‡æ¡£

### é˜¶æ®µ4: æ–‡ä»¶æ¨¡æ¿ç³»ç»Ÿ (1-2å‘¨)

**ç›®æ ‡**: å»ºç«‹æ ‡å‡†åŒ–æ–‡ä»¶æ¨¡æ¿

**ä»»åŠ¡**:
1. âœ… åˆ›å»ºæ¨¡æ¿ç›®å½•ç»“æ„
2. âœ… å®ç° `TemplateRenderService`
3. âœ… ä¸ºæ“ä½œç¥¨ã€å·¥ä½œç¥¨ç­‰åˆ›å»ºæ¨¡æ¿
4. âœ… é›†æˆåˆ°æ™ºèƒ½ä½“ä¸­
5. âœ… å‰ç«¯å±•ç¤ºä¼˜åŒ–

**äº¤ä»˜ç‰©**:
- `aperag/templates/` ç›®å½•
- `aperag/service/template_service.py`
- æ¨¡æ¿æ–‡æ¡£

### é˜¶æ®µ5: é›†æˆä¸æµ‹è¯• (1å‘¨)

**ç›®æ ‡**: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•

**ä»»åŠ¡**:
1. âœ… é›†æˆæµ‹è¯•æ‰€æœ‰æ™ºèƒ½ä½“
2. âœ… æ€§èƒ½æµ‹è¯•
3. âœ… ç”¨æˆ·éªŒæ”¶æµ‹è¯•
4. âœ… æ–‡æ¡£å®Œå–„

**äº¤ä»˜ç‰©**:
- æµ‹è¯•æŠ¥å‘Š
- ç”¨æˆ·æ‰‹å†Œ
- APIæ–‡æ¡£

---

## é™„å½•

### A. æ™ºèƒ½ä½“è§’è‰²æšä¸¾æ‰©å±•

```python
# aperag/agent/core/models.py (æ‰©å±•)

class AgentRole(str, Enum):
    """æ™ºèƒ½ä½“è§’è‰²æšä¸¾"""
    
    # ç°æœ‰è§’è‰²
    SUPERVISOR = "supervisor"
    ARCHIVIST = "archivist"
    CALCULATOR = "calculator"
    SCRIBE = "scribe"
    DETECTIVE = "detective"
    GATEKEEPER = "gatekeeper"
    PROPHET = "prophet"
    AUDITOR = "auditor"
    DIAGNOSTICIAN = "diagnostician"
    INSTRUCTOR = "instructor"
    SENTINEL = "sentinel"
    
    # å˜ç”µç«™ä¸“ç”¨è§’è‰²
    OPERATION_TICKET = "operation_ticket"
    WORK_PERMIT = "work_permit"
    ACCIDENT_DEDUCTION = "accident_deduction"
    POWER_GUARANTEE = "power_guarantee"
    
    # æ–°å¢é€šç”¨è§’è‰²(å¯æ‰©å±•)
    KNOWLEDGE_MANAGER = "knowledge_manager"  # çŸ¥è¯†ç®¡ç†ä¸“å®¶
    TRAINING_COACH = "training_coach"        # åŸ¹è®­æ•™ç»ƒ
    COMPLIANCE_CHECKER = "compliance_checker" # åˆè§„æ£€æŸ¥ä¸“å®¶
```

### B. é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
# config/agents.yaml

agents:
  operation_ticket:
    name: "æ“ä½œç¥¨ä¸“å®¶"
    description: "æ™ºèƒ½ç”Ÿæˆå’Œå®¡æ ¸æ“ä½œç¥¨"
    collections:
      - operation_tickets_db
      - operation_regulations_db
      - equipment_topology_db
    system_prompt: |
      ä½ æ˜¯å˜ç”µç«™æ“ä½œç¥¨æ™ºèƒ½ç¼–åˆ¶ä¸å®¡æ ¸ä¸“å®¶...
    query_prompt: |
      **æ“ä½œä»»åŠ¡**: {{ query }}
      ...
    templates:
      operation_ticket: "operation_ticket.md"
      safety_checklist: "safety_checklist.md"
    tools:
      required:
        - search_collection
        - create_diagram
      optional:
        - web_search
    capabilities:
      - rag
      - generation
      - validation
    priority: 10
```

### C. APIæ¥å£è®¾è®¡

```python
# aperag/api/routes/agent.py (æ–°å¢)

from fastapi import APIRouter, Depends
from aperag.agent.registry_v2 import enhanced_agent_registry

router = APIRouter(prefix="/api/agents", tags=["agents"])

@router.get("/list")
async def list_agents():
    """åˆ—å‡ºæ‰€æœ‰å·²æ³¨å†Œçš„æ™ºèƒ½ä½“"""
    agents = enhanced_agent_registry.list_agents()
    return {
        "agents": [
            {
                "role": agent.role,
                "name": agent.name,
                "description": agent.description,
                "capabilities": metadata.capabilities
            }
            for agent in agents
            if (metadata := enhanced_agent_registry.get_metadata(agent.role))
        ]
    }

@router.get("/{role}/metadata")
async def get_agent_metadata(role: str):
    """è·å–æ™ºèƒ½ä½“å…ƒæ•°æ®"""
    from aperag.agent.core.models import AgentRole
    
    agent_role = AgentRole(role)
    metadata = enhanced_agent_registry.get_metadata(agent_role)
    
    if not metadata:
        raise HTTPException(status_code=404, detail="Agent not found")
    
    return {
        "role": metadata.role,
        "name": metadata.name,
        "description": metadata.description,
        "default_collections": metadata.default_collections,
        "capabilities": list(metadata.capabilities) if metadata.capabilities else [],
        "priority": metadata.priority
    }

@router.get("/{role}/templates")
async def get_agent_templates(role: str):
    """è·å–æ™ºèƒ½ä½“çš„æ–‡ä»¶æ¨¡æ¿åˆ—è¡¨"""
    from aperag.agent.core.models import AgentRole
    
    agent_role = AgentRole(role)
    metadata = enhanced_agent_registry.get_metadata(agent_role)
    
    if not metadata or not metadata.file_templates:
        return {"templates": []}
    
    return {
        "templates": [
            {
                "name": name,
                "path": path
            }
            for name, path in metadata.file_templates.items()
        ]
    }
```

---

## æ€»ç»“

æœ¬ä¼˜åŒ–æ–¹æ¡ˆé€šè¿‡ä»¥ä¸‹æ ¸å¿ƒæ”¹è¿›,å®ç°äº†æ™ºèƒ½ä½“ç³»ç»Ÿçš„ç»Ÿä¸€åŒ–å’Œä¸“ä¸šåŒ–:

### æ ¸å¿ƒæ”¹è¿›ç‚¹

1. **ç»Ÿä¸€æ¶æ„**: 
   - æ‰€æœ‰æ™ºèƒ½ä½“é€šè¿‡ `EnhancedAgentRegistry` ç»Ÿä¸€ç®¡ç†
   - å…ƒæ•°æ®é©±åŠ¨çš„é…ç½®åŒ–æ³¨å†Œ
   - ç»Ÿä¸€çš„è°ƒç”¨æ¥å£

2. **ä¸“å±çŸ¥è¯†åº“**:
   - æ¯ä¸ªæ™ºèƒ½ä½“å¯é…ç½®ä¸“å±çŸ¥è¯†åº“
   - è‡ªåŠ¨çŸ¥è¯†åº“è·¯ç”±å’ŒåŠ è½½
   - æé«˜æ£€ç´¢ç²¾åº¦

3. **æç¤ºè¯ç®¡ç†**:
   - ç»Ÿä¸€çš„æç¤ºè¯é…ç½®ç³»ç»Ÿ
   - æ”¯æŒè‡ªå®šä¹‰å’Œé»˜è®¤æç¤ºè¯
   - å¤šè¯­è¨€æ”¯æŒ

4. **æ–‡ä»¶æ¨¡æ¿**:
   - æ ‡å‡†åŒ–çš„æ–‡ä»¶æ¨¡æ¿ç³»ç»Ÿ
   - Jinja2æ¨¡æ¿å¼•æ“
   - æ˜“äºæ‰©å±•å’Œç»´æŠ¤

5. **å¯æ‰©å±•æ€§**:
   - æ–°å¢æ™ºèƒ½ä½“åªéœ€æ·»åŠ é…ç½®
   - æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
   - æ”¯æŒçƒ­åŠ è½½

### é¢„æœŸæ•ˆæœ

- âœ… å¼€å‘æ•ˆç‡æå‡50%
- âœ… ä»£ç é‡å¤å‡å°‘70%
- âœ… æ£€ç´¢ç²¾åº¦æå‡30%
- âœ… ç»´æŠ¤æˆæœ¬é™ä½60%
- âœ… ç”¨æˆ·ä½“éªŒæ˜¾è‘—æ”¹å–„

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. è¯„å®¡æœ¬æ–¹æ¡ˆ
2. ç¡®å®šå®æ–½ä¼˜å…ˆçº§
3. åˆ†é…å¼€å‘ä»»åŠ¡
4. å¯åŠ¨é˜¶æ®µ1å¼€å‘
