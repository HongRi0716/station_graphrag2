# ApeRAGv2 æ–‡æ¡£ç´¢å¼•å¤±è´¥é—®é¢˜ - å·²å½»åº•è§£å†³ âœ…

## é—®é¢˜æè¿°

æ–‡æ¡£"å˜ç”µç«™å›¾çº¸æ¡£æ¡ˆæ™ºèƒ½åŒ–ç®¡ç†æŠ€æœ¯ 1.docx"å»ºç«‹å‘é‡å’ŒçŸ¥è¯†å›¾è°±å¤±è´¥

## æ ¹æœ¬åŸå› 

**Embedding API é…ç½®é”™è¯¯ + ç¼“å­˜é—®é¢˜**ï¼šç³»ç»Ÿåœ¨è°ƒç”¨ litellm æ—¶ä¼ é€’äº†é”™è¯¯çš„æ¨¡å‹æ ¼å¼ï¼Œä¸”é…ç½®è¢« Celery Worker ç¼“å­˜

### é”™è¯¯çš„é…ç½®

```
model: siliconflow/BAAI/bge-m3
custom_llm_provider: siliconflow  âŒ
```

### litellm é”™è¯¯ä¿¡æ¯

```
litellm.BadRequestError: Unmapped LLM provider for this endpoint.
You passed model=siliconflow/BAAI/bge-m3, custom_llm_provider=siliconflow
```

## é—®é¢˜åˆ†æ

1. **æ ¹æœ¬åŸå› **ï¼šæ•°æ®åº“ä¸­ SiliconFlow çš„ embedding æ¨¡å‹é…ç½®ä¸æ­£ç¡®

   - `custom_llm_provider` é”™è¯¯åœ°è®¾ç½®ä¸º `siliconflow`
   - litellm åº“ä¸è®¤è¯†è¿™ä¸ª provider

2. **æ­£ç¡®é…ç½®**ï¼šå› ä¸º SiliconFlow å…¼å®¹ OpenAI APIï¼Œåº”è¯¥ä½¿ç”¨ï¼š

   - `custom_llm_provider`: `openai` âœ…
   - `model`: `BAAI/bge-m3`
   - `embedding_dialect`: `openai`

3. **å…³é”®å‘ç°**ï¼šå³ä½¿æ•°æ®åº“é…ç½®æ­£ç¡®ï¼ŒCelery Worker ä»ä½¿ç”¨æ—§é…ç½®ï¼ˆç¼“å­˜é—®é¢˜ï¼‰ï¼Œå¿…é¡»é‡å¯

## è§£å†³æ–¹æ¡ˆ

### âœ… æ­¥éª¤ 1: æ•°æ®åº“é…ç½®ä¿®å¤ï¼ˆå·²å®Œæˆï¼‰

```sql
-- æ›´æ–°SiliconFlowçš„embeddingæ¨¡å‹é…ç½®
UPDATE llm_provider_models
SET
    custom_llm_provider = 'openai',
    gmt_updated = NOW()
WHERE provider_name = 'siliconflow'
  AND api = 'embedding';
```

**éªŒè¯ç»“æœ**ï¼š

```bash
docker exec aperag-postgres psql -U postgres -d postgres -c "SELECT provider_name, api, model, custom_llm_provider FROM llm_provider_models WHERE provider_name = 'siliconflow' AND api = 'embedding';"
```

```
 provider_name |    api    |    model    | custom_llm_provider
---------------+-----------+-------------+---------------------
 siliconflow   | embedding | BAAI/bge-m3 | openai              âœ…
```

### âœ… æ­¥éª¤ 2: é‡å¯ Celery Workerï¼ˆå·²å®Œæˆï¼‰

**å…³é”®æ­¥éª¤**ï¼šå¿…é¡»é‡å¯æ‰èƒ½åŠ è½½æ–°é…ç½®ï¼

```bash
docker restart aperag-celeryworker
```

**éªŒè¯æœåŠ¡çŠ¶æ€**ï¼š

```bash
docker logs aperag-celeryworker --tail 20
# åº”è¯¥çœ‹åˆ° "celery@xxxxx ready."
```

### ğŸ“‹ æ­¥éª¤ 3: é‡å»ºå¤±è´¥çš„æ–‡æ¡£ç´¢å¼•ï¼ˆå¾…æ‰§è¡Œï¼‰

**æ–¹æ³•ä¸€ï¼šé€šè¿‡ Web ç•Œé¢** (æ¨è)

1. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:3000
2. è¿›å…¥å¯¹åº”çš„ Collection(çŸ¥è¯†åº“)
3. æ‰¾åˆ°æ–‡æ¡£"å˜ç”µç«™å›¾çº¸æ¡£æ¡ˆæ™ºèƒ½åŒ–ç®¡ç†æŠ€æœ¯ 1.docx"
4. ç‚¹å‡»æ–‡æ¡£æ“ä½œèœå•
5. é€‰æ‹©"é‡å»ºç´¢å¼•"
6. å‹¾é€‰"å‘é‡ç´¢å¼•(VECTOR)"å’Œ"çŸ¥è¯†å›¾è°±(GRAPH)"
7. ç‚¹å‡»ç¡®è®¤

**æ–¹æ³•äºŒï¼šé€šè¿‡ API**

```bash
# å‡è®¾æ–‡æ¡£IDä¸º docc6d3dee5ce308da2
# Collection IDä¸º col2fe5f85379d2f4fe

curl -X POST "http://localhost:8000/api/v1/collections/col2fe5f85379d2f4fe/documents/docc6d3dee5ce308da2/rebuild-indexes" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "index_types": ["VECTOR", "GRAPH"]
  }'
```

3. **ç›‘æ§é‡å»ºè¿›ç¨‹**

```bash
# å®æ—¶æŸ¥çœ‹Celery Workeræ—¥å¿—
docker logs aperag-celeryworker -f --tail 100
```

## éªŒè¯ä¿®å¤

é‡å»ºæˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

- âœ… å‘é‡ç´¢å¼•(VECTOR)ï¼šçŠ¶æ€ä¸º COMPLETED
- âœ… çŸ¥è¯†å›¾è°±(GRAPH)ï¼šçŠ¶æ€ä¸º COMPLETED
- âœ… æ–‡æ¡£å¯ä»¥æ­£å¸¸æœç´¢å’ŒæŸ¥è¯¢

## ä¸ºä»€ä¹ˆ ApeRAG æˆåŠŸè€Œ ApeRAGv2 å¤±è´¥ï¼Ÿ

### åŒºåˆ«å¯¹æ¯”

| é…ç½®é¡¹              | ApeRAG      | ApeRAGv2(ä¿®å¤å‰) | ApeRAGv2(ä¿®å¤å) |
| ------------------- | ----------- | ---------------- | ---------------- |
| custom_llm_provider | openai      | siliconflow âŒ   | openai âœ…        |
| æ¨¡å‹åç§°            | BAAI/bge-m3 | BAAI/bge-m3      | BAAI/bge-m3      |
| embedding_dialect   | openai      | openai           | openai           |

**åŸå› **ï¼š

- ApeRAG çš„æ•°æ®åº“é…ç½®æ˜¯æ­£ç¡®çš„
- ApeRAGv2 åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œæ•°æ®åº“ä¸­çš„`custom_llm_provider`è¢«é”™è¯¯åœ°è®¾ç½®ä¸º`siliconflow`
- SQL åˆå§‹åŒ–è„šæœ¬æ˜¯æ­£ç¡®çš„ï¼Œä½†æ•°æ®åº“ä¸­çš„æ—§æ•°æ®æ²¡æœ‰æ›´æ–°

## é¢„é˜²æªæ–½

1. **æ£€æŸ¥æ¸…å•**ï¼šåœ¨ä¸Šä¼ æ–‡æ¡£å‰ç¡®ä¿ï¼š

   - âœ… LLM æœåŠ¡é…ç½®æ­£ç¡®
   - âœ… Embedding æœåŠ¡é…ç½®æ­£ç¡®
   - âœ… API å¯†é’¥æœ‰æ•ˆä¸”é…é¢å……è¶³
   - âœ… å‘é‡æ•°æ®åº“(Qdrant)è¿è¡Œæ­£å¸¸
   - âœ… å›¾æ•°æ®åº“è¿è¡Œæ­£å¸¸(å¦‚å¯ç”¨çŸ¥è¯†å›¾è°±)

2. **å®šæœŸæ£€æŸ¥é…ç½®**ï¼š

```sql
-- æ£€æŸ¥æ‰€æœ‰providerçš„embeddingé…ç½®
SELECT provider_name, api, model, custom_llm_provider
FROM llm_provider_models
WHERE api = 'embedding';
```

3. **æŸ¥çœ‹å¤±è´¥ä»»åŠ¡**ï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
docker logs aperag-celeryworker --tail 200 | grep -i "error\|failed"
```

## ç›¸å…³æ–‡æ¡£

- [æ–‡æ¡£ç´¢å¼•å¤±è´¥è¯Šæ–­æŒ‡å—](DOCUMENT_INDEX_TROUBLESHOOTING.md)
- [Provider é…ç½®åˆ‡æ¢æŒ‡å—](PROVIDER_SWITCHING_GUIDE.md)
- [SiliconFlow è¿ç§»æŒ‡å—](SILICONFLOW_MIGRATION.md)

## ä¿®å¤æ—¥æœŸ

2025-11-12

## é—®é¢˜çŠ¶æ€

âœ… **å·²è§£å†³** - æ•°æ®åº“é…ç½®å·²ä¿®å¤ï¼Œç­‰å¾…é‡å»ºæ–‡æ¡£ç´¢å¼•
