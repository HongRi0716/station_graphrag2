# 智能体系统使用指南

## 概述

本文档说明如何使用优化后的智能体系统，包括智能体注册、配置和调用。

## 核心组件

### 1. AgentRegistry (智能体注册中心)

智能体注册中心负责管理所有智能体实例及其元数据。

```python
from aperag.agent import agent_registry, AgentMetadata
from aperag.agent.core.models import AgentRole

# 获取智能体实例
operation_agent = agent_registry.get_agent(AgentRole.OPERATION_TICKET)

# 获取智能体元数据
metadata = agent_registry.get_metadata(AgentRole.OPERATION_TICKET)
print(f"默认知识库: {metadata.default_collections}")
print(f"能力标签: {metadata.capabilities}")

# 根据能力查找智能体
rag_agents = agent_registry.find_by_capability("rag")
vision_agents = agent_registry.find_by_capability("vision")
```

### 2. AgentMetadata (智能体元数据)

每个智能体都有关联的元数据配置：

```python
from aperag.agent.registry import AgentMetadata
from aperag.agent.core.models import AgentRole

# 创建智能体元数据
metadata = AgentMetadata(
    role=AgentRole.OPERATION_TICKET,
    name="操作票专家",
    description="智能生成和审核操作票",
    
    # 专属知识库
    default_collections=["operation_tickets_db", "regulations_db"],
    
    # 系统提示词
    system_prompt_template="你是操作票专家...",
    
    # 查询提示词模板
    query_prompt_template="**任务**: {{ query }}...",
    
    # 文件模板
    file_templates={
        "operation_ticket": "templates/operation_ticket.md"
    },
    
    # 工具配置
    required_tools=["search_collection"],
    optional_tools=["web_search"],
    
    # 能力标签
    capabilities={"rag", "generation", "validation"},
    
    # 优先级
    priority=10
)
```

### 3. 智能体配置 (agent_configs.py)

所有智能体的配置集中在 `aperag/agent/agent_configs.py` 文件中：

```python
# aperag/agent/agent_configs.py

from aperag.agent.core.models import AgentRole
from aperag.agent.registry import AgentMetadata

# 操作票专家配置
OPERATION_TICKET_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.OPERATION_TICKET,
    name="操作票专家",
    description="智能生成和审核操作票，确保倒闸操作的安全性和规范性",
    default_collections=["operation_tickets_db"],
    system_prompt_template="...",
    query_prompt_template="...",
    file_templates={"operation_ticket": "templates/operation_ticket.md"},
    required_tools=["search_collection"],
    capabilities={"rag", "generation"},
    priority=10
)

# 配置映射表
AGENT_CONFIGS = {
    AgentRole.OPERATION_TICKET: OPERATION_TICKET_AGENT_CONFIG,
    # ... 其他智能体配置
}
```

## 使用场景

### 场景1: 获取智能体的专属知识库

```python
from aperag.agent import agent_registry
from aperag.agent.core.models import AgentRole

# 获取操作票专家的默认知识库
collections = agent_registry.get_default_collections(AgentRole.OPERATION_TICKET)
print(f"操作票专家默认知识库: {collections}")
# 输出: ['operation_tickets_db', 'operation_regulations_db', 'equipment_topology_db']
```

### 场景2: 获取智能体的提示词

```python
from aperag.agent import agent_registry
from aperag.agent.core.models import AgentRole

# 获取系统提示词
system_prompt = agent_registry.get_system_prompt(
    AgentRole.OPERATION_TICKET, 
    language="zh-CN"
)

# 获取查询提示词模板
query_template = agent_registry.get_query_prompt_template(
    AgentRole.OPERATION_TICKET,
    language="zh-CN"
)
```

### 场景3: 使用文件模板

```python
from aperag.service.template_service import template_service

# 准备模板上下文数据
context = {
    "ticket_no": "OT-2024-1125-001",
    "title": "#1主变转冷备用",
    "equipment": "#1主变压器",
    "voltage_level": "110kV/10kV",
    "operation_date": "2024-11-25",
    "estimated_time": "约45分钟",
    "operator": "张三",
    "supervisor": "李四",
    "prerequisites": [
        "天气条件良好",
        "操作人员持有效资格证",
        "备用主变可用"
    ],
    "steps": [
        {
            "seq": 1,
            "action": "核对运行方式",
            "detail": "确认#1主变当前运行",
            "safety_note": "禁止在负荷状态下操作"
        },
        # ... 更多步骤
    ],
    "safety_check": {
        "five_prevention_check": "✅ 通过",
        "sequence_check": "✅ 步骤顺序正确",
        "warnings": [],
        "suggestions": ["建议操作前再次确认天气情况"]
    }
}

# 渲染操作票模板
rendered_ticket = template_service.render_template(
    "operation_ticket.md",
    context
)

print(rendered_ticket)
```

### 场景4: 在智能体中使用模板

```python
# aperag/agent/specialists/operation_ticket_agent.py

from aperag.service.template_service import template_service

class OperationTicketAgent(BaseAgent):
    
    async def _generate_operation_ticket(
        self, 
        state: AgentState, 
        query: str
    ) -> Dict[str, Any]:
        """生成操作票"""
        
        # 1. 生成票据数据
        ticket = self._create_ticket_template(operation_type)
        safety_check = self._perform_safety_check(ticket)
        
        # 2. 使用模板渲染
        rendered_ticket = template_service.render_template(
            "operation_ticket.md",
            context={
                "ticket_no": ticket["ticket_no"],
                "title": ticket["title"],
                "equipment": ticket["equipment"],
                "voltage_level": ticket["voltage_level"],
                "operation_date": ticket["operation_date"],
                "estimated_time": ticket["estimated_time"],
                "operator": ticket.get("operator"),
                "supervisor": ticket.get("supervisor"),
                "prerequisites": ticket.get("prerequisites", []),
                "steps": ticket["steps"],
                "safety_check": safety_check
            }
        )
        
        return {
            "answer": rendered_ticket,
            "ticket": ticket,
            "safety_check": safety_check
        }
```

### 场景5: 根据能力查找智能体

```python
from aperag.agent import agent_registry

# 查找所有支持RAG的智能体
rag_agents = agent_registry.find_by_capability("rag")
for agent in rag_agents:
    print(f"{agent.name} 支持RAG检索")

# 查找所有支持视觉分析的智能体
vision_agents = agent_registry.find_by_capability("vision")
for agent in vision_agents:
    print(f"{agent.name} 支持视觉分析")

# 查找所有支持文档生成的智能体
generation_agents = agent_registry.find_by_capability("generation")
for agent in generation_agents:
    print(f"{agent.name} 支持文档生成")
```

## 添加新智能体

### 步骤1: 定义智能体类

```python
# aperag/agent/specialists/my_agent.py

from aperag.agent.core.base import BaseAgent
from aperag.agent.core.models import AgentRole, AgentState

class MyAgent(BaseAgent):
    """我的自定义智能体"""
    
    def __init__(self, llm_service=None):
        super().__init__(
            role=AgentRole.MY_AGENT,  # 需要先在AgentRole枚举中添加
            name="我的智能体",
            description="智能体描述",
            tools=["tool1", "tool2"]
        )
        self.llm_service = llm_service
    
    async def _execute(self, state: AgentState, input_data: Dict[str, Any]) -> Dict[str, Any]:
        """执行智能体逻辑"""
        query = input_data.get("task", "")
        
        # 记录思考过程
        self._log_thought(state, "thought", f"收到任务: {query}")
        
        # 执行业务逻辑
        result = await self._do_something(query)
        
        return {"answer": result}
```

### 步骤2: 在 agent_configs.py 中添加配置

```python
# aperag/agent/agent_configs.py

MY_AGENT_CONFIG = AgentMetadata(
    role=AgentRole.MY_AGENT,
    name="我的智能体",
    description="智能体描述",
    default_collections=["my_knowledge_db"],
    system_prompt_template="你是...",
    query_prompt_template="**任务**: {{ query }}...",
    file_templates={"my_template": "templates/my_template.md"},
    required_tools=["search_collection"],
    capabilities={"rag", "custom_capability"},
    priority=5
)

# 添加到配置映射表
AGENT_CONFIGS = {
    # ... 现有配置
    AgentRole.MY_AGENT: MY_AGENT_CONFIG,
}
```

### 步骤3: 在 registry.py 中注册

```python
# aperag/agent/registry.py

from aperag.agent.specialists.my_agent import MyAgent

class AgentRegistry:
    def initialize_default_agents(self, llm_service=None, retrieve_service=None, vision_service=None):
        # ... 现有注册代码
        
        # 注册新智能体
        self.register(MyAgent(llm_service=llm_service))
        
        # 从配置加载元数据
        self._load_agent_metadata()
```

### 步骤4: (可选) 创建文件模板

```markdown
<!-- aperag/templates/my_template.md -->

# {{ title }}

**日期**: {{ date }}

## 内容

{{ content }}

---

*由ApeRAG智能体系统生成*
```

## 模板系统

### 可用模板

当前系统提供以下模板：

1. **operation_ticket.md** - 操作票模板
2. **work_permit_first.md** - 第一种工作票模板
3. **work_permit_second.md** - 第二种工作票模板（待创建）
4. **safety_checklist.md** - 安全检查清单模板（待创建）
5. **accident_deduction_report.md** - 事故推演报告模板（待创建）
6. **power_guarantee_plan.md** - 保电方案模板（待创建）

### 模板语法

模板使用 Jinja2 语法：

```jinja2
{# 变量 #}
{{ variable_name }}

{# 带默认值的变量 #}
{{ variable_name|default("默认值") }}

{# 条件判断 #}
{% if condition %}
    内容
{% else %}
    其他内容
{% endif %}

{# 循环 #}
{% for item in items %}
    - {{ item.name }}
{% endfor %}

{# 注释 #}
{# 这是注释 #}
```

### 模板服务API

```python
from aperag.service.template_service import template_service

# 渲染模板文件
result = template_service.render_template("template.md", context)

# 从字符串渲染
result = template_service.render_from_string("Hello {{ name }}", {"name": "World"})

# 检查模板是否存在
exists = template_service.template_exists("operation_ticket.md")

# 列出所有模板
templates = template_service.list_templates()

# 获取模板路径
path = template_service.get_template_path("operation_ticket.md")
```

## 最佳实践

### 1. 知识库配置

- 为每个专业智能体配置专属知识库
- 使用有意义的知识库ID命名
- 在配置中注释知识库用途

### 2. 提示词设计

- 系统提示词定义智能体的角色和能力
- 查询提示词模板使用Jinja2语法支持动态内容
- 提供清晰的执行指令和输出要求

### 3. 文件模板

- 使用Markdown格式便于阅读和渲染
- 提供必要的默认值
- 包含元数据（生成时间、版本等）

### 4. 能力标签

使用标准的能力标签：
- `rag` - RAG检索能力
- `vision` - 视觉分析能力
- `generation` - 文档生成能力
- `validation` - 验证审核能力
- `calculation` - 计算能力
- `simulation` - 模拟推演能力
- `risk_assessment` - 风险评估能力
- `planning` - 方案规划能力

### 5. 优先级设置

- 核心业务智能体: 8-10
- 通用支持智能体: 5-7
- 辅助功能智能体: 1-4

## 故障排查

### 问题1: 智能体元数据未加载

**症状**: `agent_registry.get_metadata()` 返回 None

**解决方案**:
1. 检查 `agent_configs.py` 中是否定义了配置
2. 确认配置已添加到 `AGENT_CONFIGS` 字典
3. 检查日志中是否有 "Loaded metadata for..." 消息

### 问题2: 模板渲染失败

**症状**: `TemplateNotFound` 或渲染错误

**解决方案**:
1. 检查模板文件是否存在于 `aperag/templates/` 目录
2. 确认模板文件名正确
3. 检查模板语法是否正确
4. 验证上下文数据是否包含所有必需变量

### 问题3: 知识库未自动加载

**症状**: 智能体没有使用专属知识库

**解决方案**:
1. 检查元数据中的 `default_collections` 配置
2. 确认知识库ID在数据库中存在
3. 检查 AgentChatService 是否正确合并知识库配置

## 总结

优化后的智能体系统提供了：

✅ **统一的注册管理** - 通过 AgentRegistry 集中管理  
✅ **配置化元数据** - 通过 agent_configs.py 集中配置  
✅ **专属知识库** - 每个智能体可绑定专属知识库  
✅ **灵活的提示词** - 支持自定义系统和查询提示词  
✅ **标准化模板** - 使用Jinja2模板生成规范文档  
✅ **能力索引** - 快速查找特定能力的智能体  
✅ **易于扩展** - 添加新智能体只需配置，无需修改核心代码

这使得智能体系统更加模块化、可维护和可扩展。
